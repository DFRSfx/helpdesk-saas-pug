extends ../layout/layout

block content
  .flex.h-screen.bg-gray-50.dark_bg-neutral-900
    //- Sidebar with conversation list
    .w-80.bg-white.dark_bg-neutral-800.border-r.border-gray-200.dark_border-neutral-700.flex.flex-col

      //- Header
      .p-4.border-b.border-gray-200.dark_border-neutral-700
        .flex.items-center.justify-between.mb-4
          h1.text-xl.font-bold.text-gray-900.dark_text-white Chat
          button.p-2.text-gray-500.hover_bg-gray-100.dark_hover_bg-neutral-700.rounded-lg.transition-colors#newChatBtn(type="button" title="Start new chat")
            svg.w-5.h-5(fill="none" stroke="currentColor" viewBox="0 0 24 24")
              path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4")

        //- Search users input
        .relative
          input.w-full.px-4.py-2.bg-gray-100.dark_bg-neutral-700.text-gray-900.dark_text-white.placeholder-gray-500.rounded-lg.border.border-gray-200.dark_border-neutral-600.focus_outline-none.focus_ring-2.focus_ring-blue-500#userSearch(
            type="text"
            placeholder="Search conversations or users..."
            autocomplete="off"
          )
          svg(class="absolute right-3 top-2.5 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24")
            path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z")

      //- Conversation list
      .flex-1.overflow-y-auto#conversationList
        .space-y-1.p-2
          //- Empty state
          .text-center.py-8
            p.text-sm.text-gray-500.dark_text-neutral-400 No conversations yet. Start a new chat!

      //- Online users indicator (optional)
      .p-4.border-t.border-gray-200.dark_border-neutral-700.bg-gray-50.dark_bg-neutral-700/50
        p.text-xs.font-semibold.text-gray-700.dark_text-neutral-300.mb-2 Online Users
        .space-y-2#onlineUsersList
          p.text-xs.text-gray-500.dark_text-neutral-400 Loading...

    //- Main chat area
    .flex-1.flex.flex-col.bg-white.dark_bg-neutral-800

      //- Chat header
      .h-16.bg-gray-50.dark_bg-neutral-800.border-b.border-gray-200.dark_border-neutral-700.px-6.flex.items-center.justify-between#chatHeader
        .flex.items-center.gap-3
          img.w-10.h-10.rounded-full.bg-gray-300.dark_bg-neutral-600#participantAvatar(src="/images/default-avatar.png" alt="User")
          .flex-1
            h2.text-base.font-semibold.text-gray-900.dark_text-white#participantName Chat
            p.text-xs.text-gray-500.dark_text-neutral-400#participantStatus -
        .flex.items-center.gap-2
          button.p-2.text-gray-500.hover_bg-gray-100.dark_hover_bg-neutral-700.rounded-lg.transition-colors(type="button" title="Show info")
            svg.w-5.h-5(fill="none" stroke="currentColor" viewBox="0 0 24 24")
              path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z")

      //- Messages area
      .flex-1.overflow-y-auto.p-6#messagesContainer
        //- Messages load here
        .text-center.py-8
          p.text-sm.text-gray-500.dark_text-neutral-400 Select a conversation to start messaging

      //- Typing indicator
      .px-6.py-2.h-6#typingIndicator
        p.text-xs.text-gray-400.dark_text-neutral-500 &nbsp;

      //- Message input area
      .p-6.border-t.border-gray-200.dark_border-neutral-700.bg-gray-50.dark_bg-neutral-800
        .flex.gap-3
          //- Emoji picker button (optional)
          button.p-2.text-gray-500.hover_bg-gray-100.dark_hover_bg-neutral-700.rounded-lg.transition-colors(type="button" title="Emoji picker")
            svg.w-5.h-5(fill="none" stroke="currentColor" viewBox="0 0 24 24")
              path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z")

          //- Text input
          .flex-1.relative
            textarea.w-full.px-4.py-2.bg-white.dark_bg-neutral-700.text-gray-900.dark_text-white.placeholder-gray-500.border.border-gray-300.dark_border-neutral-600.rounded-lg.focus_outline-none.focus_ring-2.focus_ring-blue-500.resize-none(
              id="messageInput"
              placeholder="Type a message... (Shift+Enter for new line)"
              rows="1"
            )

          //- File upload button
          button.p-2.text-gray-500.hover_bg-gray-100.dark_hover_bg-neutral-700.rounded-lg.transition-colors(type="button" title="Attach file")
            svg.w-5.h-5(fill="none" stroke="currentColor" viewBox="0 0 24 24")
              path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8")
          input#fileInput(type="file" multiple hidden)

          //- Send button
          button.px-4.py-2.bg-blue-600.text-white.rounded-lg.hover_bg-blue-700.focus_outline-none.focus_ring-2.focus_ring-blue-500.font-medium.transition-colors#sendBtn(type="button")
            svg.w-5.h-5(fill="currentColor" viewBox="0 0 24 24")
              path(d="M16.6915026,12.4744748 L3.50612381,13.2599618 C3.19218622,13.2599618 3.03521743,13.4170592 3.03521743,13.5741566 L1.15159189,20.0151496 C0.8376543,20.8006365 0.99,21.89 1.77946707,22.52 C2.41,22.99 3.50612381,23.1 4.13399899,22.9429026 L21.714504,14.0454487 C22.6563168,13.5741566 23.1272231,12.6315722 22.9702544,11.6889879 L4.13399899,1.16346272 C3.34915502,0.9 2.40734225,1.00636533 1.77946707,1.4776575 C0.994623095,2.10604706 0.837654326,3.0486314 1.15159189,3.99701575 L3.03521743,10.4380088 C3.03521743,10.5951061 3.34915502,10.7522035 3.50612381,10.7522035 L16.6915026,11.5376904 C16.6915026,11.5376904 17.1624089,11.5376904 17.1624089,12.0089825 C17.1624089,12.4744748 16.6915026,12.4744748 16.6915026,12.4744748 Z")

  //- Hidden file input for chat
  input#chatFileInput(type="file" multiple hidden)

  //- New conversation modal
  .fixed.inset-0.bg-black.bg-opacity-50.hidden.flex.items-center.justify-center.z-50#newChatModal
    .bg-white.dark_bg-neutral-800.rounded-lg.shadow-lg.max-w-md.w-full.mx-4
      .p-6.border-b.border-gray-200.dark_border-neutral-700
        .flex.items-center.justify-between
          h3.text-lg.font-semibold.text-gray-900.dark_text-white Start new chat
          button.text-gray-400.hover_text-gray-600.dark_hover_text-neutral-300(type="button" onclick="document.getElementById('newChatModal').classList.add('hidden')")
            svg.w-6.h-6(fill="none" stroke="currentColor" viewBox="0 0 24 24")
              path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12")

      .p-6
        input.w-full.px-4.py-2.bg-gray-100.dark_bg-neutral-700.text-gray-900.dark_text-white.placeholder-gray-500.rounded-lg.border.border-gray-200.dark_border-neutral-600.focus_outline-none.focus_ring-2.focus_ring-blue-500.mb-4(
          id="newChatUserSearch"
          type="text"
          placeholder="Search user by name or email..."
          autocomplete="off"
        )
        #userSearchResults.max-h-60.overflow-y-auto.space-y-2

      .p-6.border-t.border-gray-200.dark_border-neutral-700.flex.gap-3
        button.flex-1.px-4.py-2.text-gray-700.dark_text-neutral-300.bg-gray-100.dark_bg-neutral-700.rounded-lg.hover_bg-gray-200.dark_hover_bg-neutral-600.font-medium.transition-colors(type="button" onclick="document.getElementById('newChatModal').classList.add('hidden')")
          | Cancel
        button.flex-1.px-4.py-2.bg-blue-600.text-white.rounded-lg.hover_bg-blue-700.focus_outline-none.focus_ring-2.focus_ring-blue-500.font-medium.transition-colors(type="button" id="startChatBtn" disabled)
          | Start Chat

  script.
    // Import socket from main.js
    if (typeof socket === 'undefined') {
      console.error('Socket not initialized. Make sure Socket.io is loaded in main.js');
    }

    // Chat state
    let currentConversationId = null;
    let selectedUserId = null;
    let messagesLoaded = false;

    // Load conversations
    async function loadConversations() {
      try {
        const response = await fetch('/chat/api/conversations', {
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });
        const conversations = await response.json();

        const list = document.getElementById('conversationList');
        if (conversations.length === 0) {
          list.innerHTML = '<div class="text-center py-8"><p class="text-sm text-gray-500">No conversations yet. Start a new chat!</p></div>';
          return;
        }

        list.innerHTML = conversations.map(conv => `
          <div class="conversation-item cursor-pointer p-3 hover_bg-gray-100 dark_hover_bg-neutral-700 rounded-lg transition-colors ${conv.id === currentConversationId ? 'bg-blue-50 dark_bg-blue-900/20 border-l-4 border-blue-600' : ''}" onclick="selectConversation(${conv.id})">
            <div class="flex items-center gap-3">
              <img src="/images/default-avatar.png" alt="${conv.creator_name}" class="w-10 h-10 rounded-full bg-gray-300">
              <div class="flex-1 min-w-0">
                <p class="text-sm font-medium text-gray-900 dark_text-white truncate">${conv.creator_name || 'Unknown'}</p>
                <p class="text-xs text-gray-500 dark_text-neutral-400 truncate">${conv.last_message || 'No messages yet'}</p>
              </div>
              ${conv.unread_count > 0 ? `<span class="inline-flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-red-600 rounded-full">${conv.unread_count}</span>` : ''}
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Error loading conversations:', error);
      }
    }

    // Select conversation
    async function selectConversation(conversationId) {
      currentConversationId = conversationId;
      await loadMessages();
      loadConversations(); // Refresh list to update selection highlight
    }

    // Load messages
    async function loadMessages() {
      if (!currentConversationId) return;

      try {
        const response = await fetch(`/chat/api/conversations/${currentConversationId}/messages`, {
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });
        const messages = await response.json();

        const container = document.getElementById('messagesContainer');
        if (messages.length === 0) {
          container.innerHTML = '<div class="text-center py-8"><p class="text-sm text-gray-500">No messages yet. Start the conversation!</p></div>';
          return;
        }

        container.innerHTML = messages.map(msg => `
          <div class="mb-4 flex ${msg.sender_id === parseInt(document.getElementById('currentUserId')?.value || '0') ? 'justify-end' : 'justify-start'}">
            <div class="max-w-xs ${msg.sender_id === parseInt(document.getElementById('currentUserId')?.value || '0') ? 'bg-blue-600 text-white' : 'bg-gray-200 dark_bg-neutral-700 text-gray-900 dark_text-white'} rounded-lg px-4 py-2">
              <p class="text-sm">${msg.message}</p>
              <p class="text-xs ${msg.sender_id === parseInt(document.getElementById('currentUserId')?.value || '0') ? 'text-blue-100' : 'text-gray-500 dark_text-neutral-400'} mt-1">${new Date(msg.created_at).toLocaleTimeString()}</p>
            </div>
          </div>
        `).join('');

        container.scrollTop = container.scrollHeight;
        messagesLoaded = true;

        // Mark as read
        await fetch(`/chat/api/conversations/${currentConversationId}/read`, {
          method: 'PATCH',
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });
      } catch (error) {
        console.error('Error loading messages:', error);
      }
    }

    // Send message
    document.getElementById('sendBtn')?.addEventListener('click', async () => {
      const input = document.getElementById('messageInput');
      const message = input.value.trim();

      if (!message || !currentConversationId) return;

      try {
        const response = await fetch(`/chat/api/conversations/${currentConversationId}/messages`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: JSON.stringify({ message })
        });

        if (response.ok) {
          input.value = '';
          await loadMessages();
          loadConversations();
        }
      } catch (error) {
        console.error('Error sending message:', error);
      }
    });

    // Auto-resize textarea
    const textarea = document.getElementById('messageInput');
    textarea?.addEventListener('input', () => {
      textarea.style.height = 'auto';
      textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
    });

    // Textarea enter to send
    textarea?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        document.getElementById('sendBtn')?.click();
      }
    });

    // New chat modal
    document.getElementById('newChatBtn')?.addEventListener('click', () => {
      document.getElementById('newChatModal').classList.remove('hidden');
      document.getElementById('newChatUserSearch').focus();
    });

    // Search users for new chat
    document.getElementById('newChatUserSearch')?.addEventListener('input', async (e) => {
      const query = e.target.value.trim();
      if (query.length < 2) {
        document.getElementById('userSearchResults').innerHTML = '';
        return;
      }

      try {
        const response = await fetch(`/chat/api/users/search?q=${encodeURIComponent(query)}`, {
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });
        const users = await response.json();

        const results = document.getElementById('userSearchResults');
        results.innerHTML = users.map(user => `
          <div class="p-3 hover_bg-gray-100 dark_hover_bg-neutral-700 rounded-lg cursor-pointer transition-colors" onclick="selectUserForChat(${user.id})">
            <p class="text-sm font-medium text-gray-900 dark_text-white">${user.name}</p>
            <p class="text-xs text-gray-500 dark_text-neutral-400">${user.email}</p>
          </div>
        `).join('');
      } catch (error) {
        console.error('Error searching users:', error);
      }
    });

    // Select user for new chat
    function selectUserForChat(userId) {
      selectedUserId = userId;
      document.getElementById('startChatBtn').disabled = false;
    }

    // Start chat
    document.getElementById('startChatBtn')?.addEventListener('click', async () => {
      if (!selectedUserId) return;

      try {
        const response = await fetch('/chat/api/conversations', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: JSON.stringify({ participant_id: selectedUserId })
        });

        const data = await response.json();
        if (data.conversation_id) {
          currentConversationId = data.conversation_id;
          selectedUserId = null;
          document.getElementById('newChatModal').classList.add('hidden');
          await loadConversations();
          await selectConversation(data.conversation_id);
        }
      } catch (error) {
        console.error('Error creating conversation:', error);
      }
    });

    // Initial load
    document.addEventListener('DOMContentLoaded', () => {
      loadConversations();
      setInterval(loadConversations, 30000); // Refresh every 30 seconds
    });

    // Socket.io events
    if (typeof socket !== 'undefined') {
      socket.on('chat:message', (data) => {
        if (data.conversation_id === currentConversationId) {
          loadMessages();
        }
        loadConversations();
      });

      socket.on('chat:typing', (data) => {
        if (data.conversation_id === currentConversationId) {
          document.getElementById('typingIndicator').innerHTML = `<p class="text-xs text-gray-400">${data.user_name} is typing...</p>`;
          setTimeout(() => {
            document.getElementById('typingIndicator').innerHTML = '<p class="text-xs text-gray-400">&nbsp;</p>';
          }, 3000);
        }
      });
    }
