doctype html
html(lang="pt-BR")
  head
    meta(charset="UTF-8")
    meta(name="viewport" content="width=device-width, initial-scale=1.0")
    title= title + " - Zolentra Chat"
    link(rel="stylesheet" href="/css/output.css")
    script(src="https://cdn.socket.io/4.5.4/socket.io.min.js")
    style.
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
      }

  body.bg-gradient-to-br.from-slate-900.via-slate-800.to-slate-900.text-gray-900.dark_text-white.h-screen.overflow-hidden.font-sans
    .flex.h-screen.flex-col
      //- Top Header
      .bg-white.dark_bg-slate-800.border-b.border-gray-200.dark_border-slate-700.px-6.py-3.shadow-sm
        .flex.items-center.justify-between
          .flex.items-center.gap-3
            img.h-8(src="/images/zolentra_logo-horizontal.png" alt="Zolentra")
            span.text-sm.font-medium.text-gray-600.dark_text-gray-400 Chat
          
          .flex.items-center.gap-4
            .text-sm
              span.text-gray-600.dark_text-gray-400 Welcome, 
              span.font-semibold.text-gray-900.dark_text-white= currentUser.name
            
            a.px-4.py-2.text-sm.font-medium.text-gray-700.dark_text-gray-300.hover_bg-gray-100.dark_hover_bg-slate-700.rounded-lg.transition-colors(href="/dashboard")
              | Back to Dashboard
            
            a.px-4.py-2.text-sm.font-medium.text-gray-700.dark_text-gray-300.hover_bg-gray-100.dark_hover_bg-slate-700.rounded-lg.transition-colors(href="/auth/logout")
              | Logout

      //- Main Chat Area
      .flex-1.flex.overflow-hidden.gap-4.p-4
        //- Conversations Sidebar
        .w-80.bg-white.dark_bg-slate-800.rounded-lg.shadow-lg.flex.flex-col.border.border-gray-200.dark_border-slate-700

          //- Sidebar Header
          .p-4.border-b.border-gray-200.dark_border-slate-700
            .flex.items-center.justify-between.mb-4
              h2.text-lg.font-bold.text-gray-900.dark_text-white Messages
              button.p-2.text-gray-500.hover_bg-gray-100.dark_hover_bg-slate-700.rounded-lg.transition-colors(type="button" title="New chat" id="newChatBtn")
                svg.w-5.h-5(fill="none" stroke="currentColor" viewBox="0 0 24 24")
                  path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4")

            //- Search
            .relative
              input.w-full.px-4.py-2.bg-gray-100.dark_bg-slate-700.text-gray-900.dark_text-white.placeholder-gray-500.dark_placeholder-gray-400.rounded-lg.border.border-gray-200.dark_border-slate-600.focus_outline-none.focus_ring-2.focus_ring-blue-500.text-sm#conversationSearch(
                type="text"
                placeholder="Search conversations..."
                autocomplete="off"
              )

          //- Conversations List
          .flex-1.overflow-y-auto#conversationList.space-y-2.p-3
            .text-center.py-12
              p.text-sm.text-gray-500.dark_text-gray-400 No conversations yet

          //- Online Users
          .p-4.border-t.border-gray-200.dark_border-slate-700.bg-gray-50.dark_bg-slate-700/50
            p.text-xs.font-semibold.text-gray-700.dark_text-gray-300.mb-3 Online Users
            .space-y-2#onlineUsersList
              p.text-xs.text-gray-500.dark_text-gray-400 Loading...

        //- Chat Area
        .flex-1.bg-white.dark_bg-slate-800.rounded-lg.shadow-lg.flex.flex-col.border.border-gray-200.dark_border-slate-700.overflow-hidden

          //- Chat Header
          .h-16.bg-gray-50.dark_bg-slate-700.border-b.border-gray-200.dark_border-slate-700.px-6.flex.items-center.justify-between#chatHeader
            .flex.items-center.gap-3
              .w-10.h-10.rounded-full.bg-gradient-to-br.from-blue-400.to-blue-600.flex.items-center.justify-center.text-white.font-bold#participantAvatar
                span= currentUser.name.charAt(0).toUpperCase()
              .flex-1
                h3.text-base.font-semibold.text-gray-900.dark_text-white#participantName Select a conversation
                p.text-xs.text-gray-500.dark_text-gray-400#participantStatus -
            
            .flex.items-center.gap-2
              button.p-2.text-gray-500.dark_text-gray-400.hover_bg-gray-100.dark_hover_bg-slate-600.rounded-lg.transition-colors(type="button" title="Info")
                svg.w-5.h-5(fill="none" stroke="currentColor" viewBox="0 0 24 24")
                  path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z")

          //- Messages
          .flex-1.overflow-y-auto.p-6.space-y-4#messagesContainer
            .text-center.py-16
              svg.w-16.h-16.mx-auto.text-gray-300.dark_text-gray-600.mb-4(fill="none" stroke="currentColor" viewBox="0 0 24 24")
                path(stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z")
              p.text-gray-500.dark_text-gray-400 Select a conversation to start chatting

          //- Typing Indicator
          .px-6.py-2.h-6#typingIndicator
            p.text-xs.text-gray-400.dark_text-gray-500 &nbsp;

          //- Message Input
          .bg-gray-50.dark_bg-slate-700.border-t.border-gray-200.dark_border-slate-700.p-6
            .flex.gap-3.items-end
              button.p-2.text-gray-500.dark_text-gray-400.hover_bg-gray-100.dark_hover_bg-slate-600.rounded-lg.transition-colors(type="button" title="Emoji")
                svg.w-5.h-5(fill="none" stroke="currentColor" viewBox="0 0 24 24")
                  path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z")

              .flex-1
                textarea.w-full.px-4.py-2.bg-white.dark_bg-slate-800.text-gray-900.dark_text-white.placeholder-gray-500.dark_placeholder-gray-400.rounded-lg.border.border-gray-300.dark_border-slate-600.focus_outline-none.focus_ring-2.focus_ring-blue-500.resize-none.text-sm(
                  id="messageInput"
                  placeholder="Type a message... (Shift+Enter for new line)"
                  rows="1"
                )

              button.px-4.py-2.bg-blue-600.text-white.rounded-lg.hover_bg-blue-700.focus_outline-none.focus_ring-2.focus_ring-blue-500.font-medium.transition-colors.text-sm#sendBtn(type="button")
                svg.w-5.h-5(fill="currentColor" viewBox="0 0 24 24")
                  path(d="M16.6915026,12.4744748 L3.50612381,13.2599618 C3.19218622,13.2599618 3.03521743,13.4170592 3.03521743,13.5741566 L1.15159189,20.0151496 C0.8376543,20.8006365 0.99,21.89 1.77946707,22.52 C2.41,22.99 3.50612381,23.1 4.13399899,22.9429026 L21.714504,14.0454487 C22.6563168,13.5741566 23.1272231,12.6315722 22.9702544,11.6889879 L4.13399899,1.16346272 C3.34915502,0.9 2.40734225,1.00636533 1.77946707,1.4776575 C0.994623095,2.10604706 0.837654326,3.0486314 1.15159189,3.99701575 L3.03521743,10.4380088 C3.03521743,10.5951061 3.34915502,10.7522035 3.50612381,10.7522035 L16.6915026,11.5376904 C16.6915026,11.5376904 17.1624089,11.5376904 17.1624089,12.0089825 C17.1624089,12.4744748 16.6915026,12.4744748 16.6915026,12.4744748 Z")

    //- New Chat Modal
    .fixed.inset-0.bg-black.bg-opacity-50.hidden.flex.items-center.justify-center.z-50#newChatModal
      .bg-white.dark_bg-slate-800.rounded-lg.shadow-xl.max-w-md.w-full.mx-4.border.border-gray-200.dark_border-slate-700
        .p-6.border-b.border-gray-200.dark_border-slate-700
          .flex.items-center.justify-between
            h3.text-lg.font-bold.text-gray-900.dark_text-white Start a New Chat
            button.text-gray-400.hover_text-gray-600.dark_hover_text-gray-300(type="button" onclick="document.getElementById('newChatModal').classList.add('hidden')")
              svg.w-6.h-6(fill="none" stroke="currentColor" viewBox="0 0 24 24")
                path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12")

        .p-6
          input.w-full.px-4.py-2.bg-gray-100.dark_bg-slate-700.text-gray-900.dark_text-white.placeholder-gray-500.dark_placeholder-gray-400.rounded-lg.border.border-gray-200.dark_border-slate-600.focus_outline-none.focus_ring-2.focus_ring-blue-500.mb-4.text-sm(
            id="newChatUserSearch"
            type="text"
            placeholder="Search user by name or email..."
            autocomplete="off"
          )
          #userSearchResults.max-h-60.overflow-y-auto.space-y-2

        .p-6.border-t.border-gray-200.dark_border-slate-700.flex.gap-3
          button.flex-1.px-4.py-2.text-gray-700.dark_text-gray-300.bg-gray-100.dark_bg-slate-700.rounded-lg.hover_bg-gray-200.dark_hover_bg-slate-600.font-medium.transition-colors.text-sm(type="button" onclick="document.getElementById('newChatModal').classList.add('hidden')")
            | Cancel
          button.flex-1.px-4.py-2.bg-blue-600.text-white.rounded-lg.hover_bg-blue-700.focus_outline-none.focus_ring-2.focus_ring-blue-500.font-medium.transition-colors.text-sm(type="button" id="startChatBtn" disabled)
            | Start Chat

    //- Hidden input for current user ID
    input#currentUserId(type="hidden" value=currentUserId)

    script.
      // Socket.io initialization
      const socket = io({
        reconnection: true,
        reconnectionDelay: 1000,
        reconnectionDelayMax: 5000,
        reconnectionAttempts: 5
      });

      // Chat state
      let currentConversationId = null;
      let selectedUserId = null;

      // Load conversations
      async function loadConversations() {
        try {
          const response = await fetch('/chat/api/conversations', {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
          });
          const data = await response.json();
          const conversations = data.conversations || [];

          const list = document.getElementById('conversationList');
          if (conversations.length === 0) {
            list.innerHTML = '<div class="text-center py-8"><p class="text-sm text-gray-500 dark_text-gray-400">No conversations yet</p></div>';
            return;
          }

          list.innerHTML = conversations.map(conv => `
            <button
              onclick="selectConversation(${conv.id})"
              class="w-full text-left p-3 hover_bg-gray-100 dark_hover_bg-slate-700 rounded-lg transition-colors ${conv.id === currentConversationId ? 'bg-blue-50 dark_bg-blue-900/30 border-l-4 border-blue-600' : 'border-l-4 border-transparent'}"
            >
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center text-white font-bold flex-shrink-0">
                  ${conv.creator_name?.charAt(0).toUpperCase() || 'U'}
                </div>
                <div class="flex-1 min-w-0">
                  <p class="text-sm font-medium text-gray-900 dark_text-white truncate">${conv.creator_name || 'Unknown'}</p>
                  <p class="text-xs text-gray-500 dark_text-gray-400 truncate">${conv.last_message || 'No messages'}</p>
                </div>
                ${conv.unread_count > 0 ? `<span class="inline-flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-red-600 rounded-full flex-shrink-0">${conv.unread_count}</span>` : ''}
              </div>
            </button>
          `).join('');
        } catch (error) {
          console.error('Error loading conversations:', error);
        }
      }

      // Select conversation
      async function selectConversation(conversationId) {
        currentConversationId = conversationId;
        await loadMessages();
        await loadConversations();
      }

      // Load messages
      async function loadMessages() {
        if (!currentConversationId) return;

        try {
          const response = await fetch(`/chat/api/conversations/${currentConversationId}/messages`, {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
          });
          const data = await response.json();
          const messages = data.messages || [];
          const conversation = data.conversation || {};

          // Update header
          document.getElementById('participantName').textContent = conversation.creator_name || 'Unknown';

          const container = document.getElementById('messagesContainer');
          if (messages.length === 0) {
            container.innerHTML = '<div class="text-center py-16"><p class="text-sm text-gray-500 dark_text-gray-400">No messages yet. Start the conversation!</p></div>';
            return;
          }

          const currentUserId = parseInt(document.getElementById('currentUserId').value);
          container.innerHTML = messages.map(msg => `
            <div class="flex ${msg.sender_id === currentUserId ? 'justify-end' : 'justify-start'}">
              <div class="max-w-xs ${msg.sender_id === currentUserId ? 'bg-blue-600 text-white' : 'bg-gray-200 dark_bg-slate-700 text-gray-900 dark_text-white'} rounded-lg px-4 py-2">
                <p class="text-sm break-words">${msg.message}</p>
                <p class="text-xs ${msg.sender_id === currentUserId ? 'text-blue-100' : 'text-gray-500 dark_text-gray-400'} mt-1">${new Date(msg.created_at).toLocaleTimeString('pt-BR')}</p>
              </div>
            </div>
          `).join('');

          container.scrollTop = container.scrollHeight;

          // Mark as read
          await fetch(`/chat/api/conversations/${currentConversationId}/read`, {
            method: 'PATCH',
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
          });
        } catch (error) {
          console.error('Error loading messages:', error);
        }
      }

      // Send message
      document.getElementById('sendBtn').addEventListener('click', async () => {
        const input = document.getElementById('messageInput');
        const message = input.value.trim();

        if (!message || !currentConversationId) return;

        try {
          const response = await fetch(`/chat/api/conversations/${currentConversationId}/messages`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ message })
          });

          if (response.ok) {
            input.value = '';
            input.style.height = 'auto';
            await loadMessages();
            loadConversations();
          }
        } catch (error) {
          console.error('Error sending message:', error);
        }
      });

      // Auto-resize textarea
      const textarea = document.getElementById('messageInput');
      textarea.addEventListener('input', () => {
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
      });

      // Enter to send
      textarea.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          document.getElementById('sendBtn').click();
        }
      });

      // New chat button
      document.getElementById('newChatBtn').addEventListener('click', () => {
        document.getElementById('newChatModal').classList.remove('hidden');
        document.getElementById('newChatUserSearch').focus();
      });

      // Search users
      document.getElementById('newChatUserSearch').addEventListener('input', async (e) => {
        const query = e.target.value.trim();
        if (query.length < 2) {
          document.getElementById('userSearchResults').innerHTML = '';
          return;
        }

        try {
          const response = await fetch(`/chat/api/users/search?q=${encodeURIComponent(query)}`, {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
          });
          const data = await response.json();
          const users = data.users || [];

          const results = document.getElementById('userSearchResults');
          results.innerHTML = users.map(user => `
            <button
              type="button"
              onclick="selectUserForChat(${user.id})"
              class="w-full text-left p-3 hover_bg-gray-100 dark_hover_bg-slate-700 rounded-lg transition-colors"
            >
              <p class="text-sm font-medium text-gray-900 dark_text-white">${user.name}</p>
              <p class="text-xs text-gray-500 dark_text-gray-400">${user.email}</p>
            </button>
          `).join('');
        } catch (error) {
          console.error('Error searching users:', error);
        }
      });

      // Select user
      function selectUserForChat(userId) {
        selectedUserId = userId;
        document.getElementById('startChatBtn').disabled = false;
      }

      // Start chat
      document.getElementById('startChatBtn').addEventListener('click', async () => {
        if (!selectedUserId) return;

        try {
          const response = await fetch('/chat/api/conversations', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ participant_id: selectedUserId })
          });

          const data = await response.json();
          if (data.conversation) {
            currentConversationId = data.conversation.id;
            selectedUserId = null;
            document.getElementById('newChatModal').classList.add('hidden');
            document.getElementById('newChatUserSearch').value = '';
            await loadConversations();
            await selectConversation(data.conversation.id);
          }
        } catch (error) {
          console.error('Error creating conversation:', error);
        }
      });

      // Initial load
      loadConversations();
      setInterval(loadConversations, 30000);

      // Socket events
      socket.on('chat:message', (data) => {
        if (data.conversation_id === currentConversationId) {
          loadMessages();
        }
        loadConversations();
      });

      socket.on('chat:typing', (data) => {
        if (data.conversation_id === currentConversationId) {
          document.getElementById('typingIndicator').innerHTML = `<p class="text-xs text-gray-400">${data.user_name} is typing...</p>`;
          setTimeout(() => {
            document.getElementById('typingIndicator').innerHTML = '<p class="text-xs text-gray-400">&nbsp;</p>';
          }, 3000);
        }
      });
