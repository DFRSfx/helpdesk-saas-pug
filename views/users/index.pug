extends ../layout/layout

block content
  //- Include reusable confirmation modal
  include ../partials/modal

  .max-w-7xl.mx-auto
    //- Header
    .bg-white.rounded-lg.shadow-sm.border.border-gray-200.p-6.mb-6
      h2.text-xl.font-bold.text-gray-900 User Management

      //- Search and filters
      form.mt-4(method="GET" action="/users")
        //- Search + Filters row (responsive grid)
        div(style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;")
          //- Search
          div
            label.block.text-xs.font-semibold.text-gray-600.mb-1 Search
            .relative
              svg.w-5.h-5.text-gray-400.pointer-events-none(
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%);"
              )
                path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z")
              input#searchInput.w-full.pl-10.pr-4.py-2.text-sm.border.border-gray-300.rounded-lg.focus_outline-none.focus_ring-2.focus_ring-blue-500.transition-all.duration-200(
                type="text"
                name="search"
                placeholder="Search by name or email..."
                value=search || ""
              )

          //- Role filter
          div
            label.block.text-xs.font-semibold.text-gray-600.mb-1 Role
            select.w-full.px-3.py-2.text-sm.border.border-gray-300.rounded-lg.focus_outline-none.focus_ring-2.focus_ring-blue-500.transition-all.duration-200.bg-white(
              name="role"
              onchange="this.form.submit()"
            )
              option(value="" selected=!role) All Roles
              option(value="customer" selected=role === "customer") Customer
              option(value="agent" selected=role === "agent") Agent
              option(value="admin" selected=role === "admin") Admin

          //- Status filter
          div
            label.block.text-xs.font-semibold.text-gray-600.mb-1 Status
            select.w-full.px-3.py-2.text-sm.border.border-gray-300.rounded-lg.focus_outline-none.focus_ring-2.focus_ring-blue-500.transition-all.duration-200.bg-white(
              name="status"
              onchange="this.form.submit()"
            )
              option(value="" selected=!status) All Status
              option(value="active" selected=status === "active") Active
              option(value="inactive" selected=status === "inactive") Inactive

        //- Actions row (Reset + Create)
        .flex.items-center.justify-between
          //- Reset link
          if search || role || status
            a.px-2.py-1.text-xs.text-blue-600.hover_text-blue-900.font-medium.transition-colors(href="/users" title="Reset filters") âœ• Reset
          else
            div

          //- Create User button (right-aligned)
          a.inline-flex.items-center.px-4.py-2.text-sm.bg-blue-600.text-white.rounded-lg.whitespace-nowrap(
            href="/users/create"
            style="transition: all 0.3s ease-in-out; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12);"
            onmouseover="this.style.boxShadow='0 10px 15px rgba(0, 0, 0, 0.2)'; this.style.transform='translateY(-2px)'; this.style.backgroundColor='#1e40af';"
            onmouseout="this.style.boxShadow='0 1px 3px rgba(0, 0, 0, 0.12)'; this.style.transform='translateY(0)'; this.style.backgroundColor='#2563eb';"
          )
            svg.w-4.h-4.mr-1(fill="none" stroke="currentColor" viewBox="0 0 24 24")
              path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4")
            | Create User

    //- Stats (informational cards)
    div(style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;" class="mb-6")
      .bg-white.rounded-lg.shadow-sm.border.border-gray-200.p-4
        .flex.items-center.justify-between
          div
            p.text-xs.text-gray-600.font-medium Total Users
            p.text-2xl.font-bold.text-gray-900= stats.total || 0
          .w-9.h-9.bg-blue-100.rounded-lg.flex.items-center.justify-center
            svg.w-5.h-5.text-blue-600(fill="none" stroke="currentColor" viewBox="0 0 24 24")
              path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z")

      .bg-white.rounded-lg.shadow-sm.border.border-gray-200.p-4
        .flex.items-center.justify-between
          div
            p.text-xs.text-gray-600.font-medium Customers
            p.text-2xl.font-bold.text-blue-600= stats.customers || 0
          .w-9.h-9.bg-blue-100.rounded-lg.flex.items-center.justify-center
            svg.w-5.h-5.text-blue-600(fill="none" stroke="currentColor" viewBox="0 0 24 24")
              path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z")

      .bg-white.rounded-lg.shadow-sm.border.border-gray-200.p-4
        .flex.items-center.justify-between
          div
            p.text-xs.text-gray-600.font-medium Agents
            p.text-2xl.font-bold.text-green-600= stats.agents || 0
          .w-9.h-9.bg-green-100.rounded-lg.flex.items-center.justify-center
            svg.w-5.h-5.text-green-600(fill="none" stroke="currentColor" viewBox="0 0 24 24")
              path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z")

      .bg-white.rounded-lg.shadow-sm.border.border-gray-200.p-4
        .flex.items-center.justify-between
          div
            p.text-xs.text-gray-600.font-medium Admins
            p.text-2xl.font-bold.text-purple-600= stats.admins || 0
          .w-9.h-9.bg-purple-100.rounded-lg.flex.items-center.justify-center
            svg.w-5.h-5.text-purple-600(fill="none" stroke="currentColor" viewBox="0 0 24 24")
              path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z")

    //- Users table
    .bg-white.rounded-lg.shadow-sm.border.border-gray-200.overflow-hidden
      if users && users.length > 0
        .overflow-x-auto
          table.min-w-full.divide-y.divide-gray-200
            thead.bg-gray-100.border-b.border-gray-300
              tr
                th.px-6.py-2.text-left.text-xs.font-semibold.text-gray-700 User
                th.px-6.py-2.text-left.text-xs.font-semibold.text-gray-700 Role
                th.px-6.py-2.text-left.text-xs.font-semibold.text-gray-700 Status
                th.px-6.py-2.text-left.text-xs.font-semibold.text-gray-700 Tickets
                th.px-6.py-2.text-left.text-xs.font-semibold.text-gray-700 Joined
                th.px-6.py-2.text-left.text-xs.font-semibold.text-gray-700 Actions

            tbody.divide-y.divide-gray-200
              each user in users
                tr.hover_bg-gray-50.transition-colors
                  //- User (Name + Email)
                  td.px-6.py-3.whitespace-nowrap
                    .flex.items-center.gap-2
                      .w-8.h-8.rounded-full.bg-blue-600.text-white.flex.items-center.justify-center.font-medium.text-xs
                        = user.name.charAt(0).toUpperCase()
                      div.min-w-0
                        .text-sm.font-medium.text-gray-900= user.name
                        .text-xs.text-gray-500.truncate= user.email

                  //- Role
                  td.px-6.py-3.whitespace-nowrap
                    - const roleColors = { customer: 'bg-blue-100 text-blue-700', agent: 'bg-green-100 text-green-700', admin: 'bg-purple-100 text-purple-700' }
                    span.px-2.py-0_5.text-xs.font-medium.rounded(class=roleColors[user.role])
                      = user.role.charAt(0).toUpperCase() + user.role.slice(1)

                  //- Status (dot + text)
                  td.px-6.py-3.whitespace-nowrap
                    .flex.items-center.gap-2
                      span(class=user.is_active ? 'w-2 h-2 bg-green-500 rounded-full' : 'w-2 h-2 bg-red-500 rounded-full')
                      span.text-sm(class=user.is_active ? 'text-gray-900 font-medium' : 'text-gray-500')
                        = user.is_active ? 'Active' : 'Inactive'

                  //- Tickets/Activity
                  td.px-6.py-3.whitespace-nowrap.text-sm
                    if user.role === 'customer'
                      .text-gray-900.font-medium= user.ticket_count || 0
                    else if user.role === 'agent'
                      .text-gray-900
                        .font-medium= (user.assigned_count || 0) + ' assigned'
                        if user.resolved_count
                          .text-xs.text-green-600= user.resolved_count + ' resolved'
                    else
                      .text-gray-400 -

                  //- Joined
                  td.px-6.py-3.whitespace-nowrap
                    .text-sm.text-gray-600= formatDate(user.created_at)

                  //- Actions
                  td.px-6.py-3.whitespace-nowrap.text-right
                    .flex.items-center.justify-end.gap-3
                      a.text-blue-600.hover_text-blue-900.transition-colors(href=`/users/${user.id}/edit` title="Edit user")
                        svg.w-4.h-4(fill="none" stroke="currentColor" viewBox="0 0 24 24")
                          path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z")

                      if user.is_active
                        button.text-red-600.hover_text-red-700.hover_bg-red-50.px-2.py-1.rounded.transition-all.duration-200(
                          onclick=`showDeactivateModal(${user.id})`
                          title="Deactivate user"
                          type="button"
                        )
                          svg.w-4.h-4(fill="none" stroke="currentColor" viewBox="0 0 24 24")
                            path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636l-3.536 3.536m0 5.656l3.536 3.536M9.172 9.172L5.636 5.636m3.536 9.172l-3.536 3.536M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-5 0a4 4 0 11-8 0 4 4 0 018 0z")
                      else
                        button.text-green-600.hover_text-green-700.hover_bg-green-50.px-2.py-1.rounded.transition-all.duration-200(
                          onclick=`showActivateModal(${user.id})`
                          title="Activate user"
                          type="button"
                        )
                          svg.w-4.h-4(fill="none" stroke="currentColor" viewBox="0 0 24 24")
                            path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m7 0a9 9 0 11-18 0 9 9 0 0118 0z")
      else
        .p-8.text-center
          svg.mx-auto.h-12.w-12.text-gray-400(fill="none" stroke="currentColor" viewBox="0 0 24 24")
            path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z")
          p.mt-2.text-sm.text-gray-500 No users found
          a.mt-4.inline-flex.items-center.px-4.py-2.bg-blue-600.text-white.rounded-lg.hover_bg-blue-700.transition-colors(href="/users/create")
            | Create User

    //- Pagination
    if pagination && pagination.totalPages > 1
      .mt-6.flex.items-center.justify-between.bg-white.px-6.py-3.rounded-lg.shadow-sm.border.border-gray-200
        .flex.items-center
          p.text-sm.text-gray-700
            | Showing
            span.font-medium= ' ' + pagination.startItem + ' '
            | to
            span.font-medium= ' ' + pagination.endItem + ' '
            | of
            span.font-medium= ' ' + pagination.totalItems + ' '
            | results

        .flex.items-center.space-x-2
          if pagination.currentPage > 1
            a.px-3.py-2.text-sm.font-medium.text-gray-700.bg-white.border.border-gray-300.rounded-lg.hover_bg-gray-50(
              href=`?page=${pagination.currentPage - 1}${search ? '&search=' + search : ''}${role ? '&role=' + role : ''}${status ? '&status=' + status : ''}`
            ) Previous
          else
            span.px-3.py-2.text-sm.font-medium.text-gray-400.bg-gray-100.border.border-gray-300.rounded-lg.cursor-not-allowed Previous

          - for (let i = 1; i <= pagination.totalPages; i++)
            if i === pagination.currentPage
              span.px-3.py-2.text-sm.font-medium.text-white.bg-blue-600.border.border-blue-600.rounded-lg= i
            else
              a.px-3.py-2.text-sm.font-medium.text-gray-700.bg-white.border.border-gray-300.rounded-lg.hover_bg-gray-50(
                href=`?page=${i}${search ? '&search=' + search : ''}${role ? '&role=' + role : ''}${status ? '&status=' + status : ''}`
              )= i

          if pagination.currentPage < pagination.totalPages
            a.px-3.py-2.text-sm.font-medium.text-gray-700.bg-white.border.border-gray-300.rounded-lg.hover_bg-gray-50(
              href=`?page=${pagination.currentPage + 1}${search ? '&search=' + search : ''}${role ? '&role=' + role : ''}${status ? '&status=' + status : ''}`
            ) Next
          else
            span.px-3.py-2.text-sm.font-medium.text-gray-400.bg-gray-100.border.border-gray-300.rounded-lg.cursor-not-allowed Next

block scripts
  script.
    function showDeactivateModal(userId) {
      openModal(
        'Deactivate User',
        'This user will not be able to login. Are you sure?',
        'Deactivate',
        () => updateUserStatus(userId, false)
      );
    }

    function showActivateModal(userId) {
      openModal(
        'Activate User',
        'This user will be able to login again. Are you sure?',
        'Activate',
        () => updateUserStatus(userId, true)
      );
    }

    function updateUserStatus(userId, activate) {
      const action = activate ? 'activate' : 'deactivate';

      fetch(`/users/${userId}/status`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ is_active: activate })
      })
      .then(response => {
        if (response.ok) {
          window.location.reload();
        } else {
          alert(`Failed to ${action} user`);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('An error occurred');
      });
    }

    // Real-time filter functionality
    let filterTimeout;
    const searchInput = document.getElementById('searchInput');
    const roleSelect = document.querySelector('select[name="role"]');
    const statusSelect = document.querySelector('select[name="status"]');

    function fetchAndFilterUsers() {
      const search = searchInput.value;
      const role = roleSelect.value;
      const status = statusSelect.value;

      const params = new URLSearchParams();
      if (search) params.append('search', search);
      if (role) params.append('role', role);
      if (status) params.append('status', status);

      fetch(`/api/users?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            updateUserTable(data.data.users, data.data.stats, data.data.pagination);
          }
        })
        .catch(error => console.error('Error fetching users:', error));
    }

    function updateUserTable(users, stats, pagination) {
      const tbody = document.querySelector('table tbody');
      const noUsersMsg = document.querySelector('.text-center svg')?.parentElement;

      if (users.length === 0) {
        tbody.innerHTML = '';
        return;
      }

      // Build table rows HTML
      let html = '';
      users.forEach(user => {
        const roleColors = {
          customer: 'bg-blue-100 text-blue-700',
          agent: 'bg-green-100 text-green-700',
          admin: 'bg-purple-100 text-purple-700'
        };
        const roleColor = roleColors[user.role] || 'bg-gray-100 text-gray-700';
        const statusColor = user.is_active ? 'w-2 h-2 bg-green-500 rounded-full' : 'w-2 h-2 bg-red-500 rounded-full';
        const statusText = user.is_active ? 'Active' : 'Inactive';
        const statusTextColor = user.is_active ? 'text-gray-900 font-medium' : 'text-gray-500';

        html += `
          <tr class="hover:bg-gray-50 transition-colors">
            <td class="px-6 py-3 whitespace-nowrap">
              <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center font-medium text-xs">
                  ${user.name.charAt(0).toUpperCase()}
                </div>
                <div class="min-w-0">
                  <div class="text-sm font-medium text-gray-900">${user.name}</div>
                  <div class="text-xs text-gray-500 truncate">${user.email}</div>
                </div>
              </div>
            </td>
            <td class="px-6 py-3 whitespace-nowrap">
              <span class="px-2 py-0_5 text-xs font-medium rounded ${roleColor}">
                ${user.role.charAt(0).toUpperCase() + user.role.slice(1)}
              </span>
            </td>
            <td class="px-6 py-3 whitespace-nowrap">
              <div class="flex items-center gap-2">
                <span class="${statusColor}"></span>
                <span class="text-sm ${statusTextColor}">${statusText}</span>
              </div>
            </td>
            <td class="px-6 py-3 whitespace-nowrap text-sm">-</td>
            <td class="px-6 py-3 whitespace-nowrap">
              <div class="text-sm text-gray-600">${new Date(user.created_at).toLocaleDateString()}</div>
            </td>
            <td class="px-6 py-3 whitespace-nowrap text-right">
              <div class="flex items-center justify-end gap-3">
                <a class="text-blue-600 hover:text-blue-900 transition-colors" href="/users/${user.id}/edit" title="Edit user">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                  </svg>
                </a>
                ${user.is_active ?
                  `<button class="text-red-600 hover:text-red-700 hover:bg-red-50 px-2 py-1 rounded transition-all duration-200" onclick="showDeactivateModal(${user.id})" title="Deactivate user" type="button">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636l-3.536 3.536m0 5.656l3.536 3.536M9.172 9.172L5.636 5.636m3.536 9.172l-3.536 3.536M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-5 0a4 4 0 11-8 0 4 4 0 018 0z"></path>
                    </svg>
                  </button>`
                  :
                  `<button class="text-green-600 hover:text-green-700 hover:bg-green-50 px-2 py-1 rounded transition-all duration-200" onclick="showActivateModal(${user.id})" title="Activate user" type="button">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m7 0a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                  </button>`
                }
              </div>
            </td>
          </tr>
        `;
      });

      tbody.innerHTML = html;

      // Update stats
      document.querySelectorAll('[style*="grid-template-columns"]').forEach(statsContainer => {
        const children = statsContainer.children;
        if (children.length >= 4) {
          // Update stats cards
          const totalCard = children[0];
          const customersCard = children[1];
          const agentsCard = children[2];
          const adminsCard = children[3];

          totalCard.querySelector('.text-2xl').textContent = stats.total || 0;
          customersCard.querySelector('.text-2xl').textContent = stats.customers || 0;
          agentsCard.querySelector('.text-2xl').textContent = stats.agents || 0;
          adminsCard.querySelector('.text-2xl').textContent = stats.admins || 0;
        }
      });
    }

    // Auto-search as user types (with debounce)
    if (searchInput) {
      searchInput.addEventListener('input', () => {
        clearTimeout(filterTimeout);
        filterTimeout = setTimeout(fetchAndFilterUsers, 300);
      });
    }

    // Filter on role select change
    if (roleSelect) {
      roleSelect.addEventListener('change', fetchAndFilterUsers);
    }

    // Filter on status select change
    if (statusSelect) {
      statusSelect.addEventListener('change', fetchAndFilterUsers);
    }
