extends ../layout/layout

block content
  .max-w-7xl.mx-auto
    //- Header
    .bg-white.rounded-lg.shadow-sm.border.border-gray-200.p-6.mb-6
      .flex.flex-col.md_flex-row.md_items-center.md_justify-between.gap-4
        h2.text-xl.font-bold.text-gray-900 User Management

        a.inline-flex.items-center.px-4.py-2.bg-blue-600.text-white.rounded-lg.hover_bg-blue-700.transition-colors(href="/users/create")
          svg.w-5.h-5.mr-2(fill="none" stroke="currentColor" viewBox="0 0 24 24")
            path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4")
          | Create User

      //- Search and filters
      form.mt-4(method="GET" action="/users")
        .grid.grid-cols-1.md_grid-cols-4.gap-4
          //- Search
          .md_col-span-2
            .relative
              svg.absolute.left-3.top-1_2.transform.-translate-y-1_2.w-5.h-5.text-gray-400(fill="none" stroke="currentColor" viewBox="0 0 24 24")
                path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z")
              input.w-full.pl-10.pr-4.py-2.border.border-gray-300.rounded-lg.focus_outline-none.focus_ring-2.focus_ring-blue-500(
                type="text"
                name="search"
                placeholder="Search by name or email..."
                value=search || ""
              )

          //- Role filter
          select.px-4.py-2.border.border-gray-300.rounded-lg.focus_outline-none.focus_ring-2.focus_ring-blue-500(name="role")
            option(value="" selected=!role) All Roles
            option(value="customer" selected=role === "customer") Customer
            option(value="agent" selected=role === "agent") Agent
            option(value="admin" selected=role === "admin") Admin

          //- Status filter
          select.px-4.py-2.border.border-gray-300.rounded-lg.focus_outline-none.focus_ring-2.focus_ring-blue-500(name="status")
            option(value="" selected=!status) All Status
            option(value="active" selected=status === "active") Active
            option(value="inactive" selected=status === "inactive") Inactive

    //- Stats
    .grid.grid-cols-1.md_grid-cols-4.gap-6.mb-6
      .bg-white.rounded-lg.shadow-sm.border.border-gray-200.p-6
        .flex.items-center.justify-between
          div
            p.text-sm.text-gray-600 Total Users
            p.text-2xl.font-bold.text-gray-900= stats.total || 0
          .w-10.h-10.bg-blue-100.rounded-lg.flex.items-center.justify-center
            svg.w-6.h-6.text-blue-600(fill="none" stroke="currentColor" viewBox="0 0 24 24")
              path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z")

      .bg-white.rounded-lg.shadow-sm.border.border-gray-200.p-6
        .flex.items-center.justify-between
          div
            p.text-sm.text-gray-600 Customers
            p.text-2xl.font-bold.text-blue-600= stats.customers || 0
          .w-10.h-10.bg-blue-100.rounded-lg.flex.items-center.justify-center
            svg.w-6.h-6.text-blue-600(fill="none" stroke="currentColor" viewBox="0 0 24 24")
              path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z")

      .bg-white.rounded-lg.shadow-sm.border.border-gray-200.p-6
        .flex.items-center.justify-between
          div
            p.text-sm.text-gray-600 Agents
            p.text-2xl.font-bold.text-green-600= stats.agents || 0
          .w-10.h-10.bg-green-100.rounded-lg.flex.items-center.justify-center
            svg.w-6.h-6.text-green-600(fill="none" stroke="currentColor" viewBox="0 0 24 24")
              path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z")

      .bg-white.rounded-lg.shadow-sm.border.border-gray-200.p-6
        .flex.items-center.justify-between
          div
            p.text-sm.text-gray-600 Admins
            p.text-2xl.font-bold.text-purple-600= stats.admins || 0
          .w-10.h-10.bg-purple-100.rounded-lg.flex.items-center.justify-center
            svg.w-6.h-6.text-purple-600(fill="none" stroke="currentColor" viewBox="0 0 24 24")
              path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z")

    //- Users table
    .bg-white.rounded-lg.shadow-sm.border.border-gray-200.overflow-hidden
      if users && users.length > 0
        .overflow-x-auto
          table.min-w-full.divide-y.divide-gray-200
            thead.bg-gray-50
              tr
                th.px-6.py-3.text-left.text-xs.font-medium.text-gray-500.uppercase.tracking-wider ID
                th.px-6.py-3.text-left.text-xs.font-medium.text-gray-500.uppercase.tracking-wider User
                th.px-6.py-3.text-left.text-xs.font-medium.text-gray-500.uppercase.tracking-wider Role
                th.px-6.py-3.text-left.text-xs.font-medium.text-gray-500.uppercase.tracking-wider Status
                th.px-6.py-3.text-left.text-xs.font-medium.text-gray-500.uppercase.tracking-wider Department
                th.px-6.py-3.text-left.text-xs.font-medium.text-gray-500.uppercase.tracking-wider Tickets
                th.px-6.py-3.text-left.text-xs.font-medium.text-gray-500.uppercase.tracking-wider Joined
                th.px-6.py-3.text-left.text-xs.font-medium.text-gray-500.uppercase.tracking-wider Actions

            tbody.bg-white.divide-y.divide-gray-200
              each user in users
                tr.hover_bg-gray-50.transition-colors
                  td.px-6.py-4.whitespace-nowrap
                    .text-sm.font-medium.text-gray-900= user.id

                  td.px-6.py-4.whitespace-nowrap
                    .flex.items-center
                      .w-10.h-10.rounded-full.bg-blue-600.text-white.flex.items-center.justify-center.font-semibold.mr-3
                        = user.name.charAt(0).toUpperCase()
                      div
                        .text-sm.font-medium.text-gray-900= user.name
                        .text-sm.text-gray-500= user.email

                  td.px-6.py-4.whitespace-nowrap
                    - const roleColors = { customer: 'bg-blue-100 text-blue-800', agent: 'bg-green-100 text-green-800', admin: 'bg-purple-100 text-purple-800' }
                    span.px-2.py-1.text-xs.font-semibold.rounded-full(class=roleColors[user.role])
                      = user.role.toUpperCase()

                  td.px-6.py-4.whitespace-nowrap
                    if user.is_active
                      span.px-2.py-1.text-xs.font-semibold.rounded-full.bg-green-100.text-green-800 Active
                    else
                      span.px-2.py-1.text-xs.font-semibold.rounded-full.bg-red-100.text-red-800 Inactive

                  td.px-6.py-4.whitespace-nowrap
                    .text-sm.text-gray-900= user.department_name || 'N/A'

                  td.px-6.py-4.whitespace-nowrap
                    if user.role === 'customer'
                      .text-sm.text-gray-900= user.ticket_count || 0
                    else if user.role === 'agent'
                      .text-sm.text-gray-900
                        = (user.assigned_count || 0) + ' assigned'
                        if user.resolved_count
                          br
                          .text-xs.text-green-600= user.resolved_count + ' resolved'
                    else
                      .text-sm.text-gray-500 -

                  td.px-6.py-4.whitespace-nowrap
                    .text-sm.text-gray-500= formatDate(user.created_at)

                  td.px-6.py-4.whitespace-nowrap.text-sm.font-medium
                    .flex.items-center.space-x-2
                      a.text-blue-600.hover_text-blue-900(href=`/users/${user.id}/edit` title="Edit")
                        svg.w-5.h-5(fill="none" stroke="currentColor" viewBox="0 0 24 24")
                          path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z")

                      if user.is_active
                        button.text-red-600.hover_text-red-900(
                          onclick=`toggleUserStatus(${user.id}, false)`
                          title="Deactivate"
                        )
                          svg.w-5.h-5(fill="none" stroke="currentColor" viewBox="0 0 24 24")
                            path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636")
                      else
                        button.text-green-600.hover_text-green-900(
                          onclick=`toggleUserStatus(${user.id}, true)`
                          title="Activate"
                        )
                          svg.w-5.h-5(fill="none" stroke="currentColor" viewBox="0 0 24 24")
                            path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z")
      else
        .p-8.text-center
          svg.mx-auto.h-12.w-12.text-gray-400(fill="none" stroke="currentColor" viewBox="0 0 24 24")
            path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z")
          p.mt-2.text-sm.text-gray-500 No users found
          a.mt-4.inline-flex.items-center.px-4.py-2.bg-blue-600.text-white.rounded-lg.hover_bg-blue-700.transition-colors(href="/users/create")
            | Create User

    //- Pagination
    if pagination && pagination.totalPages > 1
      .mt-6.flex.items-center.justify-between.bg-white.px-6.py-3.rounded-lg.shadow-sm.border.border-gray-200
        .flex.items-center
          p.text-sm.text-gray-700
            | Showing
            span.font-medium= ' ' + pagination.startItem + ' '
            | to
            span.font-medium= ' ' + pagination.endItem + ' '
            | of
            span.font-medium= ' ' + pagination.totalItems + ' '
            | results

        .flex.items-center.space-x-2
          if pagination.currentPage > 1
            a.px-3.py-2.text-sm.font-medium.text-gray-700.bg-white.border.border-gray-300.rounded-lg.hover_bg-gray-50(
              href=`?page=${pagination.currentPage - 1}${search ? '&search=' + search : ''}${role ? '&role=' + role : ''}${status ? '&status=' + status : ''}`
            ) Previous
          else
            span.px-3.py-2.text-sm.font-medium.text-gray-400.bg-gray-100.border.border-gray-300.rounded-lg.cursor-not-allowed Previous

          - for (let i = 1; i <= pagination.totalPages; i++)
            if i === pagination.currentPage
              span.px-3.py-2.text-sm.font-medium.text-white.bg-blue-600.border.border-blue-600.rounded-lg= i
            else
              a.px-3.py-2.text-sm.font-medium.text-gray-700.bg-white.border.border-gray-300.rounded-lg.hover_bg-gray-50(
                href=`?page=${i}${search ? '&search=' + search : ''}${role ? '&role=' + role : ''}${status ? '&status=' + status : ''}`
              )= i

          if pagination.currentPage < pagination.totalPages
            a.px-3.py-2.text-sm.font-medium.text-gray-700.bg-white.border.border-gray-300.rounded-lg.hover_bg-gray-50(
              href=`?page=${pagination.currentPage + 1}${search ? '&search=' + search : ''}${role ? '&role=' + role : ''}${status ? '&status=' + status : ''}`
            ) Next
          else
            span.px-3.py-2.text-sm.font-medium.text-gray-400.bg-gray-100.border.border-gray-300.rounded-lg.cursor-not-allowed Next

block scripts
  script.
    function toggleUserStatus(userId, activate) {
      const action = activate ? 'activate' : 'deactivate';
      if (!confirm(`Are you sure you want to ${action} this user?`)) {
        return;
      }

      fetch(`/users/${userId}/status`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ is_active: activate })
      })
      .then(response => {
        if (response.ok) {
          window.location.reload();
        } else {
          alert(`Failed to ${action} user`);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('An error occurred');
      });
    }
