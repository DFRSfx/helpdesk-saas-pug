extends ../layout/layout

block content
  .max-w-7xl.mx-auto
    .space-y-5
      //- User Profile Header Card
      .bg-white.rounded-lg.shadow-sm.border.border-gray-200.overflow-hidden.dark_bg-neutral-800.dark_border-neutral-700
        //- SVG Background Element
        figure.relative.h-40
          svg.w-full.h-full(preserveAspectRatio="none" viewBox="0 0 1113 161" fill="none" xmlns="http://www.w3.org/2000/svg")
            g(clip-path="url(#clip0)")
              rect(x="1" width="1112" height="348" fill="#B2E7FE")
              rect(width="185.209" height="704.432" transform="matrix(0.50392 0.86375 -0.860909 0.508759 435.452 -177.87)" fill="#FF8F5D")
              rect(width="184.653" height="378.667" transform="matrix(0.849839 -0.527043 0.522157 0.852849 -10.4556 -16.4521)" fill="#3ECEED")
              rect(width="184.653" height="189.175" transform="matrix(0.849839 -0.527043 0.522157 0.852849 35.4456 58.5195)" fill="#4C48FF")
            defs
              clipPath#clip0
                rect(x="0.5" width="1112" height="161" rx="12" fill="white")

        //- Avatar Section
        div(class="relative -mt-24 px-6")
          div(class="flex flex-col md:flex-row md:items-end gap-4")
            //- Avatar with image support
            .relative.w-32.h-32.mx-auto.md_mx-0
              if currentUser.profile_image
                img(
                  class="w-32 h-32 rounded-full border-4 border-white dark:border-neutral-800 object-cover shadow-lg"
                  src=currentUser.profile_image
                  alt=currentUser.name
                )
              else
                div(class="w-32 h-32 rounded-full border-4 border-white dark:border-neutral-800 bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center text-white font-bold text-4xl shadow-lg")
                  = currentUser.name.charAt(0).toUpperCase()

            //- User Info
            .flex-1.text-center.md_text-left.pb-4
              h1.text-2xl.font-bold.text-gray-900.dark_text-neutral-200= currentUser.name
              p.text-gray-600.dark_text-neutral-400.mt-1= currentUser.email

              //- Role Badge
              .mt-2
                if currentUser.role === 'customer'
                  span(class="inline-flex items-center gap-x-1.5 px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-400")
                    span(class="w-1.5 h-1.5 rounded-full bg-current")
                    | Customer
                else if currentUser.role === 'agent'
                  span(class="inline-flex items-center gap-x-1.5 px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-400")
                    span(class="w-1.5 h-1.5 rounded-full bg-current")
                    | Agent
                else if currentUser.role === 'admin'
                  span(class="inline-flex items-center gap-x-1.5 px-3 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-400")
                    span(class="w-1.5 h-1.5 rounded-full bg-current")
                    | Admin

            //- Stats (if available)
            if stats
              .hidden.md_flex.gap-6.pb-4.border-l.border-gray-200.pl-6.dark_border-neutral-700
                .text-center
                  .text-2xl.font-bold.text-gray-900.dark_text-neutral-200= stats.totalTickets || 0
                  .text-sm.text-gray-600.dark_text-neutral-400 Total Tickets
                if currentUser.role === 'agent' || currentUser.role === 'admin'
                  .text-center
                    .text-2xl.font-bold.text-green-600.dark_text-green-400= stats.resolvedTickets || 0
                    .text-sm.text-gray-600.dark_text-neutral-400 Resolved
                  .text-center
                    .text-2xl.font-bold.text-blue-600.dark_text-blue-400= stats.openTickets || 0
                    .text-sm.text-gray-600.dark_text-neutral-400 Open

        //- Tab Navigation
        .px-6.pb-8
            nav.flex.gap-x-2.relative(role="tablist")
              button#tab-profile(
                class="relative inline-flex items-center gap-2 px-4 py-3 text-sm font-medium text-gray-800 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-all focus:outline-none dark:text-neutral-200 dark:hover:text-neutral-300 dark:hover:bg-neutral-700 active"
                type="button"
                role="tab"
                aria-selected="true"
                aria-controls="profile-content"
                onclick="switchTab('profile')"
              )
                svg(class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24")
                  circle(cx="18" cy="15" r="3")
                  circle(cx="9" cy="7" r="4")
                  path(d="M10 15H6a4 4 0 0 0-4 4v2")
                  path(d="m21.7 16.4-.9-.3 m-6.5-2.5-.9-.3 m1.4 4.8.3-.9 m2.5-6.5.3-.9 m.5 6.5-.4-1 m-3.3-6.4-.4-1 m-1.7 4.3 1-.4 m6.4-2.8 1-.4")
                span My Profile
                div(class="absolute -bottom-px left-0 right-0 h-0.5 bg-blue-600 dark:bg-blue-500 transition-all")

              button#tab-activity(
                class="relative inline-flex items-center gap-2 px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-all focus:outline-none dark:text-neutral-400 dark:hover:text-neutral-200 dark:hover:bg-neutral-700"
                type="button"
                role="tab"
                aria-selected="false"
                aria-controls="activity-content"
                onclick="switchTab('activity')"
              )
                svg(class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24")
                  path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z")
                span Recent Activity

              button#tab-settings(
                class="relative inline-flex items-center gap-2 px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-all focus:outline-none dark:text-neutral-400 dark:hover:text-neutral-200 dark:hover:bg-neutral-700"
                type="button"
                role="tab"
                aria-selected="false"
                aria-controls="settings-content"
                onclick="switchTab('settings')"
              )
                svg(class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24")
                  path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z")
                  path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z")
                span Settings

      //- Tab Content
      div(class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6")

        //- Sidebar (Profile Info)
        #profile-sidebar.lg_col-span-1.space-y-5
          //- About Card
          .bg-white.rounded-lg.shadow-sm.border.border-gray-200.p-6.dark_bg-neutral-800.dark_border-neutral-700
            h2.text-sm.font-semibold.text-gray-900.mb-4.dark_text-neutral-200 About

            ul.space-y-3
              if isAgent() && currentUser.departments && currentUser.departments.length > 0
                li
                  .flex.flex-col.gap-2
                    .inline-flex.items-center.gap-x-3.text-sm.text-gray-800.dark_text-neutral-200
                      svg.w-5.h-5.text-gray-400.dark_text-neutral-500(fill="none" stroke="currentColor" viewBox="0 0 24 24")
                        path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z")
                        span Departments
                        .flex.flex-wrap.gap-2.ml-8
                          each dept in currentUser.departments
                            span.inline-flex.items-center.px-3.py-1.rounded-full.text-xs.font-medium.bg-blue-100.text-blue-800.dark_bg-blue-900.dark_text-blue-400
                              = dept.name

              //- Show single department for customers/admins
              else if currentUser.department_name
                li
                  .inline-flex.items-center.gap-x-3.text-sm.text-gray-800.dark_text-neutral-200
                    svg.w-5.h-5.text-gray-400.dark_text-neutral-500(fill="none" stroke="currentColor" viewBox="0 0 24 24")
                      path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4")
                      = currentUser.department_name

              li
                .inline-flex.items-center.gap-x-3.text-sm.text-gray-800.dark_text-neutral-200
                  svg.w-5.h-5.text-gray-400.dark_text-neutral-500(fill="none" stroke="currentColor" viewBox="0 0 24 24")
                    rect(width="20" height="16" x="2" y="4" rx="2")
                    path(d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7")
                  = currentUser.email

              li
                .inline-flex.items-center.gap-x-3.text-sm.text-gray-800.dark_text-neutral-200
                  svg.w-5.h-5.text-gray-400.dark_text-neutral-500(fill="none" stroke="currentColor" viewBox="0 0 24 24")
                    circle(cx="12" cy="12" r="10")
                    polyline(points="12 6 12 12 16 14")
                  | Member since #{formatDate(currentUser.created_at)}
          if stats
            .bg-white.rounded-lg.shadow-sm.border.border-gray-200.p-6.md_hidden.dark_bg-neutral-800.dark_border-neutral-700
              h2.text-sm.font-semibold.text-gray-900.mb-4.dark_text-neutral-200 Statistics

              .grid.grid-cols-2.gap-4
                .text-center.p-3.bg-gray-50.rounded-lg.dark_bg-neutral-900
                  .text-2xl.font-bold.text-gray-900.dark_text-neutral-200= stats.totalTickets || 0
                  .text-xs.text-gray-600.dark_text-neutral-400 Total Tickets

                if currentUser.role === 'agent' || currentUser.role === 'admin'
                  .text-center.p-3.bg-gray-50.rounded-lg.dark_bg-neutral-900
                    .text-2xl.font-bold.text-green-600.dark_text-green-400= stats.resolvedTickets || 0
                    .text-xs.text-gray-600.dark_text-neutral-400 Resolved

        //- Main Content Area
        .lg_col-span-2.space-y-5
          //- Profile Tab Content
          #profile-content.tab-content
            //- Profile Information Card
            .bg-white.rounded-lg.shadow-sm.border.border-gray-200.p-6.dark_bg-neutral-800.dark_border-neutral-700
              .flex.items-center.justify-between.mb-6
                h2.text-lg.font-semibold.text-gray-900.dark_text-neutral-200 Profile Information

              form(action="/users/profile" method="POST")
                div(class="space-y-6")
                  div(class="grid grid-cols-1 sm:grid-cols-2 gap-6")
                    .relative
                      input#name.floating-input(
                        class="w-full px-4 pt-6 pb-2 border-2 border-gray-300 rounded-sm bg-white text-gray-900 transition-all duration-200 outline-none focus:border-blue-600 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-200 dark:focus:border-blue-500"
                        type="text"
                        name="name"
                        value=currentUser.name
                        required
                        placeholder=" "
                      )
                      label.floating-label(for="name") Full Name

                    .relative
                      input#email.floating-input(
                        class="w-full px-4 pt-6 pb-2 border-2 border-gray-300 rounded-sm bg-white text-gray-900 transition-all duration-200 outline-none focus:border-blue-600 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-200 dark:focus:border-blue-500"
                        type="email"
                        name="email"
                        value=currentUser.email
                        required
                        placeholder=" "
                      )
                      label.floating-label(for="email") Email Address

                .flex.justify-end.pt-4.border-t.border-gray-200.dark_border-neutral-700
                    button(
                      class="inline-flex items-center gap-x-2 px-6 py-2.5 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors"
                      type="submit"
                    )
                      svg.w-4.h-4(fill="none" stroke="currentColor" viewBox="0 0 24 24")
                        path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7")
                      | Update Profile

          //- Activity Tab Content
          #activity-content.tab-content.hidden
            if recentActivity && recentActivity.length > 0
              .bg-white.rounded-lg.shadow-sm.border.border-gray-200.p-6.dark_bg-neutral-800.dark_border-neutral-700
                h2.text-lg.font-semibold.text-gray-900.mb-6.dark_text-neutral-200 Recent Activity

                .flow-root
                  ul.divide-y.divide-gray-200.dark_divide-neutral-700
                    each activity in recentActivity
                      li.py-4.first_pt-0.last_pb-0
                        div(class="flex gap-x-3")
                          .flex-shrink-0
                            if activity.action === 'created'
                              div(class="w-10 h-10 flex items-center justify-center rounded-full bg-blue-100 text-blue-600 dark:bg-blue-900 dark:text-blue-400")
                                svg(class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24")
                                  path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4")
                            else if activity.action === 'updated'
                              div(class="w-10 h-10 flex items-center justify-center rounded-full bg-yellow-100 text-yellow-600 dark:bg-yellow-900 dark:text-yellow-400")
                                svg(class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24")
                                  path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15")
                            else if activity.action === 'resolved'
                              div(class="w-10 h-10 flex items-center justify-center rounded-full bg-green-100 text-green-600 dark:bg-green-900 dark:text-green-400")
                                svg(class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24")
                                  path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z")
                            else
                              div(class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 text-gray-600")
                                svg(class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24")
                                  path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z")

                          .flex-1.min-w-0
                            p.text-sm.font-medium.text-gray-900.dark_text-neutral-200= activity.description
                            p.text-xs.text-gray-500.dark_text-neutral-500.mt-1= timeAgo(activity.created_at)

                          if activity.ticket_id
                            a.text-blue-600.hover_text-blue-800.dark_text-blue-400.dark_hover_text-blue-300(href=`/tickets/${activity.ticket_id}`)
                              svg.w-5.h-5(fill="none" stroke="currentColor" viewBox="0 0 24 24")
                                path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7")
            else
              .bg-white.rounded-lg.shadow-sm.border.border-gray-200.p-12.text-center.dark_bg-neutral-800.dark_border-neutral-700
                svg.mx-auto.h-12.w-12.text-gray-400.mb-4(fill="none" stroke="currentColor" viewBox="0 0 24 24")
                  path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4")
                p.text-sm.font-semibold.text-gray-900.dark_text-neutral-200 No activity yet
                p.text-sm.text-gray-500.dark_text-neutral-500.mt-1 Your recent activity will appear here

          //- Settings Tab Content
          #settings-content.tab-content.hidden
            .bg-white.rounded-lg.shadow-sm.border.border-gray-200.p-6.dark_bg-neutral-800.dark_border-neutral-700
              h2.text-lg.font-semibold.text-gray-900.mb-6.dark_text-neutral-200 Change Password

              form(action="/users/profile/password" method="POST")
                div(class="space-y-6")
                  .relative
                    input#current_password.floating-input(
                      class="w-full px-4 pt-6 pb-2 border-2 border-gray-300 rounded-sm bg-white text-gray-900 transition-all duration-200 outline-none focus:border-blue-600 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-200 dark:focus:border-blue-500"
                      type="password"
                      name="current_password"
                      required
                      placeholder=" "
                    )
                    label.floating-label(for="current_password") Current Password

                  .relative
                    input#new_password.floating-input(
                      class="w-full px-4 pt-6 pb-2 border-2 border-gray-300 rounded-sm bg-white text-gray-900 transition-all duration-200 outline-none focus:border-blue-600 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-200 dark:focus:border-blue-500"
                      type="password"
                      name="new_password"
                      required
                      minlength="6"
                      placeholder=" "
                    )
                    label.floating-label(for="new_password") New Password
                    p.mt-1.text-xs.text-gray-500.dark_text-neutral-400 Minimum 6 characters

                  .relative
                    input#confirm_password.floating-input(
                      class="w-full px-4 pt-6 pb-2 border-2 border-gray-300 rounded-sm bg-white text-gray-900 transition-all duration-200 outline-none focus:border-blue-600 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-200 dark:focus:border-blue-500"
                      type="password"
                      name="confirm_password"
                      required
                      minlength="6"
                      placeholder=" "
                    )
                    label.floating-label(for="confirm_password") Confirm New Password

                .flex.justify-end.pt-4.border-t.border-gray-200.dark_border-neutral-700
                    button(
                      class="inline-flex items-center gap-x-2 px-6 py-2.5 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors"
                      type="submit"
                    )
                      svg.w-4.h-4(fill="none" stroke="currentColor" viewBox="0 0 24 24")
                        path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z")
                      | Change Password

block scripts
  style.
    /* Tab alignment fixes */
    button[role="tab"] {
      align-items: center;
    }

    button[role="tab"] span {
      line-height: 1.25rem;
      display: inline-block;
    }

    button[role="tab"] svg {
      display: block;
    }

    .floating-input::placeholder {
      color: transparent;
    }

    /* Default label state - centered in input */
    .floating-label {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1rem;
      line-height: 1;
      color: #737373;
      font-weight: 500;
      transition: all 0.2s ease;
      pointer-events: none;
    }

    /* Label moves to top when input is focused or has value */
    .floating-input:focus ~ .floating-label,
    .floating-input:not(:placeholder-shown) ~ .floating-label {
      top: 0.375rem;
      transform: translateY(0);
      font-size: 0.75rem;
    }

    /* Blue color when focused */
    .floating-input:focus ~ .floating-label {
      color: #2563eb;
    }

    /* Gray color when has value but not focused */
    .floating-input:not(:focus):not(:placeholder-shown) ~ .floating-label {
      color: #737373;
    }

  script.
    // Tab switching
    function switchTab(tabName) {
      // Hide all tab contents
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
      });

      // Remove active state from all tabs
      document.querySelectorAll('[role="tab"]').forEach(tab => {
        tab.classList.remove('active', 'text-gray-800', 'dark:text-neutral-200');
        tab.classList.add('text-gray-600', 'dark:text-neutral-400');
        tab.setAttribute('aria-selected', 'false');
        const indicator = tab.querySelector('.absolute.h-0\\.5');
        if (indicator) indicator.remove();
      });

      // Show selected tab content
      const selectedContent = document.getElementById(tabName + '-content');
      if (selectedContent) {
        selectedContent.classList.remove('hidden');
      }

      // Add active state to selected tab
      const selectedTab = document.getElementById('tab-' + tabName);
      if (selectedTab) {
        selectedTab.classList.add('active', 'text-gray-800', 'dark:text-neutral-200');
        selectedTab.classList.remove('text-gray-600', 'dark:text-neutral-400');
        selectedTab.setAttribute('aria-selected', 'true');

        // Add bottom indicator
        const indicator = document.createElement('div');
        indicator.className = 'absolute -bottom-px left-0 right-0 h-0.5 bg-blue-600 dark:bg-blue-500 transition-all';
        selectedTab.appendChild(indicator);
      }
    }

    // Password validation
    const passwordForm = document.querySelector('form[action="/users/profile/password"]');
    if (passwordForm) {
      const newPassword = document.getElementById('new_password');
      const confirmPassword = document.getElementById('confirm_password');

      passwordForm.addEventListener('submit', function(e) {
        if (newPassword.value !== confirmPassword.value) {
          e.preventDefault();
          alert('New passwords do not match!');
          confirmPassword.focus();
          return false;
        }
      });

      // Real-time password match indicator
      confirmPassword.addEventListener('input', function() {
        if (this.value === newPassword.value && this.value.length > 0) {
          this.classList.remove('border-red-300');
          this.classList.add('border-green-300');
        } else if (this.value.length > 0) {
          this.classList.remove('border-green-300');
          this.classList.add('border-red-300');
        } else {
          this.classList.remove('border-green-300', 'border-red-300');
        }
      });
    }
