extends ../layout/layout

block content
  .max-w-3xl.mx-auto
    .bg-white.rounded-lg.shadow-sm.border.border-gray-200.p-6
      h2.text-2xl.font-bold.text-gray-900.mb-6 Edit User

      form(action=`/users/${user.id}` method="POST")
        input(type="hidden" name="_method" value="PUT")

        .space-y-6
          //- Name
          div
            label.block.text-sm.font-medium.text-gray-700.mb-2(for="name")
              | Full Name
              span.text-red-500 *
            input#name.w-full.px-4.py-2.border.border-gray-300.rounded-lg.focus_outline-none.focus_ring-2.focus_ring-blue-500(
              type="text"
              name="name"
              value=user.name
              required
            )

          //- Email
          div
            label.block.text-sm.font-medium.text-gray-700.mb-2(for="email")
              | Email Address
              span.text-red-500 *
            input#email.w-full.px-4.py-2.border.border-gray-300.rounded-lg.focus_outline-none.focus_ring-2.focus_ring-blue-500(
              type="email"
              name="email"
              value=user.email
              required
            )

          .grid.grid-cols-1.md_grid-cols-2.gap-6
            //- Role
            div
              label.block.text-sm.font-medium.text-gray-700.mb-2(for="role")
                | Role
                span.text-red-500 *
              select#role.w-full.px-4.py-2.border.border-gray-300.rounded-lg.focus_outline-none.focus_ring-2.focus_ring-blue-500(
                name="role"
                required
              )
                option(value="customer" selected=user.role === "customer") Customer
                option(value="agent" selected=user.role === "agent") Agent
                option(value="admin" selected=user.role === "admin") Administrator

            //- Department
            div
              label.block.text-sm.font-medium.text-gray-700.mb-2(for="department_id")
                | Department
                span.text-gray-500.text-xs.font-normal (Optional)
              select#department_id.w-full.px-4.py-2.border.border-gray-300.rounded-lg.focus_outline-none.focus_ring-2.focus_ring-blue-500(
                name="department_id"
              )
                option(value="" selected=!user.department_id) None
                if departments && departments.length > 0
                  each dept in departments
                    option(value=dept.id selected=user.department_id == dept.id)= dept.name

          //- Status
          div
            label.flex.items-center
              input#is_active.mr-2(type="checkbox" name="is_active" value="true" checked=user.is_active)
              span.text-sm.text-gray-700 Active (User can login)

          //- Password change section
          .border-t.border-gray-200.pt-6
            h3.text-lg.font-semibold.text-gray-900.mb-4 Change Password (Optional)
            p.text-sm.text-gray-600.mb-4 Leave blank to keep current password

            .grid.grid-cols-1.md_grid-cols-2.gap-6
              div
                label.block.text-sm.font-medium.text-gray-700.mb-2(for="new_password")
                  | New Password
                input#new_password.w-full.px-4.py-2.border.border-gray-300.rounded-lg.focus_outline-none.focus_ring-2.focus_ring-blue-500(
                  type="password"
                  name="new_password"
                  minlength="6"
                  placeholder="New password (min 6 chars)"
                )

              div
                label.block.text-sm.font-medium.text-gray-700.mb-2(for="confirm_new_password")
                  | Confirm New Password
                input#confirm_new_password.w-full.px-4.py-2.border.border-gray-300.rounded-lg.focus_outline-none.focus_ring-2.focus_ring-blue-500(
                  type="password"
                  name="confirm_new_password"
                  minlength="6"
                  placeholder="Confirm new password"
                )

          //- Submit buttons
          .flex.items-center.justify-between.pt-6.border-t.border-gray-200
            button.px-4.py-2.bg-red-600.text-white.rounded-lg.hover_bg-red-700.transition-colors(
              type="button"
              onclick=`if(confirm('Are you sure you want to delete this user? This action cannot be undone.')) { deleteUser(${user.id}); }`
            )
              | Delete User

            .flex.items-center.space-x-4
              a.px-6.py-2.border.border-gray-300.text-gray-700.rounded-lg.hover_bg-gray-50.transition-colors(href="/users")
                | Cancel
              button.px-6.py-2.bg-blue-600.text-white.rounded-lg.hover_bg-blue-700.transition-colors(type="submit")
                | Update User

block scripts
  script.
    // Password validation
    const form = document.querySelector('form');
    const newPassword = document.getElementById('new_password');
    const confirmNewPassword = document.getElementById('confirm_new_password');

    form.addEventListener('submit', function(e) {
      if (newPassword.value || confirmNewPassword.value) {
        if (newPassword.value !== confirmNewPassword.value) {
          e.preventDefault();
          alert('Passwords do not match!');
          confirmNewPassword.focus();
          return false;
        }
      }
    });

    // Real-time password match indicator
    if (confirmNewPassword) {
      confirmNewPassword.addEventListener('input', function() {
        if (this.value === newPassword.value && this.value.length > 0) {
          this.classList.remove('border-red-300');
          this.classList.add('border-green-300');
        } else if (this.value.length > 0) {
          this.classList.remove('border-green-300');
          this.classList.add('border-red-300');
        } else {
          this.classList.remove('border-green-300', 'border-red-300');
        }
      });
    }

    // Delete user function
    function deleteUser(userId) {
      fetch(`/users/${userId}`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json'
        }
      })
      .then(response => {
        if (response.ok) {
          window.location.href = '/users';
        } else {
          alert('Failed to delete user');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while deleting the user');
      });
    }
