extends ../layout/layout

block content
  //- Include reusable confirmation modal
  include ../partials/modal

  .max-w-3xl.mx-auto
    .bg-white.rounded-lg.shadow-sm.border.border-gray-200.p-6.dark_bg-neutral-800.dark_border-neutral-700
      h2.text-2xl.font-bold.text-gray-900.mb-6.dark_text-neutral-200 Edit User

      form#editUserForm(action=`/users/${user.id}/edit` method="POST")

        .space-y-6
          //- Name
          .relative
            input#name.floating-input(
              class="w-full px-4 pt-6 pb-2 border-2 border-gray-300 rounded-sm bg-white text-gray-900 transition-all duration-200 outline-none focus:border-blue-600 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-200 dark:focus:border-blue-500"
              type="text"
              name="name"
              value=user.name
              data-validate="required|minLength:2|maxLength:150"
              data-label="Full Name"
              placeholder=" "
            )
            label.floating-label(for="name") Full Name
            p.error-message.hidden.text-xs.text-red-600.mt-1

          //- Email
          .relative
            input#email.floating-input(
              class="w-full px-4 pt-6 pb-2 border-2 border-gray-300 rounded-sm bg-white text-gray-900 transition-all duration-200 outline-none focus:border-blue-600 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-200 dark:focus:border-blue-500"
              type="text"
              name="email"
              value=user.email
              data-validate="required|email"
              data-label="Email"
              placeholder=" "
            )
            label.floating-label(for="email") Email Address
            p.error-message.hidden.text-xs.text-red-600.mt-1

          .grid.grid-cols-1.md_grid-cols-2.gap-6
            //- Role
            .relative
              select#role.floating-input(
                class="w-full px-4 pt-6 pb-2 border-2 border-gray-300 rounded-sm bg-white text-gray-900 transition-all duration-200 outline-none focus:border-blue-600 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-200 dark:focus:border-blue-500"
                name="role"
                data-validate="required"
                data-label="Role"
              )
                option(value="customer" selected=user.role === "customer") Customer
                option(value="agent" selected=user.role === "agent") Agent
                option(value="admin" selected=user.role === "admin") Administrator
              label.floating-label.select-label(for="role") Role
              p.error-message.hidden.text-xs.text-red-600.mt-1

            //- Department
            #department_wrapper.hidden.transition-all.duration-300
              .relative
                select#department_id.floating-input(
                  class="w-full px-4 pt-6 pb-2 border-2 border-gray-300 rounded-sm bg-white text-gray-900 transition-all duration-200 outline-none focus:border-blue-600 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-200 dark:focus:border-blue-500"
                  name="department_id"
                  data-label="Department"
                )
                  option(value="" selected=!user.department_id) None
                  if departments && departments.length > 0
                    each dept in departments
                      option(value=dept.id selected=user.department_id == dept.id)= dept.name
                label.floating-label.select-label(for="department_id") Department (Optional)
                p.error-message.hidden.text-xs.text-red-600.mt-1

          //- Status
          div
            label.flex.items-center
              input#is_active.mr-2(type="checkbox" name="is_active" value="true" checked=Boolean(user.is_active))
              span.text-sm.text-gray-700.dark_text-neutral-300 Active (User can login)

          //- Password change section
          .border-t.border-gray-200.pt-6.dark_border-neutral-700
            h3.text-lg.font-semibold.text-gray-900.mb-4.dark_text-neutral-200 Change Password (Optional)
            p.text-sm.text-gray-600.mb-4.dark_text-neutral-400 Leave blank to keep current password

            .grid.grid-cols-1.md_grid-cols-2.gap-6
              .relative
                input#new_password.floating-input(
                  class="w-full px-4 pt-6 pb-2 border-2 border-gray-300 rounded-sm bg-white text-gray-900 transition-all duration-200 outline-none focus:border-blue-600 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-200 dark:focus:border-blue-500"
                  type="password"
                  name="new_password"
                  data-validate="conditionalMinLength:6:confirm_new_password"
                  data-label="password"
                  placeholder=" "
                )
                label.floating-label(for="new_password") New Password
                p.error-message.hidden.text-xs.text-red-600.mt-1
                p.text-xs.text-gray-500.mt-1 Only required if you enter a confirm password

              .relative
                input#confirm_new_password.floating-input(
                  class="w-full px-4 pt-6 pb-2 border-2 border-gray-300 rounded-sm bg-white text-gray-900 transition-all duration-200 outline-none focus:border-blue-600 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-200 dark:focus:border-blue-500"
                  type="password"
                  name="confirm_new_password"
                  data-validate="conditionalMatch:new_password"
                  data-label="password"
                  placeholder=" "
                )
                label.floating-label(for="confirm_new_password") Confirm New Password
                p.error-message.hidden.text-xs.text-red-600.mt-1
                p.text-xs.text-gray-500.mt-1 Only required if you enter a new password

          //- Submit buttons
          .flex.items-center.justify-between.pt-6.border-t.border-gray-200.dark_border-neutral-700
            button.px-4.py-2.bg-red-600.text-white.rounded-lg.hover_bg-red-700.transition-colors(
              type="button"
              onclick=`openModal('Delete User', 'This user will be permanently deleted. This action cannot be undone.', 'Delete', () => deleteUser(${user.id}))`
            )
              | Delete User

            .flex.items-center.space-x-4
              a.px-6.py-2.border.border-gray-300.text-gray-700.rounded-lg.hover_bg-gray-50.transition-colors.dark_border-neutral-600.dark_text-neutral-300.dark_hover_bg-neutral-700(href="/users")
                | Cancel
              button.px-6.py-2.bg-blue-600.text-white.rounded-lg.hover_bg-blue-700.transition-colors(type="submit")
                | Update User

block scripts
  style.
    .floating-input::placeholder {
      color: transparent;
    }

    /* Default label state - centered in input */
    .floating-label {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1rem;
      line-height: 1;
      color: #737373;
      font-weight: 500;
      transition: all 0.2s ease;
      pointer-events: none;
    }

    /* Label moves to top when input is focused or has value */
    .floating-input:focus ~ .floating-label,
    .floating-input:not(:placeholder-shown) ~ .floating-label,
    select.floating-input:valid ~ .floating-label.select-label {
      top: 0.375rem;
      transform: translateY(0);
      font-size: 0.75rem;
    }

    /* Blue color when focused */
    .floating-input:focus ~ .floating-label {
      color: #2563eb;
    }

    /* Gray color when has value but not focused */
    .floating-input:not(:focus):not(:placeholder-shown) ~ .floating-label,
    select.floating-input:not(:focus):valid ~ .floating-label.select-label {
      color: #737373;
    }

    /* Error state styling */
    .floating-input.error {
      border-color: #dc2626 !important;
    }

    .floating-input.error:focus {
      border-color: #dc2626 !important;
      box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
    }

    .floating-input.error:focus ~ .floating-label {
      color: #dc2626;
    }

    /* Valid state styling (green border for successful validation) */
    .floating-input.valid:not(:focus) {
      border-color: #16a34a;
    }

    /* Error message styling */
    .error-message {
      color: #dc2626;
      font-size: 0.75rem;
      margin-top: 0.25rem;
    }

    .error-message.hidden {
      display: none;
    }

  script(src="/js/form-validator.js")
  script.
    // Initialize form validator
    new FormValidator('#editUserForm');

    // Show/hide department based on role
    const roleSelect = document.getElementById('role');
    const deptWrapper = document.getElementById('department_wrapper');

    // Initialize on page load
    function updateDepartmentVisibility() {
      if (roleSelect.value === 'agent' || roleSelect.value === 'admin') {
        deptWrapper.classList.remove('hidden');
      } else {
        deptWrapper.classList.add('hidden');
        document.getElementById('department_id').value = '';
      }
    }

    roleSelect.addEventListener('change', updateDepartmentVisibility);
    // Initialize on page load
    updateDepartmentVisibility();

    // Delete user function
    function deleteUser(userId) {
      fetch(`/users/${userId}`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json'
        }
      })
      .then(response => {
        if (response.ok) {
          window.location.href = '/users';
        } else {
          alert('Failed to delete user');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while deleting the user');
      });
    }
