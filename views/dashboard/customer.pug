extends ../layout/customer-layout

block content
  .min-h-screen.bg-gradient-to-br.from-slate-50.via-white.to-slate-100
    //- Top banner with gradient
    .bg-gradient-to-r.from-blue-600.to-indigo-600.text-white.py-12.px-4.sm_px-6.lg_px-8
      .max-w-6xl.mx-auto
        .flex.items-center.justify-between
          div
            h1.text-5xl.font-bold.mb-2 Welcome back, #{currentUser.name}!
            p.text-lg.text-blue-100 Manage your support tickets and track progress in real-time

          a.inline-flex.items-center.gap-2.px-8.py-4.bg-white.text-blue-600.rounded-xl.hover_bg-blue-50.transition-all.font-bold.shadow-xl.hover_shadow-2xl.transform.hover_scale-105(href="/tickets/create")
            svg.w-6.h-6(fill="none" stroke="currentColor" viewBox="0 0 24 24")
              path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4")
            | New Ticket

    //- Main content
    .max-w-6xl.mx-auto.px-4.sm_px-6.lg_px-8.py-12
      //- Stats grid - Compact
      .grid.grid-cols-2.md_grid-cols-4.gap-4.mb-16
        //- Total Tickets
        .bg-white.rounded-xl.shadow-sm.p-4.border.border-gray-200.hover_shadow-md.transition-all
          .flex.items-center.gap-3
            .w-10.h-10.bg-gradient-to-br.from-blue-100.to-blue-200.rounded-lg.flex.items-center.justify-center.flex-shrink-0
              svg.w-5.h-5.text-blue-600(fill="none" stroke="currentColor" viewBox="0 0 24 24")
                path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2")
            div
              p.text-gray-600.text-xs.font-medium Total
              p.text-2xl.font-bold.text-gray-900= stats.total || 0

        //- Open Tickets
        .bg-white.rounded-xl.shadow-sm.p-4.border.border-gray-200.hover_shadow-md.transition-all
          .flex.items-center.gap-3
            .w-10.h-10.bg-gradient-to-br.from-blue-100.to-blue-200.rounded-lg.flex.items-center.justify-center.flex-shrink-0
              svg.w-5.h-5.text-blue-600(fill="none" stroke="currentColor" viewBox="0 0 24 24")
                path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z")
            div
              p.text-gray-600.text-xs.font-medium Open
              p.text-2xl.font-bold.text-blue-600= stats.open || 0

        //- In Progress
        .bg-white.rounded-xl.shadow-sm.p-4.border.border-gray-200.hover_shadow-md.transition-all
          .flex.items-center.gap-3
            .w-10.h-10.bg-gradient-to-br.from-amber-100.to-amber-200.rounded-lg.flex.items-center.justify-center.flex-shrink-0
              svg.w-5.h-5.text-amber-600(fill="none" stroke="currentColor" viewBox="0 0 24 24")
                path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z")
            div
              p.text-gray-600.text-xs.font-medium In Progress
              p.text-2xl.font-bold.text-amber-600= stats.inProgress || 0

        //- Resolved
        .bg-white.rounded-xl.shadow-sm.p-4.border.border-gray-200.hover_shadow-md.transition-all
          .flex.items-center.gap-3
            .w-10.h-10.bg-gradient-to-br.from-green-100.to-green-200.rounded-lg.flex.items-center.justify-center.flex-shrink-0
              svg.w-5.h-5.text-green-600(fill="none" stroke="currentColor" viewBox="0 0 24 24")
                path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z")
            div
              p.text-gray-600.text-xs.font-medium Resolved
              p.text-2xl.font-bold.text-green-600= stats.resolved || 0

      //- Tickets section with modern design
      div(class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden" style="margin-bottom: 3rem;")
        //- Header with gradient
        .bg-gradient-to-r.from-blue-50.to-indigo-50.px-8.py-8.border-b.border-gray-200
          .flex.items-center.justify-between
            div
              h2.text-2xl.font-bold.text-gray-900 Your Tickets
              p.text-gray-600.text-sm.mt-1 Track and manage all your support requests
            a.text-blue-600.hover_text-blue-700.font-semibold.text-sm(href="/tickets/portal") View All â†’

        if recentTickets && recentTickets.length > 0
          .divide-y.divide-gray-200
            each ticket in recentTickets
              a.block.px-8.py-6.hover_bg-gradient-to-r.hover_from-blue-50.hover_to-indigo-50.transition-all.duration-200.border-b.border-gray-100.last_border-b-0.group(href=`/tickets/${ticket.id}`)
                .flex.items-start.justify-between.gap-6
                  div.flex-1
                    .flex.items-center.gap-3.mb-3.flex-wrap
                      h3.font-semibold.text-lg.text-gray-900.group-hover_text-blue-600.transition-colors= ticket.subject
                      - const statusColors = { open: 'bg-blue-100 text-blue-800', in_progress: 'bg-amber-100 text-amber-800', resolved: 'bg-green-100 text-green-800', closed: 'bg-gray-100 text-gray-800', waiting: 'bg-purple-100 text-purple-800' }
                      span.px-3.py-1.text-xs.font-bold.rounded-full(class=statusColors[ticket.status])
                        = ticket.status.replace('_', ' ').charAt(0).toUpperCase() + ticket.status.replace('_', ' ').slice(1)

                    p.text-gray-600.text-sm.mb-4.max-w-2xl.leading-relaxed= ticket.description ? ticket.description.substring(0, 120) + (ticket.description.length > 120 ? '...' : '') : 'No description provided'

                    .flex.items-center.gap-6.text-sm.text-gray-500.flex-wrap
                      .flex.items-center.gap-2.bg-gray-50.px-3.py-1.rounded-lg
                        svg.w-4.h-4(fill="currentColor" viewBox="0 0 20 20")
                          path(d="M5.5 13a3.5 3.5 0 01-.369-6.98 4 4 0 117.753-1.3A4.5 4.5 0 1113.5 13H11V9.413l1.293 1.293a1 1 0 001.414-1.414l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13H5.5z")
                        span.font-medium.text-gray-700= ticket.department_name || 'General'

                      .flex.items-center.gap-2.bg-gray-50.px-3.py-1.rounded-lg
                        svg.w-4.h-4(fill="currentColor" viewBox="0 0 20 20")
                          path(fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v2h16V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 011 1v1h1a1 1 0 110 2H7v1a1 1 0 11-2 0v-1H4a1 1 0 110-2h1V8a1 1 0 011-1z" clip-rule="evenodd")
                        span.font-medium.text-gray-700= new Date(ticket.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })

                      .flex.items-center.gap-1
                        svg.w-4.h-4.text-gray-400(fill="currentColor" viewBox="0 0 20 20")
                          path(fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v3.586L7.707 9.293a1 1 0 00-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 9.586V6z" clip-rule="evenodd")
                        span= timeAgo(ticket.updated_at || ticket.created_at)

                  .text-right.flex-shrink-0
                    .text-3xl.font-bold.text-blue-600.group-hover_scale-110.transition-transform.origin-top-right ##{ticket.id}
                    - const priorityColors = { low: 'text-gray-500', medium: 'text-blue-600', high: 'text-orange-600', urgent: 'text-red-600', critical: 'text-red-700' }
                    .text-sm.font-bold.mt-3(class=priorityColors[ticket.priority])= ticket.priority.toUpperCase()
        else
          .px-8.py-16.text-center
            .inline-block.p-4.bg-gradient-to-br.from-blue-50.to-indigo-50.rounded-2xl.mb-6
              svg.mx-auto.h-16.w-16.text-blue-300(fill="none" stroke="currentColor" viewBox="0 0 24 24")
                path(stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z")
            h3.text-2xl.font-bold.text-gray-900.mb-2 No tickets yet
            p.text-gray-500.mb-8.text-lg You're all caught up! Create a ticket when you need support.
            a.inline-flex.items-center.gap-2.px-8.py-4.bg-gradient-to-r.from-blue-600.to-indigo-600.text-white.rounded-xl.hover_from-blue-700.hover_to-indigo-700.transition-all.font-bold.shadow-lg.hover_shadow-xl(href="/tickets/create")
              svg.w-5.h-5(fill="none" stroke="currentColor" viewBox="0 0 24 24")
                path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4")
              | Create Your First Ticket

      //- Best Practices section
      div(class="bg-gradient-to-br from-slate-50 to-blue-50 rounded-2xl border-2 border-blue-200 p-12 shadow-sm" style="margin-top: 3rem;")
        .flex.items-start.gap-4.mb-8
          .flex-shrink-0
            svg.w-8.h-8.text-blue-600(fill="none" stroke="currentColor" viewBox="0 0 24 24")
              path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z")
          h3.text-3xl.font-bold.text-gray-900 Best Practices for Support

        .grid.grid-cols-1.md_grid-cols-3.gap-6
          //- Tip 1
          .bg-white.rounded-xl.p-6.border.border-blue-100.hover_shadow-lg.transition-all
            .flex.items-center.gap-3.mb-4
              .w-12.h-12.bg-gradient-to-br.from-blue-100.to-blue-200.rounded-xl.flex.items-center.justify-center
                svg.w-6.h-6.text-blue-600(fill="currentColor" viewBox="0 0 20 20")
                  path(fill-rule="evenodd" d="M18 5v8a2 2 0 01-2 2h-5l-5 4v-4H4a2 2 0 01-2-2V5a2 2 0 012-2h12a2 2 0 012 2zm-11-1a1 1 0 11-2 0 1 1 0 012 0z" clip-rule="evenodd")
              h4.font-bold.text-gray-900 Be Specific
            p.text-gray-600.text-sm.leading-relaxed Provide detailed information about your issue, including error messages, steps to reproduce, and what you were trying to do when the issue occurred.

          //- Tip 2
          .bg-white.rounded-xl.p-6.border.border-green-100.hover_shadow-lg.transition-all
            .flex.items-center.gap-3.mb-4
              .w-12.h-12.bg-gradient-to-br.from-green-100.to-green-200.rounded-xl.flex.items-center.justify-center
                svg.w-6.h-6.text-green-600(fill="currentColor" viewBox="0 0 20 20")
                  path(d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z")
              h4.font-bold.text-gray-900 Add Attachments
            p.text-gray-600.text-sm.leading-relaxed Include screenshots, logs, or documents that help illustrate the problem. Visual details often speed up the resolution process significantly.

          //- Tip 3
          .bg-white.rounded-xl.p-6.border.border-amber-100.hover_shadow-lg.transition-all
            .flex.items-center.gap-3.mb-4
              .w-12.h-12.bg-gradient-to-br.from-amber-100.to-amber-200.rounded-xl.flex.items-center.justify-center
                svg.w-6.h-6.text-amber-600(fill="currentColor" viewBox="0 0 20 20")
                  path(fill-rule="evenodd" d="M5 2a1 1 0 011-1h8a1 1 0 011 1v1h2a2 2 0 012 2v2h1a1 1 0 110 2h-1v8a2 2 0 01-2 2H4a2 2 0 01-2-2V9H1a1 1 0 110-2h1V4a2 2 0 012-2h2V2zm0 4v8a1 1 0 001 1h10a1 1 0 001-1V6H5z" clip-rule="evenodd")
              h4.font-bold.text-gray-900 Set Priority
            p.text-gray-600.text-sm.leading-relaxed Choose the appropriate priority level for your ticket. This helps our team respond to urgent issues faster and serve you better.


block scripts
  script.
    function openAllTicketsModal(event) {
      event.preventDefault();
      document.getElementById('allTicketsModal').classList.remove('hidden');
      // Load first ticket by default
      const firstTicket = document.querySelector('[data-ticket-id]');
      if (firstTicket) {
        selectTicketModal(parseInt(firstTicket.getAttribute('data-ticket-id')));
      }
    }

    function closeAllTicketsModal(event) {
      if (event) event.preventDefault();
      document.getElementById('allTicketsModal').classList.add('hidden');
    }

    function selectTicketModal(ticketId) {
      // Update active state in sidebar
      document.querySelectorAll('.ticket-item').forEach(item => {
        item.classList.remove('bg-blue-50');
        item.style.borderLeft = '4px solid transparent';
      });
      const selectedItem = document.querySelector(`[data-ticket-id="${ticketId}"]`);
      if (selectedItem) {
        selectedItem.classList.add('bg-blue-50');
        selectedItem.style.borderLeft = '4px solid rgb(37, 99, 235)';
      }

      // Fetch ticket data
      fetch(`/api/tickets/${ticketId}`)
        .then(res => res.json())
        .then(ticket => {
          // Update header
          document.getElementById('ticketTitle').textContent = ticket.subject;

          // Update status badge
          const statusColors = {
            'open': 'bg-blue-100 text-blue-800',
            'in_progress': 'bg-amber-100 text-amber-800',
            'resolved': 'bg-green-100 text-green-800',
            'closed': 'bg-gray-100 text-gray-800',
            'waiting': 'bg-purple-100 text-purple-800'
          };
          const statusEl = document.getElementById('ticketStatus');
          statusEl.className = 'px-2 py-0.5 text-xs font-bold rounded mt-1 inline-block ' + (statusColors[ticket.status] || 'bg-gray-100 text-gray-800');
          statusEl.textContent = ticket.status.replace('_', ' ').charAt(0).toUpperCase() + ticket.status.replace('_', ' ').slice(1);

          // Update ticket details
          document.getElementById('ticketPriority').textContent = ticket.priority.toUpperCase();
          document.getElementById('ticketCreated').textContent = new Date(ticket.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
          document.getElementById('ticketDepartment').textContent = ticket.department_name || 'General';

          // Load messages
          loadMessages(ticketId);
        })
        .catch(err => console.error('Error loading ticket:', err));
    }

    function loadMessages(ticketId) {
      // Fetch messages/chat for this ticket
      fetch(`/api/tickets/${ticketId}/messages`)
        .then(res => res.json())
        .then(data => {
          const messagesArea = document.getElementById('messagesArea');
          messagesArea.innerHTML = '';

          if (data.messages && data.messages.length > 0) {
            data.messages.forEach(msg => {
              const msgDiv = document.createElement('div');
              msgDiv.className = 'flex ' + (msg.isOwn ? 'justify-end' : 'justify-start');
              msgDiv.innerHTML = `
                <div class="${msg.isOwn ? 'bg-blue-600 text-white' : 'bg-white border border-gray-200'} rounded-lg px-4 py-2 max-w-xs">
                  <p class="text-sm">${msg.content}</p>
                  <p class="text-xs ${msg.isOwn ? 'text-blue-100' : 'text-gray-500'} mt-1">${new Date(msg.created_at).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}</p>
                </div>
              `;
              messagesArea.appendChild(msgDiv);
            });
          } else {
            messagesArea.innerHTML = '<p class="text-center text-gray-500 text-sm">No messages yet</p>';
          }

          // Scroll to bottom
          messagesArea.scrollTop = messagesArea.scrollHeight;
        })
        .catch(err => console.error('Error loading messages:', err));
    }

    function sendMessage() {
      const input = document.getElementById('messageInput');
      const message = input.value.trim();

      if (!message) return;

      const ticketId = document.querySelector('.ticket-item.bg-blue-50')?.getAttribute('data-ticket-id');
      if (!ticketId) return;

      fetch(`/api/tickets/${ticketId}/messages`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content: message })
      })
      .then(res => res.json())
      .then(() => {
        input.value = '';
        loadMessages(ticketId);
      })
      .catch(err => console.error('Error sending message:', err));
    }

