extends ../layout/layout

block content
  .max-w-7xl.mx-auto
    //- Stats cards (responsive grid)
    div(style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;")
      //- Total Tickets
      .bg-white.rounded-lg.shadow-sm.border.border-gray-200.p-6
        .flex.items-center.justify-between
          div
            p.text-sm.text-gray-600 Total Tickets
            p.text-3xl.font-bold.text-gray-900= stats.totalTickets || 0
            if stats.ticketsTrend !== undefined
              p.text-sm(class=stats.ticketsTrend >= 0 ? 'text-green-600' : 'text-red-600')
                = (stats.ticketsTrend >= 0 ? '+' : '') + stats.ticketsTrend + '% from last month'
          .w-12.h-12.bg-blue-100.rounded-lg.flex.items-center.justify-center
            svg.w-6.h-6.text-blue-600(fill="none" stroke="currentColor" viewBox="0 0 24 24")
              path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2")

      //- Open Tickets
      .bg-white.rounded-lg.shadow-sm.border.border-gray-200.p-6
        .flex.items-center.justify-between
          div
            p.text-sm.text-gray-600 Open Tickets
            p.text-3xl.font-bold.text-blue-600= stats.openTickets || 0
            p.text-sm.text-gray-500= ((stats.openTickets / (stats.totalTickets || 1)) * 100).toFixed(1) + '% of total'
          .w-12.h-12.bg-blue-100.rounded-lg.flex.items-center.justify-center
            svg.w-6.h-6.text-blue-600(fill="none" stroke="currentColor" viewBox="0 0 24 24")
              path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z")

      //- In Progress
      .bg-white.rounded-lg.shadow-sm.border.border-gray-200.p-6
        .flex.items-center.justify-between
          div
            p.text-sm.text-gray-600 In Progress
            p.text-3xl.font-bold.text-yellow-600= stats.inProgressTickets || 0
            p.text-sm.text-gray-500= ((stats.inProgressTickets / (stats.totalTickets || 1)) * 100).toFixed(1) + '% of total'
          .w-12.h-12.bg-yellow-100.rounded-lg.flex.items-center.justify-center
            svg.w-6.h-6.text-yellow-600(fill="none" stroke="currentColor" viewBox="0 0 24 24")
              path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z")

      //- Resolved Today
      .bg-white.rounded-lg.shadow-sm.border.border-gray-200.p-6
        .flex.items-center.justify-between
          div
            p.text-sm.text-gray-600 Resolved Today
            p.text-3xl.font-bold.text-green-600= stats.resolvedToday || 0
            if stats.avgResolutionTime
              p.text-sm.text-gray-500 Avg: #{stats.avgResolutionTime}
          .w-12.h-12.bg-green-100.rounded-lg.flex.items-center.justify-center
            svg.w-6.h-6.text-green-600(fill="none" stroke="currentColor" viewBox="0 0 24 24")
              path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z")

    //- Charts row 1 (Status, Priority, Department)
    div(style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;")
      //- Tickets by Status Chart
      .bg-white.rounded-lg.shadow-sm.border.border-gray-200.p-6
        h3.text-sm.font-semibold.text-gray-900.mb-3 Tickets by Status
        div(style="height: 250px;")
          canvas#statusChart

      //- Tickets by Priority Chart
      .bg-white.rounded-lg.shadow-sm.border.border-gray-200.p-6
        h3.text-sm.font-semibold.text-gray-900.mb-3 Tickets by Priority
        div(style="height: 250px; display: flex; align-items: center; justify-content: center;")
          canvas#priorityChart(style="height: 320px; width: 100%;")

      //- Department Performance
      .bg-white.rounded-lg.shadow-sm.border.border-gray-200.p-6
        h3.text-sm.font-semibold.text-gray-900.mb-3 Department Performance
        div(style="height: 250px; display: flex; align-items: center; justify-content: center;")
          canvas#departmentChart(style="height: 350px; width: 100%;")

    //- Tickets Over Time (full width)
    .bg-white.rounded-lg.shadow-sm.border.border-gray-200.p-6.mb-6
      h3.text-sm.font-semibold.text-gray-900.mb-3 Tickets Over Time (Last 30 Days)
      div(style="height: 350px;")
        canvas#ticketsOverTimeChart

    //- Agent Performance
    .bg-white.rounded-lg.shadow-sm.border.border-gray-200.p-6.mb-6
      h3.text-lg.font-semibold.text-gray-900.mb-4 Agent Performance

      if agentStats && agentStats.length > 0
        .overflow-x-auto
          table.min-w-full.divide-y.divide-gray-200
            thead.bg-gray-50
              tr
                th.px-6.py-3.text-left.text-xs.font-medium.text-gray-500.uppercase.tracking-wider Agent
                th.px-6.py-3.text-left.text-xs.font-medium.text-gray-500.uppercase.tracking-wider Assigned
                th.px-6.py-3.text-left.text-xs.font-medium.text-gray-500.uppercase.tracking-wider Resolved
                th.px-6.py-3.text-left.text-xs.font-medium.text-gray-500.uppercase.tracking-wider Resolution Rate
                th.px-6.py-3.text-left.text-xs.font-medium.text-gray-500.uppercase.tracking-wider Avg. Resolution Time
                th.px-6.py-3.text-left.text-xs.font-medium.text-gray-500.uppercase.tracking-wider Status

            tbody.bg-white.divide-y.divide-gray-200
              each agent in agentStats
                tr.hover_bg-gray-50
                  td.px-6.py-4.whitespace-nowrap
                    .flex.items-center
                      .w-8.h-8.rounded-full.bg-blue-600.text-white.flex.items-center.justify-center.font-semibold.text-sm.mr-3
                        = agent.name.charAt(0).toUpperCase()
                      div
                        .text-sm.font-medium.text-gray-900= agent.name
                        .text-xs.text-gray-500= agent.email

                  td.px-6.py-4.whitespace-nowrap
                    .text-sm.text-gray-900= agent.assigned || 0

                  td.px-6.py-4.whitespace-nowrap
                    .text-sm.text-green-600.font-semibold= agent.resolved || 0

                  td.px-6.py-4.whitespace-nowrap
                    - const rate = agent.assigned > 0 ? ((agent.resolved / agent.assigned) * 100).toFixed(1) : 0
                    .flex.items-center
                      .text-sm.font-medium.text-gray-900= rate + '%'
                      .ml-2.w-20.bg-gray-200.rounded-full.h-2
                        .bg-green-600.rounded-full.h-2(style=`width: ${rate}%`)

                  td.px-6.py-4.whitespace-nowrap
                    .text-sm.text-gray-900= agent.avgResolutionTime || 'N/A'

                  td.px-6.py-4.whitespace-nowrap
                    if agent.is_active
                      span.px-2.py-1.text-xs.font-semibold.rounded-full.bg-green-100.text-green-800 Active
                    else
                      span.px-2.py-1.text-xs.font-semibold.rounded-full.bg-gray-100.text-gray-800 Inactive
      else
        .text-center.py-8.text-gray-500
          p No agent data available

    //- Recent Activity
    .bg-white.rounded-lg.shadow-sm.border.border-gray-200.p-6
      .flex.items-center.justify-between.mb-4
        h3.text-lg.font-semibold.text-gray-900 Recent Tickets

        a.text-blue-600.hover_text-blue-800.text-sm(href="/tickets") View All

      if recentTickets && recentTickets.length > 0
        .space-y-3
          each ticket in recentTickets
            .flex.items-center.justify-between.p-3.border.border-gray-200.rounded-lg.hover_bg-gray-50.transition-colors
              .flex.items-center.space-x-4
                .flex-shrink-0
                  - const statusColors = { open: 'bg-blue-100 text-blue-800', in_progress: 'bg-yellow-100 text-yellow-800', resolved: 'bg-green-100 text-green-800', closed: 'bg-gray-100 text-gray-800' }
                  span.px-2.py-1.text-xs.font-semibold.rounded-full(class=statusColors[ticket.status])
                    = ticket.status.replace('_', ' ').toUpperCase()

                div.flex-1
                  .font-medium.text-gray-900= ticket.subject
                  .text-sm.text-gray-500
                    = '#' + ticket.id + ' • ' + ticket.customer_name + ' • ' + timeAgo(ticket.created_at)

                - const priorityColors = { low: 'bg-gray-100 text-gray-800', medium: 'bg-blue-100 text-blue-800', high: 'bg-orange-100 text-orange-800', urgent: 'bg-red-100 text-red-800' }
                span.px-2.py-1.text-xs.font-semibold.rounded-full(class=priorityColors[ticket.priority])
                  = ticket.priority.toUpperCase()

              a.text-blue-600.hover_text-blue-800(href=`/tickets/${ticket.id}`)
                svg.w-5.h-5(fill="none" stroke="currentColor" viewBox="0 0 24 24")
                  path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7")
      else
        .text-center.py-8.text-gray-500
          p No recent tickets

block scripts
  script.
    // Tickets by Status Chart
    const statusCtx = document.getElementById('statusChart');
    if (statusCtx) {
      new Chart(statusCtx, {
        type: 'doughnut',
        data: {
          labels: ['Open', 'In Progress', 'Resolved', 'Closed'],
          datasets: [{
            data: [
              #{stats.openTickets || 0},
              #{stats.inProgressTickets || 0},
              #{stats.resolvedTickets || 0},
              #{stats.closedTickets || 0}
            ],
            backgroundColor: ['#3B82F6', '#F59E0B', '#10B981', '#6B7280']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });
    }

    // Tickets by Priority Chart
    const priorityCtx = document.getElementById('priorityChart');
    if (priorityCtx) {
      new Chart(priorityCtx, {
        type: 'bar',
        data: {
          labels: ['Low', 'Medium', 'High', 'Urgent'],
          datasets: [{
            label: 'Tickets',
            data: [
              #{stats.lowPriority || 0},
              #{stats.mediumPriority || 0},
              #{stats.highPriority || 0},
              #{stats.urgentPriority || 0}
            ],
            backgroundColor: ['#6B7280', '#3B82F6', '#F97316', '#EF4444']
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1
              }
            }
          }
        }
      });
    }

    // Tickets Over Time Chart
    const timeCtx = document.getElementById('ticketsOverTimeChart');
    if (timeCtx) {
      new Chart(timeCtx, {
        type: 'line',
        data: {
          labels: !{JSON.stringify(chartData.dates)},
          datasets: [{
            label: 'Created',
            data: !{JSON.stringify(chartData.created)},
            borderColor: '#3B82F6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            tension: 0.4
          }, {
            label: 'Resolved',
            data: !{JSON.stringify(chartData.resolved)},
            borderColor: '#10B981',
            backgroundColor: 'rgba(16, 185, 129, 0.1)',
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1
              }
            }
          }
        }
      });
    }

    // Department Performance Chart
    const deptCtx = document.getElementById('departmentChart');
    if (deptCtx) {
      new Chart(deptCtx, {
        type: 'bar',
        data: {
          labels: !{JSON.stringify(departmentChartData.labels)},
          datasets: [{
            label: 'Open',
            data: !{JSON.stringify(departmentChartData.data)},
            backgroundColor: '#3B82F6'
          }, {
            label: 'Resolved',
            data: !{JSON.stringify(departmentChartData.resolved)},
            backgroundColor: '#10B981'
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'bottom'
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1
              }
            }
          }
        }
      });
    }
