extends ../layout/layout

block content
  //- Include shared header
  include ./partials/tickets-header

  //- Kanban Board (only for admin/agent)
  if isAdmin() || isAgent()
    if tickets && tickets.length > 0
      .flex-1.overflow-x-auto.bg-gray-100.p-6
      .flex.space-x-6.h-full.min-w-max
        if showEscalated
          //- Escalated Tickets Column
          .flex-shrink-0.w-80.flex.flex-col
            .flex.items-center.justify-between.mb-4
              .flex.items-center.space-x-2
                .w-3.h-3.rounded-full.bg-red-500
                h3.text-sm.font-semibold.text-gray-900.uppercase Escalated Tickets
              span.px-2.py-1.text-xs.font-semibold.text-white.bg-red-600.rounded-full
                = tickets.length

            .flex-1.space-y-3.overflow-y-auto.pr-2.kanban-column(style="max-height: calc(100vh - 250px)" data-status="Escalated" data-escalated-mode="true")
              each ticket in tickets
                include ./partials/ticket-card
              else
                .text-center.py-12.text-gray-400
                  svg.mx-auto.h-12.w-12.mb-4(fill="none" stroke="currentColor" viewBox="0 0 24 24")
                    path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z")
                  p.text-sm.font-medium No escalated tickets
                  p.text-xs.mt-1 All tickets are being handled normally
        else
          //- Open Column
          .flex-shrink-0.w-80.flex.flex-col
            .flex.items-center.justify-between.mb-4
              .flex.items-center.space-x-2
                .w-3.h-3.rounded-full.bg-blue-500
                h3.text-sm.font-semibold.text-gray-900.uppercase Open
              span.px-2.py-1.text-xs.font-semibold.text-gray-600.bg-gray-200.rounded-full
                = tickets.filter(t => t.status === 'Open').length

            .flex-1.space-y-3.overflow-y-auto.pr-2.kanban-column(style="max-height: calc(100vh - 250px)" data-status="Open")
              each ticket in tickets.filter(t => t.status === 'Open')
                include ./partials/ticket-card
              else
                .text-center.py-8.text-gray-400.text-sm No tickets

          //- In Progress Column
          .flex-shrink-0.w-80.flex.flex-col
            .flex.items-center.justify-between.mb-4
              .flex.items-center.space-x-2
                .w-3.h-3.rounded-full.bg-yellow-500
                h3.text-sm.font-semibold.text-gray-900.uppercase In Progress
              span.px-2.py-1.text-xs.font-semibold.text-gray-600.bg-gray-200.rounded-full
                = tickets.filter(t => t.status === 'In Progress').length

            .flex-1.space-y-3.overflow-y-auto.pr-2.kanban-column(style="max-height: calc(100vh - 250px)" data-status="In Progress")
              each ticket in tickets.filter(t => t.status === 'In Progress')
                include ./partials/ticket-card
              else
                .text-center.py-8.text-gray-400.text-sm No tickets

          //- Resolved Column
          .flex-shrink-0.w-80.flex.flex-col
            .flex.items-center.justify-between.mb-4
              .flex.items-center.space-x-2
                .w-3.h-3.rounded-full.bg-green-500
                h3.text-sm.font-semibold.text-gray-900.uppercase Resolved
              span.px-2.py-1.text-xs.font-semibold.text-gray-600.bg-gray-200.rounded-full
                = tickets.filter(t => t.status === 'Resolved').length

            .flex-1.space-y-3.overflow-y-auto.pr-2.kanban-column(style="max-height: calc(100vh - 250px)" data-status="Resolved")
              each ticket in tickets.filter(t => t.status === 'Resolved')
                include ./partials/ticket-card
              else
                .text-center.py-8.text-gray-400.text-sm No tickets

          //- Closed Column
          .flex-shrink-0.w-80.flex.flex-col
            .flex.items-center.justify-between.mb-4
              .flex.items-center.space-x-2
                .w-3.h-3.rounded-full.bg-gray-500
                h3.text-sm.font-semibold.text-gray-900.uppercase Closed
              span.px-2.py-1.text-xs.font-semibold.text-gray-600.bg-gray-200.rounded-full
                = tickets.filter(t => t.status === 'Closed').length

            .flex-1.space-y-3.overflow-y-auto.pr-2.kanban-column(style="max-height: calc(100vh - 250px)" data-status="Closed")
              each ticket in tickets.filter(t => t.status === 'Closed')
                include ./partials/ticket-card
              else
                .text-center.py-8.text-gray-400.text-sm No tickets
    else
      .flex.items-center.justify-center.h-full
        .text-center.p-8
          svg.mx-auto.h-16.w-16.text-gray-400(fill="none" stroke="currentColor" viewBox="0 0 24 24")
            path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z")
          p.mt-4.text-lg.font-medium.text-gray-900 No tickets found


  //- Customer List View
  else
    .flex-1.overflow-y-auto.bg-gray-50.p-6
      .max-w-6xl.mx-auto
        //- Header
        .mb-8
          h2.text-3xl.font-bold.text-gray-900.mb-2 All Your Tickets
          p.text-gray-600 Manage and track all your support requests

        if tickets && tickets.length > 0
          .bg-white.rounded-2xl.shadow-sm.border.border-gray-200.overflow-hidden
            .divide-y.divide-gray-200
              each ticket in tickets
                a.block.px-8.py-6.hover_bg-blue-50.transition-colors.border-b.border-gray-100.last_border-b-0.group(href=`/tickets/${ticket.id}`)
                  .flex.items-start.justify-between.gap-6
                    div.flex-1
                      .flex.items-center.gap-3.mb-3.flex-wrap
                        h3.font-semibold.text-lg.text-gray-900.group-hover_text-blue-600.transition-colors= ticket.subject
                        - const statusColors = { open: 'bg-blue-100 text-blue-800', in_progress: 'bg-amber-100 text-amber-800', resolved: 'bg-green-100 text-green-800', closed: 'bg-gray-100 text-gray-800', waiting: 'bg-purple-100 text-purple-800', 'Open': 'bg-blue-100 text-blue-800', 'In Progress': 'bg-amber-100 text-amber-800', 'Resolved': 'bg-green-100 text-green-800', 'Closed': 'bg-gray-100 text-gray-800' }
                        span.px-3.py-1.text-xs.font-bold.rounded-full(class=statusColors[ticket.status])
                          = ticket.status

                        - const priorityColors = { low: 'text-gray-500', medium: 'text-blue-600', high: 'text-orange-600', urgent: 'text-red-600', critical: 'text-red-700', 'Low': 'text-gray-500', 'Medium': 'text-blue-600', 'High': 'text-orange-600', 'Urgent': 'text-red-600' }
                        span.text-sm.font-semibold(class=priorityColors[ticket.priority])= ticket.priority

                      p.text-gray-600.text-sm.mb-4.max-w-2xl.leading-relaxed= ticket.description ? ticket.description.substring(0, 150) + (ticket.description.length > 150 ? '...' : '') : 'No description'

                      .flex.items-center.gap-6.text-sm.text-gray-500.flex-wrap
                        .flex.items-center.gap-2.bg-gray-50.px-3.py-1.rounded-lg
                          svg.w-4.h-4(fill="currentColor" viewBox="0 0 20 20")
                            path(d="M5.5 13a3.5 3.5 0 01-.369-6.98 4 4 0 117.753-1.3A4.5 4.5 0 1113.5 13H11V9.413l1.293 1.293a1 1 0 001.414-1.414l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13H5.5z")
                          span.font-medium.text-gray-700= ticket.department_name || 'General'

                        .flex.items-center.gap-2.bg-gray-50.px-3.py-1.rounded-lg
                          svg.w-4.h-4(fill="currentColor" viewBox="0 0 20 20")
                            path(fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v2h16V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 011 1v1h1a1 1 0 110 2H7v1a1 1 0 11-2 0v-1H4a1 1 0 110-2h1V8a1 1 0 011-1z" clip-rule="evenodd")
                            span.font-medium.text-gray-700= new Date(ticket.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })

                        .flex.items-center.gap-1
                          svg.w-4.h-4.text-gray-400(fill="currentColor" viewBox="0 0 20 20")
                            path(fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v3.586L7.707 9.293a1 1 0 00-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 9.586V6z" clip-rule="evenodd")
                          span= timeAgo(ticket.updated_at || ticket.created_at)

                    .text-right.flex-shrink-0
                      .text-3xl.font-bold.text-blue-600.group-hover_scale-110.transition-transform.origin-top-right ##{ticket.id}

        else
          .bg-white.rounded-2xl.shadow-sm.border.border-gray-200.p-12.text-center
            svg.mx-auto.h-16.w-16.text-gray-300.mb-4(fill="none" stroke="currentColor" viewBox="0 0 24 24")
              path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z")
            h3.text-xl.font-semibold.text-gray-900.mb-2 No tickets yet
            p.text-gray-500.mb-8 You haven't created any support tickets yet. Start by creating one now.
            a.inline-flex.items-center.gap-2.px-8.py-4.bg-gradient-to-r.from-blue-600.to-indigo-600.text-white.rounded-xl.hover_from-blue-700.hover_to-indigo-700.transition-all.font-bold.shadow-lg.hover_shadow-xl(href="/tickets/create")
              svg.w-5.h-5(fill="none" stroke="currentColor" viewBox="0 0 24 24")
                path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4")
              | Create Your First Ticket

  //- Scripts (Filter toggle is handled in tickets-header.pug)
  script.
    // Drag and Drop functionality
    let draggedElement = null;
    let draggedTicketId = null;

    // Helper function to show notifications
    function showNotification(message, type = 'success') {
      const notification = document.createElement('div');
      const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
      notification.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-fade-in`;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transition = 'opacity 0.3s';
        setTimeout(() => notification.remove(), 300);
      }, 2000);
    }

    // Helper function to update column counts
    function updateColumnCounts() {
      document.querySelectorAll('.kanban-column').forEach(column => {
        const status = column.getAttribute('data-status');
        const count = column.querySelectorAll('.ticket-card').length;
        const badge = column.parentElement.querySelector('.px-2.py-1.text-xs');
        if (badge) {
          badge.textContent = count;
        }
      });
    }

    // Add event listeners to all ticket cards
    document.querySelectorAll('.ticket-card').forEach(card => {
      card.addEventListener('dragstart', function(e) {
        draggedElement = this;
        draggedTicketId = this.getAttribute('data-ticket-id');
        this.style.opacity = '0.5';
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', this.innerHTML);
      });

      card.addEventListener('dragend', function(e) {
        this.style.opacity = '1';
        document.querySelectorAll('.kanban-column').forEach(col => {
          col.classList.remove('bg-blue-50', 'border-2', 'border-dashed', 'border-blue-400');
        });
      });
    });

    // Add event listeners to columns
    document.querySelectorAll('.kanban-column').forEach(column => {
      column.addEventListener('dragover', function(e) {
        if (e.preventDefault) {
          e.preventDefault();
        }
        e.dataTransfer.dropEffect = 'move';
        this.classList.add('bg-blue-50', 'border-2', 'border-dashed', 'border-blue-400');
        return false;
      });

      column.addEventListener('dragenter', function(e) {
        this.classList.add('bg-blue-50', 'border-2', 'border-dashed', 'border-blue-400');
      });

      column.addEventListener('dragleave', function(e) {
        this.classList.remove('bg-blue-50', 'border-2', 'border-dashed', 'border-blue-400');
      });

      column.addEventListener('drop', function(e) {
        if (e.stopPropagation) {
          e.stopPropagation();
        }

        this.classList.remove('bg-blue-50', 'border-2', 'border-dashed', 'border-blue-400');

        const newStatus = this.getAttribute('data-status');
        const isEscalatedMode = this.getAttribute('data-escalated-mode') === 'true';
        const targetColumn = this;

        // Prevent status changes in escalated mode
        if (isEscalatedMode) {
          showNotification('Cannot change status in escalated view. Switch to normal view first.', 'error');
          return false;
        }
        
        // Move card immediately in DOM for instant feedback
        if (draggedElement && draggedElement.parentNode !== targetColumn) {
          targetColumn.insertBefore(draggedElement, targetColumn.firstChild);
          
          // Update count badges immediately
          updateColumnCounts();
        }
        
        // Update ticket status via API in background
        fetch(`/api/tickets/${draggedTicketId}/status`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ status: newStatus })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Show success notification only if status actually changed
            if (!data.skipped) {
              showNotification(`Ticket #${draggedTicketId} moved to ${newStatus}`, 'success');
            }
            // If skipped (already in that status), do nothing silently
          } else {
            showNotification('Error: ' + (data.message || 'Failed to update'), 'error');
            // Reload on error to restore correct state
            setTimeout(() => window.location.reload(), 2000);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          showNotification('Network error - please refresh', 'error');
          setTimeout(() => window.location.reload(), 2000);
        });

        return false;
      });
    });

