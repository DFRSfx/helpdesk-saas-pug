extends ../layout/layout

block content
  //- Include shared header
  include ./partials/tickets-header

  //- Kanban Board
  .flex-1.overflow-x-auto.bg-gray-100.p-6
    if tickets && tickets.length > 0
      .flex.space-x-6.h-full.min-w-max
        if showEscalated
          //- Escalated Tickets Column
          .flex-shrink-0.w-80.flex.flex-col
            .flex.items-center.justify-between.mb-4
              .flex.items-center.space-x-2
                .w-3.h-3.rounded-full.bg-red-500
                h3.text-sm.font-semibold.text-gray-900.uppercase Escalated Tickets
              span.px-2.py-1.text-xs.font-semibold.text-white.bg-red-600.rounded-full
                = tickets.length

            .flex-1.space-y-3.overflow-y-auto.pr-2.kanban-column(style="max-height: calc(100vh - 250px)" data-status="Escalated" data-escalated-mode="true")
              each ticket in tickets
                include ./partials/ticket-card
              else
                .text-center.py-12.text-gray-400
                  svg.mx-auto.h-12.w-12.mb-4(fill="none" stroke="currentColor" viewBox="0 0 24 24")
                    path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z")
                  p.text-sm.font-medium No escalated tickets
                  p.text-xs.mt-1 All tickets are being handled normally
        else
          //- Open Column
          .flex-shrink-0.w-80.flex.flex-col
            .flex.items-center.justify-between.mb-4
              .flex.items-center.space-x-2
                .w-3.h-3.rounded-full.bg-blue-500
                h3.text-sm.font-semibold.text-gray-900.uppercase Open
              span.px-2.py-1.text-xs.font-semibold.text-gray-600.bg-gray-200.rounded-full
                = tickets.filter(t => t.status === 'Open').length

            .flex-1.space-y-3.overflow-y-auto.pr-2.kanban-column(style="max-height: calc(100vh - 250px)" data-status="Open")
              each ticket in tickets.filter(t => t.status === 'Open')
                include ./partials/ticket-card
              else
                .text-center.py-8.text-gray-400.text-sm No tickets

          //- In Progress Column
          .flex-shrink-0.w-80.flex.flex-col
            .flex.items-center.justify-between.mb-4
              .flex.items-center.space-x-2
                .w-3.h-3.rounded-full.bg-yellow-500
                h3.text-sm.font-semibold.text-gray-900.uppercase In Progress
              span.px-2.py-1.text-xs.font-semibold.text-gray-600.bg-gray-200.rounded-full
                = tickets.filter(t => t.status === 'In Progress').length

            .flex-1.space-y-3.overflow-y-auto.pr-2.kanban-column(style="max-height: calc(100vh - 250px)" data-status="In Progress")
              each ticket in tickets.filter(t => t.status === 'In Progress')
                include ./partials/ticket-card
              else
                .text-center.py-8.text-gray-400.text-sm No tickets

          //- Resolved Column
          .flex-shrink-0.w-80.flex.flex-col
            .flex.items-center.justify-between.mb-4
              .flex.items-center.space-x-2
                .w-3.h-3.rounded-full.bg-green-500
                h3.text-sm.font-semibold.text-gray-900.uppercase Resolved
              span.px-2.py-1.text-xs.font-semibold.text-gray-600.bg-gray-200.rounded-full
                = tickets.filter(t => t.status === 'Resolved').length

            .flex-1.space-y-3.overflow-y-auto.pr-2.kanban-column(style="max-height: calc(100vh - 250px)" data-status="Resolved")
              each ticket in tickets.filter(t => t.status === 'Resolved')
                include ./partials/ticket-card
              else
                .text-center.py-8.text-gray-400.text-sm No tickets

          //- Closed Column
          .flex-shrink-0.w-80.flex.flex-col
            .flex.items-center.justify-between.mb-4
              .flex.items-center.space-x-2
                .w-3.h-3.rounded-full.bg-gray-500
                h3.text-sm.font-semibold.text-gray-900.uppercase Closed
              span.px-2.py-1.text-xs.font-semibold.text-gray-600.bg-gray-200.rounded-full
                = tickets.filter(t => t.status === 'Closed').length

            .flex-1.space-y-3.overflow-y-auto.pr-2.kanban-column(style="max-height: calc(100vh - 250px)" data-status="Closed")
              each ticket in tickets.filter(t => t.status === 'Closed')
                include ./partials/ticket-card
              else
                .text-center.py-8.text-gray-400.text-sm No tickets
    else
      .flex.items-center.justify-center.h-full
        .text-center.p-8
          svg.mx-auto.h-16.w-16.text-gray-400(fill="none" stroke="currentColor" viewBox="0 0 24 24")
            path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z")
          p.mt-4.text-lg.font-medium.text-gray-900 No tickets found
          p.mt-2.text-sm.text-gray-500 Start by creating your first support ticket
          a.mt-6.inline-flex.items-center.px-4.py-2.bg-blue-600.text-white.rounded-lg.transition-colors(class="hover:bg-blue-700" href="/tickets/create")
            svg.w-5.h-5.mr-2(fill="none" stroke="currentColor" viewBox="0 0 24 24")
              path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4")
            | Create Ticket

  //- Scripts (Filter toggle is handled in tickets-header.pug)
  script.
    // Drag and Drop functionality
    let draggedElement = null;
    let draggedTicketId = null;

    // Helper function to show notifications
    function showNotification(message, type = 'success') {
      const notification = document.createElement('div');
      const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
      notification.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-fade-in`;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transition = 'opacity 0.3s';
        setTimeout(() => notification.remove(), 300);
      }, 2000);
    }

    // Helper function to update column counts
    function updateColumnCounts() {
      document.querySelectorAll('.kanban-column').forEach(column => {
        const status = column.getAttribute('data-status');
        const count = column.querySelectorAll('.ticket-card').length;
        const badge = column.parentElement.querySelector('.px-2.py-1.text-xs');
        if (badge) {
          badge.textContent = count;
        }
      });
    }

    // Add event listeners to all ticket cards
    document.querySelectorAll('.ticket-card').forEach(card => {
      card.addEventListener('dragstart', function(e) {
        draggedElement = this;
        draggedTicketId = this.getAttribute('data-ticket-id');
        this.style.opacity = '0.5';
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', this.innerHTML);
      });

      card.addEventListener('dragend', function(e) {
        this.style.opacity = '1';
        document.querySelectorAll('.kanban-column').forEach(col => {
          col.classList.remove('bg-blue-50', 'border-2', 'border-dashed', 'border-blue-400');
        });
      });
    });

    // Add event listeners to columns
    document.querySelectorAll('.kanban-column').forEach(column => {
      column.addEventListener('dragover', function(e) {
        if (e.preventDefault) {
          e.preventDefault();
        }
        e.dataTransfer.dropEffect = 'move';
        this.classList.add('bg-blue-50', 'border-2', 'border-dashed', 'border-blue-400');
        return false;
      });

      column.addEventListener('dragenter', function(e) {
        this.classList.add('bg-blue-50', 'border-2', 'border-dashed', 'border-blue-400');
      });

      column.addEventListener('dragleave', function(e) {
        this.classList.remove('bg-blue-50', 'border-2', 'border-dashed', 'border-blue-400');
      });

      column.addEventListener('drop', function(e) {
        if (e.stopPropagation) {
          e.stopPropagation();
        }

        this.classList.remove('bg-blue-50', 'border-2', 'border-dashed', 'border-blue-400');

        const newStatus = this.getAttribute('data-status');
        const isEscalatedMode = this.getAttribute('data-escalated-mode') === 'true';
        const targetColumn = this;

        // Prevent status changes in escalated mode
        if (isEscalatedMode) {
          showNotification('Cannot change status in escalated view. Switch to normal view first.', 'error');
          return false;
        }
        
        // Move card immediately in DOM for instant feedback
        if (draggedElement && draggedElement.parentNode !== targetColumn) {
          targetColumn.insertBefore(draggedElement, targetColumn.firstChild);
          
          // Update count badges immediately
          updateColumnCounts();
        }
        
        // Update ticket status via API in background
        fetch(`/api/tickets/${draggedTicketId}/status`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ status: newStatus })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Show success notification only if status actually changed
            if (!data.skipped) {
              showNotification(`Ticket #${draggedTicketId} moved to ${newStatus}`, 'success');
            }
            // If skipped (already in that status), do nothing silently
          } else {
            showNotification('Error: ' + (data.message || 'Failed to update'), 'error');
            // Reload on error to restore correct state
            setTimeout(() => window.location.reload(), 2000);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          showNotification('Network error - please refresh', 'error');
          setTimeout(() => window.location.reload(), 2000);
        });

        return false;
      });
    });

