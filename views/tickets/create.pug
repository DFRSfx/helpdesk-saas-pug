extends ../layout/layout

block content
  .max-w-3xl.mx-auto
    .bg-white.rounded-lg.shadow-sm.border.border-gray-200.p-6.dark_bg-neutral-800.dark_border-neutral-700
      h2.text-2xl.font-bold.text-gray-900.mb-6.dark_text-neutral-200 Create New Ticket

      form#createTicketForm(action="/tickets" method="POST" enctype="multipart/form-data")
        .space-y-6
          //- Subject
          .relative
            input#subject.floating-input(
              class="w-full px-4 pt-6 pb-2 border-2 border-gray-300 rounded-sm bg-white text-gray-900 transition-all duration-200 outline-none focus:border-blue-600 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-200 dark:focus:border-blue-500"
              type="text"
              name="subject"
              data-validate="required|minLength:5|maxLength:200"
              data-label="Subject"
              placeholder=" "
            )
            label.floating-label(for="subject") Subject
            p.error-message.hidden.text-xs.text-red-600.mt-1

          //- Description
          .relative
            textarea#description.floating-input(
              class="w-full px-4 pt-6 pb-2 border-2 border-gray-300 rounded-sm bg-white text-gray-900 transition-all duration-200 outline-none focus:border-blue-600 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-200 dark:focus:border-blue-500"
              name="description"
              rows="6"
              data-validate="required|minLength:10"
              data-label="Description"
              placeholder=" "
            )
            label.floating-label(for="description") Description
            p.error-message.hidden.text-xs.text-red-600.mt-1

          .grid.grid-cols-1.md_grid-cols-2.gap-6
            //- Department
            .relative
              select#department_id.floating-input(
                class="w-full px-4 pt-6 pb-2 border-2 border-gray-300 rounded-sm bg-white text-gray-900 transition-all duration-200 outline-none focus:border-blue-600 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-200 dark:focus:border-blue-500"
                name="department_id"
                data-validate="required"
                data-label="Department"
              )
                option(value="" disabled selected)
                if departments && departments.length > 0
                  each dept in departments
                    option(value=dept.id)= dept.name
                else
                  option(value="" disabled) No departments available
              label.floating-label.select-label(for="department_id") Department
              p.error-message.hidden.text-xs.text-red-600.mt-1

            //- Priority
            .relative
              select#priority.floating-input(
                class="w-full px-4 pt-6 pb-2 border-2 border-gray-300 rounded-sm bg-white text-gray-900 transition-all duration-200 outline-none focus:border-blue-600 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-200 dark:focus:border-blue-500"
                name="priority"
                data-validate="required"
                data-label="Priority"
              )
                option(value="" disabled selected)
                option(value="low") Low
                option(value="medium") Medium
                option(value="high") High
                option(value="urgent") Urgent
              label.floating-label.select-label(for="priority") Priority
              p.error-message.hidden.text-xs.text-red-600.mt-1

          //- Attachments
          div
            label.block.text-sm.font-medium.text-gray-700.mb-2(for="attachments")
              | Attachments
              span.text-gray-500.text-xs.font-normal (Optional)
            input#attachments.w-full.px-4.py-2.border.border-gray-300.rounded-lg.focus_outline-none.focus_ring-2.focus_ring-blue-500.file_py-2.file_px-4.file_border-0.file_text-sm.file_font-semibold.file_bg-blue-50.file_text-blue-700.hover_file_bg-blue-100(
              type="file"
              name="attachments"
              multiple
              accept="image/*,.pdf,.doc,.docx,.txt,.zip"
            )
            p.mt-1.text-xs.text-gray-500
              | Accepted formats: Images, PDF, DOC, DOCX, TXT, ZIP (Max 5MB per file)

          //- Admin/Agent only fields
          if isAdmin() || isAgent()
            .border-t.border-gray-200.pt-6.dark_border-neutral-700
              h3.text-lg.font-semibold.text-gray-900.mb-4.dark_text-neutral-200 Agent Options

              .grid.grid-cols-1.md_grid-cols-2.gap-6
                //- Customer (for creating tickets on behalf of)
                .relative
                  select#customer_id.floating-input(
                    class="w-full px-4 pt-6 pb-2 border-2 border-gray-300 rounded-sm bg-white text-gray-900 transition-all duration-200 outline-none focus:border-blue-600 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-200 dark:focus:border-blue-500"
                    name="customer_id"
                  )
                    option(value="") Create for myself
                    if customers && customers.length > 0
                      each customer in customers
                        option(value=customer.id)= customer.name + ' (' + customer.email + ')'
                  label.floating-label.select-label(for="customer_id") Customer (Optional)

                //- Assign to agent
                .relative
                  select#assigned_agent_id.floating-input(
                    class="w-full px-4 pt-6 pb-2 border-2 border-gray-300 rounded-sm bg-white text-gray-900 transition-all duration-200 outline-none focus:border-blue-600 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-200 dark:focus:border-blue-500"
                    name="assigned_agent_id"
                  )
                    option(value="") Unassigned
                    if agents && agents.length > 0
                      each agent in agents
                        option(value=agent.id)= agent.name
                  label.floating-label.select-label(for="assigned_agent_id") Assign To (Optional)

                //- Initial status
                .relative
                  select#status.floating-input(
                    class="w-full px-4 pt-6 pb-2 border-2 border-gray-300 rounded-sm bg-white text-gray-900 transition-all duration-200 outline-none focus:border-blue-600 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-200 dark:focus:border-blue-500"
                    name="status"
                  )
                    option(value="open" selected) Open
                    option(value="in_progress") In Progress
                    option(value="resolved") Resolved
                    option(value="closed") Closed
                  label.floating-label.select-label(for="status") Status

          //- Submit buttons
          .flex.items-center.justify-end.space-x-4.pt-6.border-t.border-gray-200
            a.px-6.py-2.border.border-gray-300.text-gray-700.rounded-lg.hover_bg-gray-50.transition-colors(href="/tickets")
              | Cancel
            button.px-6.py-2.bg-blue-600.text-white.rounded-lg.hover_bg-blue-700.transition-colors(type="submit")
              | Create Ticket

block scripts
  style.
    .floating-input::placeholder {
      color: transparent;
    }

    /* Default label state - centered in input */
    .floating-label {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1rem;
      line-height: 1;
      color: #737373;
      font-weight: 500;
      transition: all 0.2s ease;
      pointer-events: none;
    }

    /* Label moves to top when input is focused or has value */
    .floating-input:focus ~ .floating-label,
    .floating-input:not(:placeholder-shown) ~ .floating-label,
    select.floating-input:valid ~ .floating-label.select-label,
    textarea.floating-input:not(:placeholder-shown) ~ .floating-label {
      top: 0.375rem;
      transform: translateY(0);
      font-size: 0.75rem;
    }

    /* Blue color when focused */
    .floating-input:focus ~ .floating-label {
      color: #2563eb;
    }

    /* Gray color when has value but not focused */
    .floating-input:not(:focus):not(:placeholder-shown) ~ .floating-label,
    select.floating-input:not(:focus):valid ~ .floating-label.select-label {
      color: #737373;
    }

    /* Error state styling */
    .floating-input.error {
      border-color: #dc2626 !important;
    }

    .floating-input.error:focus {
      border-color: #dc2626 !important;
      box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
    }

    .floating-input.error:focus ~ .floating-label {
      color: #dc2626;
    }

    /* Valid state styling */
    .floating-input.valid:not(:focus) {
      border-color: #16a34a;
    }

    /* Error message styling */
    .error-message {
      color: #dc2626;
      font-size: 0.75rem;
      margin-top: 0.25rem;
    }

    .error-message.hidden {
      display: none;
    }

    /* For textareas, adjust label position when it has content */
    textarea.floating-input {
      resize: vertical;
    }

  script(src="/js/form-validator.js")
  script.
    // Initialize form validator
    new FormValidator('#createTicketForm');

    // Auto-resize textarea
    const textarea = document.getElementById('description');
    if (textarea) {
      textarea.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
      });
    }

    // File upload validation
    const fileInput = document.getElementById('attachments');
    if (fileInput) {
      fileInput.addEventListener('change', function() {
        const files = Array.from(this.files);
        const maxSize = 5 * 1024 * 1024; // 5MB

        for (let file of files) {
          if (file.size > maxSize) {
            alert(`File "${file.name}" exceeds 5MB limit`);
            this.value = '';
            return;
          }
        }
      });
    }
