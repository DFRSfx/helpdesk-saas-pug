extends ../layout/customer-layout

block content
  .flex.h-screen.bg-white.overflow-hidden
    //- LEFT SIDEBAR: Ticket List
    .w-80.flex.flex-col.border-r.border-gray-200.bg-gray-50
      //- Sidebar Header & Search
      .p-4.border-b.border-gray-200.bg-white
        .flex.items-center.justify-between.mb-4
          h2.text-xl.font-bold.text-gray-800 Inbox
          a.text-gray-400.hover_text-gray-600.transition-colors(href="/dashboard" title="Back to Dashboard")
            svg.w-5.h-5(fill="none" stroke="currentColor" viewBox="0 0 24 24")
              path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6")

        .relative.flex.items-center
          svg(class="absolute w-4 h-4 text-gray-400 pointer-events-none" style="left: 12px;" fill="none" stroke="currentColor" viewBox="0 0 24 24")
            path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z")
          input.w-full.bg-gray-100.border.border-transparent.text-gray-900.placeholder-gray-500.rounded-lg.focus_bg-white.focus_border-blue-500.focus_ring-2.focus_ring-blue-200.transition-all.text-sm#ticketSearch(
            type="text"
            placeholder="Search tickets..."
            autocomplete="off"
            style="padding-left: 40px; padding-right: 16px; padding-top: 8px; padding-bottom: 8px;"
          )

      //- Ticket List Container
      .flex-1.overflow-y-auto.p-2.space-y-1
        if tickets && tickets.length > 0
          each ticket in tickets
            - const isSelected = selectedTicketId === ticket.id
            div.group.flex.flex-col.p-3.rounded-lg.cursor-pointer.transition-all.border(
              class=`ticket-item ${isSelected ? 'bg-white border-blue-500 shadow-md ring-1 ring-blue-500/20 z-10' : 'bg-transparent border-transparent hover:bg-gray-100 hover:border-gray-200'}`
              data-ticket-id=`${ticket.id}`
              onclick=`selectTicket(${ticket.id})`
            )
              .flex.justify-between.items-start.mb-1
                span.text-xs.font-mono.text-gray-400 ##{ticket.id}
                span(class="text-xs font-medium text-gray-400")= new Date(ticket.created_at).toLocaleDateString(undefined, {month:'short', day:'numeric'})
              
              h4.text-sm.font-semibold.text-gray-900.line-clamp-2.mb-2(class=isSelected ? 'text-blue-700' : '')= ticket.subject
              
              .flex.items-center.justify-between
                //- Mini Status Badge
                - const statusColors = { open: 'bg-blue-100 text-blue-700', in_progress: 'bg-amber-100 text-amber-700', resolved: 'bg-green-100 text-green-700', closed: 'bg-gray-100 text-gray-600', waiting: 'bg-purple-100 text-purple-700' }
                span(class="px-2 py-0.5 rounded-full text-xs font-bold uppercase tracking-wide " + statusColors[ticket.status])
                  = ticket.status.replace('_', ' ')
                
                if ticket.priority === 'urgent' || ticket.priority === 'high'
                   svg.w-4.h-4.text-red-500(fill="currentColor" viewBox="0 0 20 20" title="High Priority")
                     path(d="M18 3a1 1 0 00-1.447-.894L8.763 6H5a3 3 0 000 6h.28l1.771 5.316A1 1 0 008 18h1a1 1 0 001-1v-4.382l6.553 3.276A1 1 0 0018 15V3z")

        else
          .flex.flex-col.items-center.justify-center.h-48.text-center
            .w-12.h-12.bg-gray-100.rounded-full.flex.items-center.justify-center.mb-3
              svg.w-6.h-6.text-gray-400(fill="none" stroke="currentColor" viewBox="0 0 24 24"): path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4")
            p.text-sm.text-gray-500 No tickets found

      .p-4.border-t.border-gray-200.bg-white
        a.flex.items-center.justify-center.w-full.px-4.py-2.bg-blue-600.text-white.text-sm.font-medium.rounded-lg.hover_bg-blue-700.transition-colors(href="/tickets/create")
          svg.w-4.h-4.mr-2(fill="none" stroke="currentColor" viewBox="0 0 24 24"): path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4")
          | Create New Ticket

    //- RIGHT MAIN: Conversation Area
    .flex-1.flex.flex-col.bg-white.relative
      if tickets && tickets.length > 0
        //- 1. Main Header
        header.px-6.py-4.border-b.border-gray-100.flex.justify-between.items-start.bg-white.z-10.flex-shrink-0
          div
            .flex.items-center.gap-3.mb-1
              h1.text-xl.font-bold.text-gray-900#ticketTitle= tickets[0].subject
              span#ticketStatus(class="px-2 py-0.5 rounded-full text-xs font-bold uppercase bg-gray-100 text-gray-800") Loading...
            p.text-sm.text-gray-500 Ticket ##{tickets[0].id}

          //- 2. Compact Metadata Strip (Replaces bulky cards)
          .hidden.md_flex.items-center.gap-6.text-sm.text-gray-500
            .flex.items-center.gap-2
              svg.w-4.h-4.text-gray-400(fill="none" stroke="currentColor" viewBox="0 0 24 24"): path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z")
              span Priority:
              span.font-medium.text-gray-900#ticketPriority= tickets[0].priority.toUpperCase()
            .w-px.h-4.bg-gray-200
            .flex.items-center.gap-2
              svg.w-4.h-4.text-gray-400(fill="none" stroke="currentColor" viewBox="0 0 24 24"): path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4")
              span Dept:
              span.font-medium.text-gray-900#ticketDepartment= tickets[0].department_name || 'General'
            .w-px.h-4.bg-gray-200
            .flex.items-center.gap-2
              svg.w-4.h-4.text-gray-400(fill="none" stroke="currentColor" viewBox="0 0 24 24"): path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z")
              span.font-medium.text-gray-900#ticketCreated= new Date(tickets[0].created_at).toLocaleDateString()

        //- 3. Context / Description (Collapsible style visually)
        .px-6.py-3.bg-gray-50.border-b.border-gray-200.flex-shrink-0.overflow-y-auto
          .flex.flex-col.gap-4
            .flex.items-start.gap-3
              div.flex-shrink-0.pt-1
                .w-6.h-6.rounded-full.bg-gray-200.flex.items-center.justify-center.text-gray-500
                  svg.w-3.h-3(fill="none" stroke="currentColor" viewBox="0 0 24 24"): path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z")
              p.text-sm.text-gray-600.leading-relaxed#ticketDescription= tickets[0].description || 'No description provided.'

            //- Attachments Section
            div#attachmentsSection

        //- 4. Chat Area (takes remaining space and scrolls)
        .flex-1.overflow-y-auto.px-2.py-2#messagesArea.chat-area
          //- Loading state
          .flex.justify-center.py-10
            svg.animate-spin.h-6.w-6.text-blue-600(fill="none" viewBox="0 0 24 24")
              circle.opacity-25(cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4")
              path.opacity-75(fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z")

        //- 5. Input Area (fixed at bottom, does not scroll)
        .px-6.py-4.border-t.border-gray-200.bg-white.flex-shrink-0
          //- Attachment preview area
          #attachmentPreview.mb-3

          .flex.gap-2.items-end
            //- File input (hidden)
            input#fileInput(type="file" multiple style="display: none" accept="*/*")

            //- Attachment button
            button.flex-shrink-0.p-2.text-gray-600.hover_text-blue-600.hover_bg-gray-100.rounded-lg.transition-colors(type="button" onclick="document.getElementById('fileInput').click()" title="Add attachments")
              svg.w-6.h-6(fill="none" stroke="currentColor" viewBox="0 0 24 24")
                path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 002.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.414a6 6 0 008.485 8.485l6.414-6.414")

            .relative.flex-1
              textarea.w-full.px-4.py-3.bg-gray-100.text-gray-900.rounded-2xl.focus_bg-gray-50.focus_outline-none.focus_ring-2.focus_ring-blue-500.resize-none.transition-all.discord-input(
                id="messageInput"
                placeholder="Message #general"
                rows="1"
                style="min-height: 44px; max-height: 150px;"
                oninput="this.style.height = '44px'; this.style.height = Math.min(this.scrollHeight, 150) + 'px'"
              )

            //- Send button
            button.flex-shrink-0.p-2.text-blue-600.hover_text-white.hover_bg-blue-600.rounded-lg.transition-colors.focus_outline-none(type="button" onclick="sendMessage()" title="Send message")
              svg.w-6.h-6(fill="currentColor" viewBox="0 0 24 24")
                path(d="M16.6915026,12.4744748 L3.50612381,13.2599618 C3.19218622,13.2599618 3.03521743,13.4170592 3.03521743,13.5741566 L1.15159189,20.0151496 C0.8376543,20.8006365 0.99,21.89 1.77946707,22.52 C2.41,22.99 3.50612381,23.1 4.13399899,22.9429026 L21.714504,14.0454487 C22.6563168,13.5741566 23.1272231,12.6315722 22.9702544,11.6889879 L4.13399899,1.10059969 C3.34915502,0.9 2.40734225,0.9 1.77946707,1.4429026 C0.994623095,2.10604706 0.837654308,3.0486314 1.15159189,3.99021575 L3.03521743,10.4311088 C3.03521743,10.5882061 3.34915502,10.7453035 3.50612381,10.7453035 L16.6915026,11.5308903 C16.6915026,11.5308903 17.1624089,11.5308903 17.1624089,12.0024328 C17.1624089,12.4744748 16.6915026,12.4744748 16.6915026,12.4744748 Z")

            //- Emoji button (optional, can be styled)
            button.flex-shrink-0.p-2.text-gray-600.hover_text-blue-600.hover_bg-gray-100.rounded-lg.transition-colors.hidden(type="button" title="Add emoji")
              svg.w-6.h-6(fill="none" stroke="currentColor" viewBox="0 0 24 24")
                path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z")

      else
        //- Empty State (No tickets selected/exist)
        .flex.flex-col.items-center.justify-center.h-full.bg-gray-50
          .w-24.h-24.bg-white.rounded-full.shadow-sm.flex.items-center.justify-center.mb-6
            svg.w-10.h-10.text-blue-500(fill="none" stroke="currentColor" viewBox="0 0 24 24"): path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z")
          h3.text-xl.font-bold.text-gray-900 No Ticket Selected
          p.text-gray-500.mt-2 Select a ticket from the sidebar or create a new one.
          a.mt-6.px-6.py-2.bg-blue-600.text-white.font-semibold.rounded-lg.hover_bg-blue-700.transition-colors(href="/tickets/create") Create Ticket

block scripts
  style.
    .message-row {
      transition: background-color 0.15s ease-in-out;
    }

    /* Discord-style input field */
    .discord-input {
      background-color: #f0f2f5;
      border: none;
      font-family: inherit;
    }

    .discord-input:focus {
      background-color: #fff;
    }

    .discord-input::placeholder {
      color: #949ba4;
    }

  script
  script.
    let currentSelectedTicketId = #{selectedTicketId ? selectedTicketId : 'null'};
    const tickets = !{JSON.stringify(tickets)};
    const currentUser = !{JSON.stringify(currentUser)};
    let selectedFiles = [];

    document.addEventListener('DOMContentLoaded', function() {
      if (currentSelectedTicketId === null && tickets.length > 0) {
        currentSelectedTicketId = tickets[0].id;
      }
      if (currentSelectedTicketId !== null) {
        selectTicket(currentSelectedTicketId);
      }

      // File input change handler
      document.getElementById('fileInput').addEventListener('change', function(e) {
        selectedFiles = Array.from(e.target.files);
        updateAttachmentPreview();
      });

      // Search input handler
      document.getElementById('ticketSearch').addEventListener('input', function(e) {
        filterTickets(e.target.value.toLowerCase());
      });
    });

    function filterTickets(searchTerm) {
      const ticketItems = document.querySelectorAll('.ticket-item');
      ticketItems.forEach(item => {
        const ticketId = item.getAttribute('data-ticket-id');
        const ticket = tickets.find(t => t.id === parseInt(ticketId));
        if (!ticket) return;

        const subject = ticket.subject.toLowerCase();
        const id = ticket.id.toString();
        const matches = subject.includes(searchTerm) || id.includes(searchTerm);

        item.style.display = matches ? '' : 'none';
      });
    }

    function selectTicket(ticketId) {
      window.history.replaceState({}, '', `/tickets/portal?ticketId=${ticketId}`);

      // Reset styles for all items
      document.querySelectorAll('.ticket-item').forEach(item => {
        item.classList.remove('bg-white', 'border-blue-500', 'shadow-md', 'ring-1', 'ring-blue-500/20', 'z-10');
        item.classList.add('bg-transparent', 'border-transparent', 'hover:bg-gray-100');
      });

      // Highlight selected
      const selectedItem = document.querySelector(`[data-ticket-id="${ticketId}"]`);
      if (selectedItem) {
        selectedItem.classList.remove('bg-transparent', 'border-transparent', 'hover:bg-gray-100');
        selectedItem.classList.add('bg-white', 'border-blue-500', 'shadow-md', 'ring-1', 'ring-blue-500/20', 'z-10');
      }

      currentSelectedTicketId = ticketId;
      const ticket = tickets.find(t => t.id === ticketId);
      if (!ticket) return;

      // Update Header Data
      document.getElementById('ticketTitle').textContent = ticket.subject;
      
      // Update Status Badge with modern colors
      const statusColors = {
        'open': 'bg-blue-100 text-blue-700',
        'in_progress': 'bg-amber-100 text-amber-700',
        'resolved': 'bg-green-100 text-green-700',
        'closed': 'bg-gray-100 text-gray-600',
        'waiting': 'bg-purple-100 text-purple-700'
      };
      const statusEl = document.getElementById('ticketStatus');
      statusEl.className = `px-2.5 py-0.5 rounded-full text-xs font-bold uppercase tracking-wide ${statusColors[ticket.status] || 'bg-gray-100 text-gray-800'}`;
      statusEl.textContent = ticket.status.replace('_', ' ');

      // Update Metadata Strip
      document.getElementById('ticketPriority').textContent = ticket.priority.toUpperCase();
      document.getElementById('ticketCreated').textContent = new Date(ticket.created_at).toLocaleDateString();
      document.getElementById('ticketDepartment').textContent = ticket.department_name || 'General';
      
      const descEl = document.getElementById('ticketDescription');
      if(descEl) descEl.textContent = ticket.description || 'No description provided.';

      loadMessages(ticketId);
    }

    function canAccessAttachment(attachment) {
      // Admin and agents can always access
      if (currentUser.role === 'admin' || currentUser.role === 'agent') {
        return true;
      }
      // Customers can only access attachments they uploaded
      if (currentUser.role === 'customer') {
        return attachment.uploaded_by === currentUser.id;
      }
      return false;
    }

    function renderAttachments(attachments) {
      const section = document.getElementById('attachmentsSection');
      section.innerHTML = '';

      console.log('renderAttachments called with:', attachments);

      if (!attachments || attachments.length === 0) {
        console.log('No attachments to display');
        return;
      }

      const container = document.createElement('div');
      container.className = 'mt-3 pt-3 border-t border-gray-200';

      const title = document.createElement('p');
      title.className = 'text-xs font-semibold text-gray-600 uppercase mb-2 tracking-wide';
      title.textContent = 'Attachments';
      container.appendChild(title);

      const list = document.createElement('div');
      list.className = 'space-y-1';

      attachments.forEach(att => {
        const hasAccess = canAccessAttachment(att);
        let fileSize = 'Unknown size';
        if (att.file_size) {
          fileSize = att.file_size > 1024 ? `${(att.file_size / 1024).toFixed(2)} KB` : `${att.file_size} B`;
        }
        const fileName = att.original_name || att.file_path;
        const uploaderName = att.uploader_name || 'Unknown';

        const item = document.createElement('div');
        item.className = 'flex items-center gap-2 p-2 rounded transition-colors';

        if (hasAccess) {
          item.className += ' hover:bg-gray-100 cursor-pointer';
          const link = document.createElement('a');
          link.href = `/uploads/tickets/${att.file_path}`;
          link.target = '_blank';
          link.className = 'flex items-center gap-2 flex-1 text-blue-600 hover:text-blue-700';

          link.innerHTML = `
            <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            <div class="flex-1 min-w-0">
              <p class="text-sm truncate">${escapeHtml(fileName)}</p>
              <p class="text-xs text-gray-500">${fileSize} • by ${escapeHtml(uploaderName)}</p>
            </div>
          `;
          item.appendChild(link);
        } else {
          // Show locked attachment for users without access
          item.className += ' bg-gray-50 text-gray-500 cursor-not-allowed';

          item.innerHTML = `
            <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
            </svg>
            <div class="flex-1 min-w-0">
              <p class="text-sm truncate">${escapeHtml(fileName)}</p>
              <p class="text-xs text-gray-500">${fileSize} • by ${escapeHtml(uploaderName)}</p>
            </div>
            <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4.242 4.242a4 4 0 105.656 5.656l4.242-4.242"></path>
            </svg>
          `;
          item.title = 'Only the uploader, admins, and agents can access this file';
        }

        list.appendChild(item);
      });

      container.appendChild(list);
      section.appendChild(container);
    }

    function loadMessages(ticketId) {
      Promise.all([
        fetch(`/api/tickets/${ticketId}/messages`).then(res => res.json()),
        fetch(`/api/tickets/${ticketId}`).then(res => res.json()).catch(() => ({ ticket: {} }))
      ])
      .then(([messagesData, ticketData]) => {
        console.log('Ticket data:', ticketData);
        const messagesArea = document.getElementById('messagesArea');
        messagesArea.innerHTML = '';

        // Render attachments at the top
        if (ticketData.ticket && ticketData.ticket.attachments) {
          console.log('Rendering attachments:', ticketData.ticket.attachments);
          renderAttachments(ticketData.ticket.attachments);
        } else {
          console.log('No attachments in ticket data');
        }

        if (messagesData.messages && messagesData.messages.length > 0) {
          // Display messages and attachment messages
          messagesData.messages.forEach(msg => {
            // Handle attachment messages
            if (msg.is_attachment) {
              // Check if user can access this attachment
              const canAccess = currentUser.role === 'admin' || currentUser.role === 'agent' || msg.user_id === currentUser.id;

              const msgDiv = document.createElement('div');
              msgDiv.className = 'flex mb-4 justify-center';

              const time = new Date(msg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
              const date = new Date(msg.created_at).toLocaleDateString();

              if (canAccess) {
                msgDiv.innerHTML = `
                  <div class="flex flex-col items-center max-w-[70%]">
                    <div class="flex items-center gap-2 text-gray-500 text-xs mb-1">
                      <div class="flex-1 h-px bg-gray-200"></div>
                      <span class="px-2">${time}</span>
                      <div class="flex-1 h-px bg-gray-200"></div>
                    </div>
                    <div class="flex items-center gap-2 p-3 bg-blue-50 border border-blue-200 rounded-lg hover:bg-blue-100 transition-colors">
                      <svg class="w-4 h-4 text-blue-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                      </svg>
                      <a href="${msg.file_url}" target="_blank" class="text-blue-600 hover:text-blue-700 text-sm font-medium truncate">
                        ${escapeHtml(msg.file_name)} (${msg.file_size})
                      </a>
                      <span class="text-xs text-gray-600 flex-shrink-0">by ${escapeHtml(msg.user_name)}</span>
                    </div>
                  </div>
                `;
              } else {
                msgDiv.innerHTML = `
                  <div class="flex flex-col items-center max-w-[70%]">
                    <div class="flex items-center gap-2 text-gray-500 text-xs mb-1">
                      <div class="flex-1 h-px bg-gray-200"></div>
                      <span class="px-2">${time}</span>
                      <div class="flex-1 h-px bg-gray-200"></div>
                    </div>
                    <div class="flex items-center gap-2 p-3 bg-gray-100 border border-gray-300 rounded-lg cursor-not-allowed">
                      <svg class="w-4 h-4 text-gray-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                      </svg>
                      <span class="text-gray-600 text-sm font-medium truncate">
                        ${escapeHtml(msg.file_name)}
                      </span>
                      <span class="text-xs text-gray-500 flex-shrink-0">by ${escapeHtml(msg.user_name)}</span>
                    </div>
                  </div>
                `;
              }
              messagesArea.appendChild(msgDiv);
            } else {
              // Regular text messages
              const msgDiv = document.createElement('div');
              const isOwn = msg.isOwn;
              const time = new Date(msg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
              const isEdited = msg.is_edited;

              msgDiv.className = `message-row group px-4 py-3 mb-3 hover:bg-gray-100 rounded transition-colors`;
              msgDiv.setAttribute('data-message-id', msg.id);

              // Discord-style message with avatar and username
              msgDiv.innerHTML = `
                <div class="flex gap-3 items-start">
                  <div class="flex-shrink-0 mt-0.5">
                    <div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center text-white font-semibold text-xs">
                      ${(msg.user_name || 'U').charAt(0).toUpperCase()}
                    </div>
                  </div>
                  <div class="flex-1 min-w-0">
                    <div class="flex items-baseline gap-2">
                      <span class="font-semibold text-gray-900 text-sm">${escapeHtml(msg.user_name || 'Unknown')}</span>
                      <span class="text-xs text-gray-500">${time}</span>
                    </div>
                    <p class="text-gray-800 text-sm leading-relaxed break-words whitespace-pre-wrap">${escapeHtml(msg.content)}</p>
                  </div>
                  ${isOwn ? `
                    <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity flex-shrink-0 ml-2">
                      <button class="edit-btn text-gray-500 hover:text-gray-700 p-1" aria-label="Edit">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                          <path d="m13.96 5.46 4.58 4.58a1 1 0 0 0 1.42 0l1.38-1.38a2 2 0 0 0 0-2.82l-3.18-3.18a2 2 0 0 0-2.82 0l-1.38 1.38a1 1 0 0 0 0 1.42ZM2.11 20.16l.73-4.22a3 3 0 0 1 .83-1.61l7.87-7.87a1 1 0 0 1 1.42 0l4.58 4.58a1 1 0 0 1 0 1.42l-7.87 7.87a3 3 0 0 1-1.6.83l-4.23.73a1.5 1.5 0 0 1-1.73-1.73Z"></path>
                        </svg>
                      </button>
                      <button class="delete-btn text-gray-500 hover:text-red-600 p-1" aria-label="Delete">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                          <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zm2.46-7l1.41-1.41L12 10.59l2.12-2.12 1.41 1.41L13.41 12l2.12 2.12-1.41 1.41L12 13.41l-2.12 2.12-1.41-1.41L10.59 12 8.46 9.88zM15.5 4l-1-1h-5l-1 1H5v2h14V4z"></path>
                        </svg>
                      </button>
                    </div>
                  ` : ''}
                </div>
              `;
              messagesArea.appendChild(msgDiv);
            }
          });
        } else {
          messagesArea.innerHTML = `
            <div class="h-full flex flex-col items-center justify-center text-gray-400">
              <svg class="w-12 h-12 mb-2 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
              <p>Start the conversation</p>
            </div>`;
        }
        // Add event listeners for edit button
        document.querySelectorAll('.edit-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const messageId = this.closest('[data-message-id]').getAttribute('data-message-id');
            startEditMessage(parseInt(messageId));
          });
        });

        // Delete button handlers
        document.querySelectorAll('.delete-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const messageId = this.closest('[data-message-id]').getAttribute('data-message-id');
            deleteMessage(parseInt(messageId));
          });
        });

        messagesArea.scrollTop = messagesArea.scrollHeight;
      })
      .catch(err => {
        console.error(err);
        document.getElementById('messagesArea').innerHTML = '<p class="text-center text-red-500 mt-4 text-sm">Failed to load messages.</p>';
      });
    }

    function updateAttachmentPreview() {
      const preview = document.getElementById('attachmentPreview');
      preview.innerHTML = '';

      if (selectedFiles.length === 0) return;

      const container = document.createElement('div');
      container.className = 'flex flex-wrap gap-2 mb-3';

      selectedFiles.forEach((file, index) => {
        const fileSize = (file.size / 1024).toFixed(2); // Convert to KB
        const item = document.createElement('div');
        item.className = 'flex items-center gap-2 px-3 py-2 bg-blue-50 border border-blue-200 rounded-lg text-sm text-gray-700';
        item.innerHTML = `
          <svg class="w-4 h-4 text-blue-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
          <div class="flex-1 min-w-0">
            <p class="truncate font-medium">${escapeHtml(file.name)}</p>
            <p class="text-xs text-gray-500">${fileSize} KB</p>
          </div>
          <button type="button" onclick="removeFile(${index})" class="p-1 hover:bg-blue-100 rounded transition-colors" title="Remove file">
            <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        `;
        container.appendChild(item);
      });

      preview.appendChild(container);
    }

    function removeFile(index) {
      selectedFiles.splice(index, 1);
      // Reset file input
      document.getElementById('fileInput').value = '';
      updateAttachmentPreview();
    }

    function sendMessage() {
      const input = document.getElementById('messageInput');
      const message = input.value.trim();

      if (!message && selectedFiles.length === 0) {
        alert('Please type a message or attach a file');
        return;
      }

      const formData = new FormData();
      formData.append('content', message);

      // Add files to FormData
      selectedFiles.forEach(file => {
        formData.append('attachments', file);
      });

      fetch(`/api/tickets/${currentSelectedTicketId}/messages`, {
        method: 'POST',
        body: formData
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          input.value = '';
          input.style.height = 'auto'; // Reset height
          selectedFiles = [];
          document.getElementById('fileInput').value = '';
          updateAttachmentPreview();
          loadMessages(currentSelectedTicketId);
        } else {
          alert('Error sending message: ' + (data.message || 'Unknown error'));
        }
      })
      .catch(err => {
        console.error(err);
        alert('Failed to send message');
      });
    }

    function escapeHtml(text) {
      if(!text) return '';
      return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }

    let editingMessageId = null;
    let editingMessageOriginal = null;

    function startEditMessage(messageId) {
      const messageRow = document.querySelector(`[data-message-id="${messageId}"]`);
      if (!messageRow) return;

      // Find the message text content (paragraph element)
      const textElement = messageRow.querySelector('p');
      if (!textElement) return;

      const originalText = textElement.textContent;
      editingMessageId = messageId;
      editingMessageOriginal = originalText;

      // Replace paragraph with textarea for editing
      const editForm = document.createElement('div');
      editForm.innerHTML = `
        <textarea id="editInput" class="w-full p-2 border border-gray-300 rounded text-gray-900 text-sm resize-none" style="min-height: 60px; max-height: 120px;"></textarea>
        <div class="flex gap-2 mt-2">
          <button class="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 transition-colors" onclick="saveEditMessage()">
            Save
          </button>
          <button class="px-3 py-1 bg-gray-300 text-gray-800 text-sm rounded hover:bg-gray-400 transition-colors" onclick="cancelEditMessage()">
            Cancel
          </button>
        </div>
      `;

      textElement.replaceWith(editForm);

      // Focus and select text
      setTimeout(() => {
        const input = document.getElementById('editInput');
        if (input) {
          input.value = originalText;
          input.focus();
          input.select();
        }
      }, 0);
    }

    function cancelEditMessage() {
      editingMessageId = null;
      editingMessageOriginal = null;
      loadMessages(currentSelectedTicketId);
    }

    function saveEditMessage() {
      const input = document.getElementById('editInput');
      if (!input) return;

      const newText = input.value.trim();

      if (!newText) {
        alert('Message cannot be empty');
        return;
      }

      if (newText === editingMessageOriginal) {
        cancelEditMessage();
        return;
      }

      const messageId = editingMessageId;
      editingMessageId = null;
      editingMessageOriginal = null;

      fetch(`/api/messages/${messageId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content: newText })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          loadMessages(currentSelectedTicketId);
        } else {
          alert('Error editing message: ' + (data.message || 'Unknown error'));
        }
      })
      .catch(err => {
        console.error(err);
        alert('Failed to edit message');
      });
    }

    function deleteMessage(messageId) {
      if (!confirm('Are you sure you want to delete this message?')) {
        return;
      }

      // Soft delete by editing to "[deleted]"
      fetch(`/api/messages/${messageId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content: '[deleted]' })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          loadMessages(currentSelectedTicketId);
        } else {
          alert('Error deleting message');
        }
      })
      .catch(err => {
        console.error(err);
        alert('Failed to delete message');
      });
    }