extends ../layout/layout

block content
  //- Include reusable confirmation modal
  include ../partials/modal

  .max-w-3xl.mx-auto
    .bg-white.rounded-lg.shadow-sm.border.border-gray-200.p-6.dark_bg-neutral-800.dark_border-neutral-700
      .flex.items-center.justify-between.mb-6
        h2.text-2xl.font-bold.text-gray-900.dark_text-neutral-200 Edit Ticket ##{ticket.id}
        a.text-blue-600.hover_text-blue-800.dark_text-blue-400.dark_hover_text-blue-300(href=`/tickets/${ticket.id}`) View Ticket

      form(action=`/tickets/${ticket.id}` method="POST")
        input(type="hidden" name="_method" value="PUT")

        .space-y-6
          //- Subject
          .relative
            input#subject.floating-input(
              class="w-full px-4 pt-6 pb-2 border-2 border-gray-300 rounded-sm bg-white text-gray-900 transition-all duration-200 outline-none focus:border-blue-600 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-200 dark:focus:border-blue-500"
              type="text"
              name="subject"
              value=ticket.subject
              required
              maxlength="200"
              placeholder=" "
            )
            label.floating-label(for="subject") Subject

          //- Description
          .relative
            textarea#description.floating-input(
              class="w-full px-4 pt-6 pb-2 border-2 border-gray-300 rounded-sm bg-white text-gray-900 transition-all duration-200 outline-none focus:border-blue-600 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-200 dark:focus:border-blue-500"
              name="description"
              rows="6"
              required
              placeholder=" "
            )= ticket.description
            label.floating-label(for="description") Description
            p.mt-1.text-xs.text-gray-500.dark_text-neutral-400 Supports Markdown formatting

          .grid.grid-cols-1.md_grid-cols-2.gap-6
            //- Status
            .relative
              select#status.floating-input(
                class="w-full px-4 pt-6 pb-2 border-2 border-gray-300 rounded-sm bg-white text-gray-900 transition-all duration-200 outline-none focus:border-blue-600 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-200 dark:focus:border-blue-500"
                name="status"
                required
              )
                option(value="open" selected=ticket.status === "open") Open
                option(value="in_progress" selected=ticket.status === "in_progress") In Progress
                option(value="resolved" selected=ticket.status === "resolved") Resolved
                option(value="closed" selected=ticket.status === "closed") Closed
              label.floating-label.select-label(for="status") Status

            //- Priority
            .relative
              select#priority.floating-input(
                class="w-full px-4 pt-6 pb-2 border-2 border-gray-300 rounded-sm bg-white text-gray-900 transition-all duration-200 outline-none focus:border-blue-600 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-200 dark:focus:border-blue-500"
                name="priority"
                required
              )
                option(value="low" selected=ticket.priority === "low") Low
                option(value="medium" selected=ticket.priority === "medium") Medium
                option(value="high" selected=ticket.priority === "high") High
                option(value="urgent" selected=ticket.priority === "urgent") Urgent
              label.floating-label.select-label(for="priority") Priority

            //- Department
            .relative
              select#department_id.floating-input(
                class="w-full px-4 pt-6 pb-2 border-2 border-gray-300 rounded-sm bg-white text-gray-900 transition-all duration-200 outline-none focus:border-blue-600 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-200 dark:focus:border-blue-500"
                name="department_id"
                required
              )
                if departments && departments.length > 0
                  each dept in departments
                    option(value=dept.id selected=ticket.department_id == dept.id)= dept.name
                else
                  option(value="" disabled) No departments available
              label.floating-label.select-label(for="department_id") Department

            if isAdmin() || isAgent()
              //- Assigned Agent
              .relative
                select#assigned_agent_id.floating-input(
                  class="w-full px-4 pt-6 pb-2 border-2 border-gray-300 rounded-sm bg-white text-gray-900 transition-all duration-200 outline-none focus:border-blue-600 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-200 dark:focus:border-blue-500"
                  name="assigned_agent_id"
                )
                  option(value="" selected=!ticket.assigned_agent_id) Unassigned
                  if agents && agents.length > 0
                    each agent in agents
                      option(value=agent.id selected=ticket.assigned_agent_id == agent.id)= agent.name
                label.floating-label.select-label(for="assigned_agent_id") Assign To

          //- Customer (Admin only - can reassign)
          if isAdmin()
            .relative
              select#customer_id.floating-input(
                class="w-full px-4 pt-6 pb-2 border-2 border-gray-300 rounded-sm bg-white text-gray-900 transition-all duration-200 outline-none focus:border-blue-600 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-200 dark:focus:border-blue-500"
                name="customer_id"
                required
              )
                if customers && customers.length > 0
                  each customer in customers
                    option(value=customer.id selected=ticket.customer_id == customer.id)= customer.name + ' (' + customer.email + ')'
              label.floating-label.select-label(for="customer_id") Customer

          //- Escalation (Agent/Admin only)
          if isAdmin() || isAgent()
            .border-t.border-gray-200.pt-6.dark_border-neutral-700
              h3.text-lg.font-semibold.text-gray-900.mb-4.dark_text-neutral-200 Escalation

              .grid.grid-cols-1.md_grid-cols-2.gap-6
                .relative
                  select#escalation_level.floating-input(
                    class="w-full px-4 pt-6 pb-2 border-2 border-gray-300 rounded-sm bg-white text-gray-900 transition-all duration-200 outline-none focus:border-blue-600 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-200 dark:focus:border-blue-500"
                    name="escalation_level"
                  )
                    option(value="0" selected=ticket.escalation_level === 0) None
                    option(value="1" selected=ticket.escalation_level === 1) Level 1
                    option(value="2" selected=ticket.escalation_level === 2) Level 2
                    option(value="3" selected=ticket.escalation_level === 3) Level 3
                  label.floating-label.select-label(for="escalation_level") Escalation Level

                if ticket.escalation_level > 0
                  .relative
                    select#escalated_to_id.floating-input(
                      class="w-full px-4 pt-6 pb-2 border-2 border-gray-300 rounded-sm bg-white text-gray-900 transition-all duration-200 outline-none focus:border-blue-600 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-200 dark:focus:border-blue-500"
                      name="escalated_to_id"
                    )
                      option(value="") None
                      if agents && agents.length > 0
                        each agent in agents
                          option(value=agent.id selected=ticket.escalated_to_id == agent.id)= agent.name
                    label.floating-label.select-label(for="escalated_to_id") Escalated To

          //- Internal notes
          if isAdmin() || isAgent()
            .relative
              textarea#internal_notes.floating-input(
                class="w-full px-4 pt-6 pb-2 border-2 border-gray-300 rounded-sm bg-white text-gray-900 transition-all duration-200 outline-none focus:border-blue-600 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-200 dark:focus:border-blue-500"
                name="internal_notes"
                rows="4"
                placeholder=" "
              )= ticket.internal_notes || ''
              label.floating-label(for="internal_notes") Internal Notes (Agent/Admin only)

          //- Action buttons
          .flex.items-center.justify-between.pt-6.border-t.border-gray-200.dark_border-neutral-700
            div
              if isAdmin()
                button.px-4.py-2.bg-red-600.text-white.rounded-lg.hover_bg-red-700.transition-colors(
                  type="button"
                  onclick=`openModal('Delete Ticket', 'This ticket will be permanently deleted. This action cannot be undone.', 'Delete', () => deleteTicket(${ticket.id}))`
                )
                  | Delete Ticket

            .flex.items-center.space-x-4
              a.px-6.py-2.border.border-gray-300.text-gray-700.rounded-lg.hover_bg-gray-50.transition-colors.dark_border-neutral-600.dark_text-neutral-300.dark_hover_bg-neutral-700(href=`/tickets/${ticket.id}`)
                | Cancel
              button.px-6.py-2.bg-blue-600.text-white.rounded-lg.hover_bg-blue-700.transition-colors(type="submit")
                | Update Ticket

block scripts
  style.
    .floating-input::placeholder {
      color: transparent;
    }

    /* Default label state - centered in input */
    .floating-label {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1rem;
      line-height: 1;
      color: #737373;
      font-weight: 500;
      transition: all 0.2s ease;
      pointer-events: none;
    }

    /* Label moves to top when input is focused or has value */
    .floating-input:focus ~ .floating-label,
    .floating-input:not(:placeholder-shown) ~ .floating-label,
    select.floating-input:valid ~ .floating-label.select-label,
    textarea.floating-input:not(:placeholder-shown) ~ .floating-label {
      top: 0.375rem;
      transform: translateY(0);
      font-size: 0.75rem;
    }

    /* Blue color when focused */
    .floating-input:focus ~ .floating-label {
      color: #2563eb;
    }

    /* Gray color when has value but not focused */
    .floating-input:not(:focus):not(:placeholder-shown) ~ .floating-label,
    select.floating-input:not(:focus):valid ~ .floating-label.select-label {
      color: #737373;
    }

    /* For textareas, adjust label position when it has content */
    textarea.floating-input {
      resize: vertical;
    }

  script.
    // Auto-resize textareas
    document.querySelectorAll('textarea').forEach(textarea => {
      textarea.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
      });

      // Initial resize
      textarea.style.height = 'auto';
      textarea.style.height = (textarea.scrollHeight) + 'px';
    });

    // Delete ticket function
    function deleteTicket(ticketId) {
      fetch(`/tickets/${ticketId}`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json'
        }
      })
      .then(response => {
        if (response.ok) {
          window.location.href = '/tickets';
        } else {
          alert('Failed to delete ticket');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while deleting the ticket');
      });
    }

    // Show/hide escalated_to based on escalation_level
    const escalationLevel = document.getElementById('escalation_level');
    const escalatedToDiv = document.getElementById('escalated_to_id')?.parentElement;

    if (escalationLevel && escalatedToDiv) {
      escalationLevel.addEventListener('change', function() {
        if (this.value > 0) {
          escalatedToDiv.style.display = 'block';
        } else {
          escalatedToDiv.style.display = 'none';
        }
      });
    }
