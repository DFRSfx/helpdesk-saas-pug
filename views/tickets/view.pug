extends ../layout/layout

block content
  .max-w-7xl.mx-auto
    //- Ticket header
    .bg-white.rounded-lg.shadow-sm.border.border-gray-200.p-6.mb-6.dark_bg-neutral-800.dark_border-neutral-700
      .flex.flex-col.sm_flex-row.sm_items-center.sm_justify-between.gap-3.sm_gap-4
        div
          .flex.items-center.space-x-3.mb-2
            h2.text-2xl.font-bold.text-gray-900.dark_text-white= ticket.subject
            - const statusColors = { open: 'bg-blue-100 text-blue-800 dark_bg-blue-900 dark_text-blue-200', in_progress: 'bg-yellow-100 text-yellow-800 dark_bg-yellow-900 dark_text-yellow-200', resolved: 'bg-green-100 text-green-800 dark_bg-green-900 dark_text-green-200', closed: 'bg-gray-100 text-gray-800 dark_bg-gray-700 dark_text-gray-200' }
            span.px-3.py-1.text-sm.font-semibold.rounded-full(class=statusColors[ticket.status] aria-label=`Status: ${ticket.status.replace('_', ' ')}`)
              = ticket.status.replace('_', ' ').toUpperCase()

          .flex.items-center.space-x-4.text-sm.text-gray-600
            span.flex.items-center
              svg.w-4.h-4.mr-1(fill="none" stroke="currentColor" viewBox="0 0 24 24")
                path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z")
              | Ticket ##{ticket.id}

            span.flex.items-center
              svg.w-4.h-4.mr-1(fill="none" stroke="currentColor" viewBox="0 0 24 24")
                path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z")
              = 'Created ' + timeAgo(ticket.created_at)

            if ticket.updated_at && ticket.updated_at !== ticket.created_at
              span.flex.items-center
                svg.w-4.h-4.mr-1(fill="none" stroke="currentColor" viewBox="0 0 24 24")
                  path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15")
                = 'Updated ' + timeAgo(ticket.updated_at)

        .flex.items-center.gap-3
          a.inline-flex.items-center.px-4.py-2.text-sm.font-medium.text-gray-700.bg-white.border.border-gray-300.rounded-lg.shadow-sm.hover_bg-gray-50.hover_border-gray-400.hover_shadow-md.focus_outline-none.focus_ring-2.focus_ring-offset-2.focus_ring-gray-400.active_bg-gray-100.transition-all.duration-200.dark_bg-neutral-700.dark_text-neutral-200.dark_border-neutral-600.dark_hover_bg-neutral-600.dark_focus_ring-gray-500.dark_focus_ring-offset-neutral-900(href="/tickets" title="Back to Tickets")
            svg.w-4.h-4.mr-2(fill="none" stroke="currentColor" viewBox="0 0 24 24")
              path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7")
            | Back

          if isAdmin() || isAgent() || (isCustomer() && ticket.customer_id === currentUser.id && ticket.status !== 'closed')
            a.inline-flex.items-center.px-4.py-2.text-sm.font-medium.bg-blue-600.text-white.rounded-lg.shadow-md.hover_bg-blue-700.hover_shadow-lg.focus_outline-none.focus_ring-2.focus_ring-offset-2.focus_ring-blue-500.active_bg-blue-800.transition-all.duration-200.dark_bg-blue-700.dark_hover_bg-blue-600.dark_focus_ring-blue-400.dark_focus_ring-offset-neutral-900(href=`/tickets/${ticket.id}/edit` title="Edit Ticket")
              svg.w-4.h-4.mr-2(fill="none" stroke="currentColor" viewBox="0 0 24 24")
                path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z")
              | Edit

    .grid.grid-cols-1.md_grid-cols-3.gap-6
      //- Main content (right on desktop)
      .md_col-span-2.order-2.md_order-1.space-y-6
        //- Ticket details
        .bg-white.rounded-lg.shadow-sm.border.border-gray-200.p-6.dark_bg-neutral-800.dark_border-neutral-700
          h3.text-lg.font-semibold.text-gray-900.dark_text-white.mb-4 Description
          .prose.max-w-none.text-gray-700.dark_text-neutral-300#ticket-description
            = ticket.description

        //- Attachments
        if attachments && attachments.length > 0
          .bg-white.rounded-lg.shadow-sm.border.border-gray-200.p-6.dark_bg-neutral-800.dark_border-neutral-700
            h3.text-lg.font-semibold.text-gray-900.dark_text-white.mb-4 Attachments (#{attachments.length})
            .grid.grid-cols-1.md_grid-cols-2.gap-4
              each attachment in attachments
                .flex.items-center.justify-between.p-3.border.border-gray-200.rounded-lg.hover_bg-gray-50.transition-colors.dark_border-neutral-600
                  .flex.items-center.space-x-3
                    - const isImage = /\.(jpg|jpeg|png|gif|svg)$/i.test(attachment.filename)
                    if isImage
                      svg.w-8.h-8.text-blue-600.dark_text-blue-400(fill="none" stroke="currentColor" viewBox="0 0 24 24")
                        path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z")
                    else
                      svg.w-8.h-8.text-gray-600.dark_text-neutral-400(fill="none" stroke="currentColor" viewBox="0 0 24 24")
                        path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z")

                    div
                      .text-sm.font-medium.text-gray-900.dark_text-white= attachment.filename
                      .text-xs.text-gray-500.dark_text-neutral-400= (attachment.file_size / 1024).toFixed(2) + ' KB'

                  a.text-blue-600.hover_text-blue-800.dark_text-blue-400.dark_hover_text-blue-300.transition-colors.focus_outline-none.focus_ring-2.focus_ring-offset-2.focus_ring-blue-500.dark_focus_ring-blue-400.dark_focus_ring-offset-neutral-900.rounded(href=attachment.file_path download=attachment.filename title=`Download ${attachment.filename}`)
                    svg.w-5.h-5(fill="none" stroke="currentColor" viewBox="0 0 24 24")
                      path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4")
        else
          .bg-white.rounded-lg.shadow-sm.border.border-gray-200.p-6.dark_bg-neutral-800.dark_border-neutral-700
            .text-center.py-8
              svg.mx-auto.h-12.w-12.text-gray-400.dark_text-neutral-500.mb-4(fill="none" stroke="currentColor" viewBox="0 0 24 24")
                path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z")
              p.text-gray-600.dark_text-neutral-400.font-medium No attachments yet
              p.text-gray-500.dark_text-neutral-500.text-sm.mt-1 Upload files to attach them to this ticket

        //- Messages/Responses
        .bg-white.rounded-lg.shadow-sm.border.border-gray-200.p-6.dark_bg-neutral-800.dark_border-neutral-700
          .flex.items-center.justify-between.mb-4
            h3.text-lg.font-semibold.text-gray-900.dark_text-white Conversation
            if messages && messages.length > 0
              .text-xs.font-medium.text-gray-600.dark_text-neutral-400
                span#message-count= messages.length
                | &nbsp;
                span= messages.length === 1 ? 'message' : 'messages'

          if messages && messages.length > 0
            #messages-container.space-y-4
              - const messagesPerPage = 5
              - const totalMessages = messages.length
              - const totalPages = Math.ceil(totalMessages / messagesPerPage)

              each message in messages
                .border-l-4.px-4.py-4.rounded-r.transition-all.duration-200.message-item.hover_shadow-sm(
                  role="article"
                  aria-label=`${message.user_name || 'Unknown'} - ${message.is_internal ? 'Internal Note' : 'Message'} - ${formatDate(message.created_at)}`
                  data-message-index=messages.indexOf(message)
                  class=message.is_internal ? 'border-yellow-500 bg-yellow-50 dark_border-yellow-600 hover_bg-yellow-100' : 'border-blue-500 bg-blue-50 dark_border-blue-600 hover_bg-blue-100'
                )
                  .flex.items-start.justify-between.mb-3
                    .flex.items-center.space-x-3.flex-1
                      - const bgColors = { agent: 'bg-blue-600', admin: 'bg-purple-600', customer: 'bg-green-600', system: 'bg-gray-600' }
                      - const userRole = message.user_role || 'system'
                      .w-10.h-10.rounded-full(class=bgColors[userRole] || 'bg-blue-600').text-white.flex.items-center.justify-center.font-semibold.text-sm.flex-shrink-0
                        = message.user_name ? message.user_name.charAt(0).toUpperCase() : '?'
                      div.flex-1.min-w-0
                        .flex.items-center.gap-2
                          .font-semibold.text-gray-900.dark_text-white= message.user_name || 'Unknown'
                          if message.is_internal
                            span.px-2.py-0_5.text-xs.font-semibold.bg-yellow-200.text-yellow-800.dark_bg-yellow-600.dark_text-yellow-100.rounded Internal Note
                        .text-xs.text-gray-500.dark_text-neutral-400.mt-1(title=formatDate(message.created_at))= timeAgo(message.created_at)

                    .text-xs.text-gray-400.dark_text-neutral-500.flex-shrink-0
                      = formatDate(message.created_at)

                  .mt-4.text-gray-700.dark_text-neutral-300.max-w-none.text-sm.message-content(data-message-id=message.id)
                    if message.message
                      = message.message
                    else
                      em.text-gray-500.dark_text-neutral-400 (No content)

            if totalPages > 1
              .mt-6.pt-6.border-t.border-gray-200.dark_border-neutral-700
                .flex.items-center.justify-between
                  .text-xs.text-gray-600.dark_text-neutral-400.font-medium
                    span#pagination-info Page 1 of #{totalPages}

                  .flex.items-center.gap-2
                    button#prev-page.inline-flex.items-center.px-3.py-1.text-sm.font-medium.text-gray-700.bg-white.border.border-gray-300.rounded-lg.hover_bg-gray-50.focus_outline-none.focus_ring-2.focus_ring-offset-2.focus_ring-blue-500.disabled_opacity-50.disabled_cursor-not-allowed.transition-all.duration-200.dark_bg-neutral-700.dark_text-neutral-300.dark_border-neutral-600.dark_hover_bg-neutral-600.dark_focus_ring-blue-400(
                      type="button"
                      disabled
                      aria-label="Previous page"
                    )
                      svg.w-4.h-4.mr-1(fill="none" stroke="currentColor" viewBox="0 0 24 24")
                        path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7")
                      | Previous

                    .flex.items-center.gap-1
                      - for (let i = 1; i <= totalPages; i++)
                        button.page-button.inline-flex.items-center.justify-center.w-8.h-8.text-sm.font-medium.rounded-lg.transition-all.duration-200(
                          type="button"
                          data-page=i
                          class=i === 1 ? 'bg-blue-600 text-white shadow-sm' : 'text-gray-700 bg-white border border-gray-300 hover_bg-gray-50 dark_bg-neutral-700 dark_text-neutral-300 dark_border-neutral-600 dark_hover_bg-neutral-600'
                          aria-label=`Page ${i}`
                        )
                          = i

                    button#next-page.inline-flex.items-center.px-3.py-1.text-sm.font-medium.text-gray-700.bg-white.border.border-gray-300.rounded-lg.hover_bg-gray-50.focus_outline-none.focus_ring-2.focus_ring-offset-2.focus_ring-blue-500.disabled_opacity-50.disabled_cursor-not-allowed.transition-all.duration-200.dark_bg-neutral-700.dark_text-neutral-300.dark_border-neutral-600.dark_hover_bg-neutral-600.dark_focus_ring-blue-400(
                      type="button"
                      aria-label="Next page"
                    )
                      | Next
                      svg.w-4.h-4.ml-1(fill="none" stroke="currentColor" viewBox="0 0 24 24")
                        path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7")
          else
            .text-center.py-12
              svg.mx-auto.h-12.w-12.text-gray-400.dark_text-neutral-500.mb-4(fill="none" stroke="currentColor" viewBox="0 0 24 24")
                path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z")
              p.text-gray-600.dark_text-neutral-400.font-medium No messages yet
              p.text-gray-500.dark_text-neutral-500.text-sm.mt-1 Be the first to start the conversation

          //- Add message form
          if ticket.status !== 'closed'
            .mt-6.pt-6.border-t.border-gray-200.dark_border-neutral-700
              form(action=`/tickets/${ticket.id}/messages` method="POST" enctype="multipart/form-data" novalidate)
                .space-y-4
                  div
                    .flex.items-center.gap-2.mb-2
                      label.block.text-sm.font-medium.text-gray-700.dark_text-neutral-300(for="message") Add Response
                      span.text-xs.text-red-600.dark_text-red-400.font-semibold * Required
                    textarea#message.w-full.px-4.py-2.border.border-gray-300.rounded-lg.bg-white.text-gray-900.placeholder-gray-500.focus_outline-none.focus_ring-2.focus_ring-offset-2.focus_ring-blue-500.transition-all.duration-200.dark_bg-neutral-700.dark_border-neutral-600.dark_text-white.dark_placeholder-neutral-400.dark_focus_ring-blue-400.invalid_border-red-500.invalid_bg-red-50.dark_invalid_border-red-400.dark_invalid_bg-red-900(
                      name="message"
                      rows="4"
                      required
                      placeholder="Type your message here... (Supports Markdown)"
                      aria-label="Message content"
                      aria-required="true"
                    )
                    p.text-xs.text-gray-500.dark_text-neutral-400.mt-1 Supports Markdown formatting

                  if isAdmin() || isAgent()
                    .flex.items-center.space-x-2.p-3.bg-yellow-50.rounded-lg.border.border-yellow-200.dark_border-yellow-700(style="background-color: rgba(120, 113, 78, 0.1);")
                      input#is_internal.w-4.h-4.border.border-gray-300.rounded.text-yellow-600.focus_ring-2.focus_ring-offset-2.focus_ring-yellow-500.cursor-pointer.dark_bg-neutral-700.dark_border-neutral-600.dark_accent-yellow-600(
                        type="checkbox"
                        name="is_internal"
                        value="true"
                        aria-label="Mark as internal note"
                      )
                      label.text-sm.text-gray-700.dark_text-neutral-300.cursor-pointer(for="is_internal")
                        span.font-semibold Internal Note
                        |  — Only visible to agents and admins

                  div
                    label.block.text-sm.font-medium.text-gray-700.dark_text-neutral-300.mb-2(for="message_attachments")
                      | Attachments
                      span.text-xs.text-gray-500.dark_text-neutral-400 (Optional)
                    input#message_attachments.w-full.px-4.py-2.border.border-gray-300.rounded-lg.bg-white.text-gray-900.focus_outline-none.focus_ring-2.focus_ring-offset-2.focus_ring-blue-500.transition-all.duration-200.file_py-2.file_px-4.file_border-0.file_text-sm.file_font-semibold.file_bg-blue-50.file_text-blue-700.hover_file_bg-blue-100.dark_bg-neutral-700.dark_border-neutral-600.dark_text-white.dark_focus_ring-blue-400.dark_file_bg-neutral-600.dark_file_text-blue-400(
                      type="file"
                      name="attachments"
                      multiple
                      accept="image/*,.pdf,.doc,.docx,.txt,.zip"
                      aria-label="Upload attachments"
                    )
                    p.text-xs.text-gray-500.dark_text-neutral-400.mt-1 Supported: images, PDF, Word, text, ZIP

                  .flex.items-center.justify-between.pt-2
                    p.text-xs.text-gray-500.dark_text-neutral-400
                      span &#9679;
                      | Keyboard shortcut:
                      kbd.px-2.py-1.text-xs.font-semibold.text-gray-700.dark_text-neutral-300.bg-gray-100.dark_bg-neutral-700.rounded.ml-1 Ctrl+Enter

                    .flex.justify-end.gap-2
                      button.inline-flex.items-center.px-6.py-2.bg-blue-600.text-white.rounded-lg.shadow-sm.hover_bg-blue-700.hover_shadow-md.focus_outline-none.focus_ring-2.focus_ring-offset-2.focus_ring-blue-500.active_bg-blue-800.transition-all.duration-200.dark_focus_ring-blue-400.dark_focus_ring-offset-neutral-900.disabled_opacity-50.disabled_cursor-not-allowed(
                        type="submit"
                        title="Send your message (Ctrl+Enter)"
                      )
                        svg.w-5.h-5.mr-2(fill="none" stroke="currentColor" viewBox="0 0 24 24")
                          path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2m0 0v-8m0 8l-6-4m6 4l6-4")
                        | Send Message

      //- Sidebar (left on desktop)
      .order-1.md_order-2.space-y-6
        aside.bg-white.rounded-lg.shadow-sm.border.border-gray-200.p-6.dark_bg-neutral-800.dark_border-neutral-700
          h3.text-lg.font-semibold.text-gray-900.dark_text-white.mb-4 Ticket Information

          .flex.justify-between.items-start
            .border-r.border-gray-200.dark_border-neutral-700.pr-12.flex-1
              .text-xs.font-semibold.text-gray-600.dark_text-neutral-400.uppercase.tracking-widest.mb-2 Priority
              - const priorityColors = { low: 'bg-gray-100 text-gray-800 dark_bg-gray-700 dark_text-gray-200', medium: 'bg-blue-100 text-blue-800 dark_bg-blue-700 dark_text-blue-200', high: 'bg-orange-100 text-orange-800 dark_bg-orange-700 dark_text-orange-200', urgent: 'bg-red-100 text-red-800 dark_bg-red-700 dark_text-red-200' }
              span.inline-block.px-3.py-1.text-sm.font-semibold.rounded-full(class=priorityColors[ticket.priority])
                = ticket.priority.toUpperCase()

            .border-r.border-gray-200.dark_border-neutral-700.pr-12.flex-1
              .text-xs.font-semibold.text-gray-600.dark_text-neutral-400.uppercase.tracking-widest.mb-2 Department
              .text-sm.font-medium.text-gray-900.dark_text-white= ticket.department_name || 'N/A'

            .border-r.border-gray-200.dark_border-neutral-700.pr-12.flex-1
              .text-xs.font-semibold.text-gray-600.dark_text-neutral-400.uppercase.tracking-widest.mb-2 Customer
              .text-sm.font-medium.text-gray-900.dark_text-white= ticket.customer_name || 'N/A'
              if ticket.customer_email
                .text-xs.text-gray-500.dark_text-neutral-400.mt-1(title=ticket.customer_email)= ticket.customer_email

            if isAdmin() || isAgent()
              .flex-1
                .text-xs.font-semibold.text-gray-600.dark_text-neutral-400.uppercase.tracking-widest.mb-2 Assigned Agent
                if ticket.assigned_agent_name
                  .text-sm.font-medium.text-gray-900.dark_text-white= ticket.assigned_agent_name
                else
                  .text-sm.text-gray-500.dark_text-neutral-400.italic Unassigned

        //- Response Time Info
        .bg-gradient-to-br.from-indigo-50.to-indigo-100.rounded-lg.border.border-indigo-200.p-6
          h3.text-lg.font-semibold.text-gray-900.dark_text-white.mb-4 Response Metrics
          .flex.justify-between.items-start
            .border-r.border-indigo-300.pr-12.flex-1
              .text-xs.font-semibold.text-indigo-600.dark_text-indigo-400.uppercase.tracking-wide Total Responses
              .font-medium.text-gray-900.dark_text-white.mt-2
                = messages ? messages.length : 0
                span.text-xs.text-gray-500.dark_text-neutral-400.ml-2 messages

            if messages && messages.length > 0
              .border-r.border-indigo-300.pr-12.flex-1
                .text-xs.font-semibold.text-indigo-600.dark_text-indigo-400.uppercase.tracking-wide First Response
                .font-medium.text-gray-900.dark_text-white.mt-2(title=formatDate(messages[0].created_at))
                  = timeAgo(messages[0].created_at)

            .flex-1
              .text-xs.font-semibold.text-indigo-600.dark_text-indigo-400.uppercase.tracking-wide Current Status
              .flex.items-center.gap-2.mt-2
                .font-medium.text-gray-900.dark_text-white= ticket.status.replace('_', ' ').toUpperCase()

        //- Ticket Stats
        aside.bg-white.rounded-lg.shadow-sm.border.border-gray-200.p-6.dark_bg-neutral-800.dark_border-neutral-700
          h3.text-lg.font-semibold.text-gray-900.dark_text-white.mb-4 Ticket Stats

          .flex.justify-between.items-start
            .border-r.border-gray-200.dark_border-neutral-700.pr-12.flex-1
              .text-xs.font-semibold.text-gray-600.dark_text-neutral-400.uppercase.tracking-widest.mb-2 Responses
              .font-medium.text-gray-900.dark_text-white.mt-2
                = messages ? messages.length : 0
                span.text-xs.text-gray-500.dark_text-neutral-400.ml-2 messages

            .border-r.border-gray-200.dark_border-neutral-700.pr-12.flex-1
              .text-xs.font-semibold.text-gray-600.dark_text-neutral-400.uppercase.tracking-widest.mb-2 Attachments
              .font-medium.text-gray-900.dark_text-white.mt-2
                = attachments ? attachments.length : 0
                span.text-xs.text-gray-500.dark_text-neutral-400.ml-2 files

            .border-r.border-gray-200.dark_border-neutral-700.pr-12.flex-1
              .text-xs.font-semibold.text-gray-600.dark_text-neutral-400.uppercase.tracking-widest.mb-2 Open Time
              .font-medium.text-gray-900.dark_text-white.mt-2(title=formatDate(ticket.created_at))
                = timeAgo(ticket.created_at)

            if ticket.resolved_at
              .flex-1
                .text-xs.font-semibold.text-gray-600.dark_text-neutral-400.uppercase.tracking-widest.mb-2 Resolved
                .font-medium.text-gray-900.dark_text-white.mt-2(title=formatDate(ticket.resolved_at))
                  = timeAgo(ticket.resolved_at)

        //- Audit log / Timeline
        if isAdmin() || isAgent()
          if auditLogs && auditLogs.length > 0
            .bg-white.rounded-lg.shadow-sm.border.border-gray-200.p-6.dark_bg-neutral-800.dark_border-neutral-700
              h3.text-lg.font-semibold.text-gray-900.dark_text-white.mb-4 Activity Timeline

              .space-y-3.max-h-96.overflow-y-auto.pr-2
                each log in auditLogs
                  .flex.items-start.space-x-3.p-3.rounded.bg-gray-50.border.border-gray-200.dark_border-neutral-600.transition-colors.hover_bg-gray-100
                    .w-8.h-8.rounded-full.bg-blue-100.flex.items-center.justify-center.flex-shrink-0
                      svg.w-4.h-4.text-blue-600.dark_text-blue-400(fill="none" stroke="currentColor" viewBox="0 0 24 24")
                        path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z")
                    div.flex-1.min-w-0
                      .text-sm.font-medium.text-gray-900.dark_text-white= formatAuditAction(log)
                      .text-xs.text-gray-500.dark_text-neutral-400.mt-1(title=formatDate(log.created_at))
                        span= log.user_name || 'System'
                        span.mx-1 •
                        span= timeAgo(log.created_at)

block scripts
  script.
    // Render markdown in ticket description only
    if (typeof marked !== 'undefined') {
      // Render ticket description
      const descElement = document.getElementById('ticket-description');
      if (descElement) {
        const rawText = descElement.textContent;
        descElement.innerHTML = marked.parse(rawText);
      }
    }

    // Message content is already rendered server-side, no markdown processing needed

    // Auto-resize textarea
    const textarea = document.getElementById('message');
    if (textarea) {
      textarea.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
      });
    }

    // Message pagination
    const messagesPerPage = 5;
    const messageItems = document.querySelectorAll('.message-item');
    const pageButtons = document.querySelectorAll('.page-button');
    const prevBtn = document.getElementById('prev-page');
    const nextBtn = document.getElementById('next-page');
    const paginationInfo = document.getElementById('pagination-info');
    let currentPage = 1;
    const totalPages = Math.ceil(messageItems.length / messagesPerPage);

    function showPage(page) {
      const startIndex = (page - 1) * messagesPerPage;
      const endIndex = startIndex + messagesPerPage;

      messageItems.forEach((item, index) => {
        item.style.display = index >= startIndex && index < endIndex ? 'block' : 'none';
      });

      currentPage = page;

      // Update button states
      prevBtn.disabled = page === 1;
      nextBtn.disabled = page === totalPages;

      // Update pagination info
      if (paginationInfo) {
        paginationInfo.textContent = `Page ${page} of ${totalPages}`;
      }

      // Update active page button
      pageButtons.forEach(btn => {
        const btnPage = parseInt(btn.getAttribute('data-page'));
        if (btnPage === page) {
          btn.className = 'page-button inline-flex items-center justify-center w-8 h-8 text-sm font-medium rounded-lg transition-all duration-200 bg-blue-600 text-white shadow-sm';
        } else {
          btn.className = 'page-button inline-flex items-center justify-center w-8 h-8 text-sm font-medium rounded-lg transition-all duration-200 text-gray-700 bg-white border border-gray-300 hover_bg-gray-50 dark_bg-neutral-700 dark_text-neutral-300 dark_border-neutral-600 dark_hover_bg-neutral-600';
        }
      });

      // Scroll to top of messages
      document.getElementById('messages-container')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // Event listeners for pagination buttons
    if (prevBtn && nextBtn) {
      prevBtn.addEventListener('click', () => {
        if (currentPage > 1) showPage(currentPage - 1);
      });

      nextBtn.addEventListener('click', () => {
        if (currentPage < totalPages) showPage(currentPage + 1);
      });

      pageButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const page = parseInt(btn.getAttribute('data-page'));
          showPage(page);
        });
      });
    }

    // Initialize pagination on page load (always show first page to ensure messages are visible)
    if (messageItems.length > 0) {
      showPage(1);
    }
