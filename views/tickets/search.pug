extends ../layout/layout

block content
  .max-w-7xl.mx-auto.py-6.px-4

    //- Page Header
    .mb-8
      h1.text-4xl.font-bold.text-gray-900.dark_text-white Advanced Ticket Search
      p.text-gray-600.dark_text-neutral-400.mt-2 Find tickets using powerful filters and advanced search capabilities

    //- Search Panel
    .bg-white.dark_bg-neutral-800.rounded-lg.shadow-sm.border.border-gray-200.dark_border-neutral-700.p-6.mb-6

      //- Search Bar
      .mb-6
        label.block.text-sm.font-medium.text-gray-700.dark_text-neutral-300.mb-3(for="searchInput")
          | Search by Title, ID, or Description
        input#searchInput.w-full.px-4.py-3.bg-gray-50.dark_bg-neutral-700.text-gray-900.dark_text-white.placeholder-gray-500.dark_placeholder-neutral-400.border.border-gray-300.dark_border-neutral-600.rounded-lg.focus_outline-none.focus_ring-2.focus_ring-blue-500(
          type="text"
          placeholder="Search tickets... (e.g., #123, bug, error)"
          autocomplete="off"
        )
        .mt-2.space-y-1#suggestions.hidden
          //- Suggestions will be populated here

      //- Filter Row 1: Status, Priority, Department
      .grid.grid-cols-1.md_grid-cols-3.gap-4.mb-4

        .form-group
          label.block.text-sm.font-medium.text-gray-700.dark_text-neutral-300.mb-2(for="statusFilter")
            | Status
          select#statusFilter.w-full.px-4.py-2.bg-gray-50.dark_bg-neutral-700.text-gray-900.dark_text-white.border.border-gray-300.dark_border-neutral-600.rounded-lg.focus_outline-none.focus_ring-2.focus_ring-blue-500
            option(value="all") All Statuses
            each status in statuses
              option(value=status)= status

        .form-group
          label.block.text-sm.font-medium.text-gray-700.dark_text-neutral-300.mb-2(for="priorityFilter")
            | Priority
          select#priorityFilter.w-full.px-4.py-2.bg-gray-50.dark_bg-neutral-700.text-gray-900.dark_text-white.border.border-gray-300.dark_border-neutral-600.rounded-lg.focus_outline-none.focus_ring-2.focus_ring-blue-500
            option(value="all") All Priorities
            each priority in priorities
              option(value=priority)= priority

        .form-group
          label.block.text-sm.font-medium.text-gray-700.dark_text-neutral-300.mb-2(for="departmentFilter")
            | Department
          select#departmentFilter.w-full.px-4.py-2.bg-gray-50.dark_bg-neutral-700.text-gray-900.dark_text-white.border.border-gray-300.dark_border-neutral-600.rounded-lg.focus_outline-none.focus_ring-2.focus_ring-blue-500
            option(value="all") All Departments
            each dept in departments
              option(value=dept.id)= dept.name

      //- Filter Row 2: Agent, SLA Status, Date Range
      .grid.grid-cols-1.md_grid-cols-3.gap-4.mb-6

        .form-group
          label.block.text-sm.font-medium.text-gray-700.dark_text-neutral-300.mb-2(for="agentFilter")
            | Assigned Agent
          select#agentFilter.w-full.px-4.py-2.bg-gray-50.dark_bg-neutral-700.text-gray-900.dark_text-white.border.border-gray-300.dark_border-neutral-600.rounded-lg.focus_outline-none.focus_ring-2.focus_ring-blue-500
            option(value="all") All Agents
            each agent in agents
              option(value=agent.id)= agent.name

        .form-group
          label.block.text-sm.font-medium.text-gray-700.dark_text-neutral-300.mb-2(for="slaStatusFilter")
            | SLA Status
          select#slaStatusFilter.w-full.px-4.py-2.bg-gray-50.dark_bg-neutral-700.text-gray-900.dark_text-white.border.border-gray-300.dark_border-neutral-600.rounded-lg.focus_outline-none.focus_ring-2.focus_ring-blue-500
            option(value="all") All SLA Statuses
            option(value="compliant") Compliant
            option(value="at_risk") At Risk
            option(value="breached") Breached

        .form-group
          label.block.text-sm.font-medium.text-gray-700.dark_text-neutral-300.mb-2(for="dateRangePicker")
            | Date Range
          .flex.gap-2.items-end
            .flex-1
              label.text-xs.text-gray-500.dark_text-neutral-400.block.mb-1 From
              input#dateFrom.w-full.px-4.py-2.bg-gray-50.dark_bg-neutral-700.text-gray-900.dark_text-white.border.border-gray-300.dark_border-neutral-600.rounded-lg.focus_outline-none.focus_ring-2.focus_ring-blue-500(
                type="date"
              )
            .flex-1
              label.text-xs.text-gray-500.dark_text-neutral-400.block.mb-1 To
              input#dateTo.w-full.px-4.py-2.bg-gray-50.dark_bg-neutral-700.text-gray-900.dark_text-white.border.border-gray-300.dark_border-neutral-600.rounded-lg.focus_outline-none.focus_ring-2.focus_ring-blue-500(
                type="date"
              )

      //- Sorting & Action Buttons
      .flex.flex-col.md_flex-row.gap-4.justify-between.items-start.md_items-end

        .form-group.flex-1
          label.block.text-sm.font-medium.text-gray-700.dark_text-neutral-300.mb-2(for="sortBy")
            | Sort By
          .flex.gap-2
            select#sortBy.flex-1.px-4.py-2.bg-gray-50.dark_bg-neutral-700.text-gray-900.dark_text-white.border.border-gray-300.dark_border-neutral-600.rounded-lg.focus_outline-none.focus_ring-2.focus_ring-blue-500
              option(value="created_at") Created Date
              option(value="updated_at") Last Updated
              option(value="priority") Priority
              option(value="status") Status
            select#sortOrder.w-24.px-4.py-2.bg-gray-50.dark_bg-neutral-700.text-gray-900.dark_text-white.border.border-gray-300.dark_border-neutral-600.rounded-lg.focus_outline-none.focus_ring-2.focus_ring-blue-500
              option(value="DESC") Descending
              option(value="ASC") Ascending

        .flex.gap-3
          button#searchBtn.px-6.py-2.bg-blue-600.text-white.rounded-lg.hover_bg-blue-700.focus_outline-none.focus_ring-2.focus_ring-blue-500.font-medium.transition-colors(type="button")
            svg.w-5.h-5.inline.mr-2(fill="none" stroke="currentColor" viewBox="0 0 24 24")
              path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z")
            | Search

          button#resetBtn.px-6.py-2.bg-gray-300.dark_bg-neutral-700.text-gray-900.dark_text-white.rounded-lg.hover_bg-gray-400.dark_hover_bg-neutral-600.focus_outline-none.focus_ring-2.focus_ring-gray-500.font-medium.transition-colors(type="button")
            svg.w-5.h-5.inline.mr-2(fill="none" stroke="currentColor" viewBox="0 0 24 24")
              path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15")
            | Reset

          button#exportBtn.px-6.py-2.bg-green-600.text-white.rounded-lg.hover_bg-green-700.focus_outline-none.focus_ring-2.focus_ring-green-500.font-medium.transition-colors(type="button")
            svg.w-5.h-5.inline.mr-2(fill="none" stroke="currentColor" viewBox="0 0 24 24")
              path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4")
            | Export

    //- Results Section
    .bg-white.dark_bg-neutral-800.rounded-lg.shadow-sm.border.border-gray-200.dark_border-neutral-700.overflow-hidden

      //- Results Header
      .p-6.border-b.border-gray-200.dark_border-neutral-700
        .flex.items-center.justify-between
          h2.text-lg.font-semibold.text-gray-900.dark_text-white
            | Search Results
            span#resultCount.text-gray-500.dark_text-neutral-400.ml-2 (0)
          #loadingSpinner.hidden
            svg.animate-spin.h-5.w-5.text-blue-600(fill="none" viewBox="0 0 24 24")
              circle.opacity-25(cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4")
              path.opacity-75(fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z")

      //- Results Table
      .overflow-x-auto
        table.w-full.text-sm
          thead
            tr.bg-gray-50.dark_bg-neutral-700/50.border-b.border-gray-200.dark_border-neutral-700
              th.px-6.py-3.text-left.font-semibold.text-gray-700.dark_text-neutral-300 ID
              th.px-6.py-3.text-left.font-semibold.text-gray-700.dark_text-neutral-300 Title
              th.px-6.py-3.text-left.font-semibold.text-gray-700.dark_text-neutral-300 Customer
              th.px-6.py-3.text-left.font-semibold.text-gray-700.dark_text-neutral-300 Agent
              th.px-6.py-3.text-center.font-semibold.text-gray-700.dark_text-neutral-300 Status
              th.px-6.py-3.text-center.font-semibold.text-gray-700.dark_text-neutral-300 Priority
              th.px-6.py-3.text-center.font-semibold.text-gray-700.dark_text-neutral-300 SLA
              th.px-6.py-3.text-left.font-semibold.text-gray-700.dark_text-neutral-300 Created

          tbody#resultsBody
            tr
              td.px-6.py-4.text-center.text-gray-500.dark_text-neutral-400(colspan="8")
                | Run a search to see results

      //- Pagination
      .p-6.border-t.border-gray-200.dark_border-neutral-700#paginationContainer.hidden
        .flex.items-center.justify-between
          .text-sm.text-gray-600.dark_text-neutral-400
            | Showing
            span#pageInfo
            | results

          .flex.gap-2
            button#prevPageBtn.px-4.py-2.bg-gray-100.dark_bg-neutral-700.text-gray-900.dark_text-white.rounded-lg.hover_bg-gray-200.dark_hover_bg-neutral-600.disabled_opacity-50.disabled_cursor-not-allowed.transition-colors(type="button")
              | Previous
            span#pageNumbers.flex.gap-2

            button#nextPageBtn.px-4.py-2.bg-gray-100.dark_bg-neutral-700.text-gray-900.dark_text-white.rounded-lg.hover_bg-gray-200.dark_hover_bg-neutral-600.disabled_opacity-50.disabled_cursor-not-allowed.transition-colors(type="button")
              | Next

  //- Advanced Search JavaScript
  script.
    let currentPage = 1;
    let resultsPerPage = 20;
    let currentFilters = {};

    // Get search suggestions
    async function getSuggestions(query) {
      if (query.length < 2) {
        document.getElementById('suggestions').classList.add('hidden');
        return;
      }

      try {
        const response = await fetch(`/search/api/suggestions?q=${encodeURIComponent(query)}`);
        const data = await response.json();

        if (data.suggestions && data.suggestions.length > 0) {
          const suggestionsDiv = document.getElementById('suggestions');
          suggestionsDiv.innerHTML = data.suggestions.map(s =>
            `<div class="px-4 py-2 hover:bg-gray-100 dark:hover:bg-neutral-700 cursor-pointer text-sm" onclick="selectSuggestion('${s.value}')">
              <span class="text-gray-600 dark:text-neutral-400">${s.type}:</span> ${s.label}
            </div>`
          ).join('');
          suggestionsDiv.classList.remove('hidden');
        } else {
          document.getElementById('suggestions').classList.add('hidden');
        }
      } catch (error) {
        console.error('Error getting suggestions:', error);
      }
    }

    function selectSuggestion(value) {
      document.getElementById('searchInput').value = value;
      document.getElementById('suggestions').classList.add('hidden');
    }

    // Search functionality
    async function performSearch() {
      const searchInput = document.getElementById('searchInput').value;
      const status = document.getElementById('statusFilter').value;
      const priority = document.getElementById('priorityFilter').value;
      const department_id = document.getElementById('departmentFilter').value;
      const agent_id = document.getElementById('agentFilter').value;
      const sla_status = document.getElementById('slaStatusFilter').value;
      const date_from = document.getElementById('dateFrom').value;
      const date_to = document.getElementById('dateTo').value;
      const sort_by = document.getElementById('sortBy').value;
      const sort_order = document.getElementById('sortOrder').value;

      currentFilters = {
        search: searchInput,
        status,
        priority,
        department_id,
        agent_id,
        sla_status,
        date_from,
        date_to,
        sort_by,
        sort_order
      };

      currentPage = 1;
      await loadResults();
    }

    async function loadResults(page = 1) {
      const spinner = document.getElementById('loadingSpinner');
      spinner.classList.remove('hidden');

      try {
        const params = new URLSearchParams({
          ...currentFilters,
          page,
          per_page: resultsPerPage
        });

        const response = await fetch(`/search/api/tickets?${params}`);
        const data = await response.json();

        if (data.success) {
          displayResults(data.tickets);
          displayPagination(data.pagination);
          document.getElementById('resultCount').textContent = `(${data.pagination.total_results})`;
        }
      } catch (error) {
        console.error('Error loading results:', error);
        document.getElementById('resultsBody').innerHTML =
          '<tr><td colspan="8" class="px-6 py-4 text-center text-red-500">Error loading results</td></tr>';
      } finally {
        spinner.classList.add('hidden');
      }
    }

    function displayResults(tickets) {
      const tbody = document.getElementById('resultsBody');

      if (tickets.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="px-6 py-4 text-center text-gray-500 dark:text-neutral-400">No tickets found</td></tr>';
        return;
      }

      tbody.innerHTML = tickets.map(ticket => {
        const priorityColors = {
          'Low': 'bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300',
          'Medium': 'bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-300',
          'High': 'bg-orange-100 dark:bg-orange-900/30 text-orange-800 dark:text-orange-300',
          'Critical': 'bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300'
        };

        const statusColors = {
          'Open': 'bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-300',
          'In Progress': 'bg-purple-100 dark:bg-purple-900/30 text-purple-800 dark:text-purple-300',
          'Waiting': 'bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-300',
          'Resolved': 'bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300',
          'Closed': 'bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-300',
          'Escalated': 'bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300'
        };

        let slaStatus = '✓ OK';
        let slaClass = 'text-green-600 dark:text-green-400';
        if (ticket.sla_response_breached || ticket.sla_resolution_breached) {
          slaStatus = '✗ Breached';
          slaClass = 'text-red-600 dark:text-red-400';
        } else if (ticket.sla_response_due) {
          const due = new Date(ticket.sla_response_due);
          const now = new Date();
          const pctRemaining = ((due - now) / (due - new Date(ticket.created_at))) * 100;
          if (pctRemaining < 20) {
            slaStatus = '⚠ At Risk';
            slaClass = 'text-orange-600 dark:text-orange-400';
          }
        }

        return `
          <tr class="border-b border-gray-200 dark:border-neutral-700 hover:bg-gray-50 dark:hover:bg-neutral-700/50 transition-colors">
            <td class="px-6 py-4 text-blue-600 dark:text-blue-400 font-medium">
              <a href="/tickets/${ticket.id}">#${ticket.id}</a>
            </td>
            <td class="px-6 py-4 text-gray-900 dark:text-white font-medium max-w-xs truncate">
              <a href="/tickets/${ticket.id}" class="hover:underline">${ticket.title}</a>
            </td>
            <td class="px-6 py-4 text-gray-700 dark:text-neutral-300">${ticket.customer_name || 'N/A'}</td>
            <td class="px-6 py-4 text-gray-700 dark:text-neutral-300">${ticket.agent_name || 'Unassigned'}</td>
            <td class="px-6 py-4 text-center">
              <span class="px-3 py-1 ${statusColors[ticket.status]} rounded-full text-xs font-semibold">${ticket.status}</span>
            </td>
            <td class="px-6 py-4 text-center">
              <span class="px-3 py-1 ${priorityColors[ticket.priority]} rounded-full text-xs font-semibold">${ticket.priority}</span>
            </td>
            <td class="px-6 py-4 text-center">
              <span class="${slaClass} font-semibold text-sm">${slaStatus}</span>
            </td>
            <td class="px-6 py-4 text-gray-600 dark:text-neutral-400 text-xs">
              ${new Date(ticket.created_at).toLocaleDateString()}
            </td>
          </tr>
        `;
      }).join('');
    }

    function displayPagination(pagination) {
      if (pagination.total_pages <= 1) {
        document.getElementById('paginationContainer').classList.add('hidden');
        return;
      }

      document.getElementById('paginationContainer').classList.remove('hidden');
      document.getElementById('pageInfo').textContent =
        `${(currentPage - 1) * resultsPerPage + 1}-${Math.min(currentPage * resultsPerPage, pagination.total_results)} of ${pagination.total_results}`;

      document.getElementById('prevPageBtn').disabled = currentPage === 1;
      document.getElementById('nextPageBtn').disabled = currentPage === pagination.total_pages;

      const pageNumbers = document.getElementById('pageNumbers');
      pageNumbers.innerHTML = '';

      for (let i = 1; i <= pagination.total_pages; i++) {
        if (i === 1 || i === pagination.total_pages || (i >= currentPage - 1 && i <= currentPage + 1)) {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.textContent = i;
          btn.className = i === currentPage
            ? 'px-3 py-1 bg-blue-600 text-white rounded-lg font-medium'
            : 'px-3 py-1 bg-gray-100 dark:bg-neutral-700 text-gray-900 dark:text-white rounded-lg hover:bg-gray-200 dark:hover:bg-neutral-600';
          btn.onclick = () => {
            currentPage = i;
            loadResults(i);
          };
          pageNumbers.appendChild(btn);
        } else if (i === 2 || i === pagination.total_pages - 1) {
          const span = document.createElement('span');
          span.textContent = '...';
          span.className = 'px-2 py-1 text-gray-500';
          pageNumbers.appendChild(span);
        }
      }
    }

    // Event Listeners
    document.getElementById('searchInput').addEventListener('input', (e) => {
      getSuggestions(e.target.value);
    });

    document.getElementById('searchBtn').addEventListener('click', performSearch);
    document.getElementById('resetBtn').addEventListener('click', () => {
      document.getElementById('searchInput').value = '';
      document.getElementById('statusFilter').value = 'all';
      document.getElementById('priorityFilter').value = 'all';
      document.getElementById('departmentFilter').value = 'all';
      document.getElementById('agentFilter').value = 'all';
      document.getElementById('slaStatusFilter').value = 'all';
      document.getElementById('dateFrom').value = '';
      document.getElementById('dateTo').value = '';
      document.getElementById('sortBy').value = 'created_at';
      document.getElementById('sortOrder').value = 'DESC';
      document.getElementById('resultsBody').innerHTML =
        '<tr><td colspan="8" class="px-6 py-4 text-center text-gray-500 dark:text-neutral-400">Run a search to see results</td></tr>';
      document.getElementById('paginationContainer').classList.add('hidden');
    });

    document.getElementById('exportBtn').addEventListener('click', async () => {
      const params = new URLSearchParams(currentFilters);
      window.location.href = `/search/api/export?${params}`;
    });

    document.getElementById('prevPageBtn').addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage--;
        loadResults(currentPage);
      }
    });

    document.getElementById('nextPageBtn').addEventListener('click', () => {
      currentPage++;
      loadResults(currentPage);
    });
