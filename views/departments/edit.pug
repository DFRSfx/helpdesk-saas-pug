extends ../layout/layout

block content
  .max-w-3xl.mx-auto
    .bg-white.rounded-lg.shadow-sm.border.border-gray-200.p-6
      h2.text-2xl.font-bold.text-gray-900.mb-6 Edit Department

      form(action=`/departments/${department.id}` method="POST")
        input(type="hidden" name="_method" value="PUT")

        .space-y-6
          //- Name
          div
            label.block.text-sm.font-medium.text-gray-700.mb-2(for="name")
              | Department Name
              span.text-red-500 *
            input#name.w-full.px-4.py-2.border.border-gray-300.rounded-lg.focus_outline-none.focus_ring-2.focus_ring-blue-500(
              type="text"
              name="name"
              value=department.name
              required
            )

          //- Description
          div
            label.block.text-sm.font-medium.text-gray-700.mb-2(for="description")
              | Description
              span.text-gray-500.text-xs.font-normal (Optional)
            textarea#description.w-full.px-4.py-2.border.border-gray-300.rounded-lg.focus_outline-none.focus_ring-2.focus_ring-blue-500(
              name="description"
              rows="4"
            )= department.description || ''

          //- Status
          div
            label.flex.items-center
              input#is_active.mr-2(type="checkbox" name="is_active" value="true" checked=department.is_active)
              span.text-sm.text-gray-700 Active (Department can receive tickets)

          //- Assign agents
          div
            label.block.text-sm.font-medium.text-gray-700.mb-2
              | Assign Agents
              span.text-gray-500.text-xs.font-normal (Optional)
            if agents && agents.length > 0
              .space-y-2.max-h-60.overflow-y-auto.border.border-gray-300.rounded-lg.p-4
                each agent in agents
                  - const isAssigned = assignedAgents && assignedAgents.some(a => a.id === agent.id)
                  label.flex.items-center.p-2.hover_bg-gray-50.rounded.cursor-pointer
                    input.mr-3(type="checkbox" name="agent_ids[]" value=agent.id checked=isAssigned)
                    .flex.items-center
                      .w-8.h-8.rounded-full.bg-blue-600.text-white.flex.items-center.justify-center.font-semibold.text-sm.mr-3
                        = agent.name.charAt(0).toUpperCase()
                      div
                        .text-sm.font-medium.text-gray-900= agent.name
                        .text-xs.text-gray-500= agent.email
            else
              .text-sm.text-gray-500.italic No agents available

          //- Statistics
          if stats
            .border-t.border-gray-200.pt-6
              h3.text-lg.font-semibold.text-gray-900.mb-4 Department Statistics

              .grid.grid-cols-2.md_grid-cols-4.gap-4
                div.bg-gray-50.rounded-lg.p-4
                  .text-sm.text-gray-600 Total Tickets
                  .text-2xl.font-bold.text-gray-900= stats.totalTickets || 0

                div.bg-blue-50.rounded-lg.p-4
                  .text-sm.text-gray-600 Open Tickets
                  .text-2xl.font-bold.text-blue-600= stats.openTickets || 0

                div.bg-yellow-50.rounded-lg.p-4
                  .text-sm.text-gray-600 In Progress
                  .text-2xl.font-bold.text-yellow-600= stats.inProgressTickets || 0

                div.bg-green-50.rounded-lg.p-4
                  .text-sm.text-gray-600 Resolved
                  .text-2xl.font-bold.text-green-600= stats.resolvedTickets || 0

          //- Submit buttons
          .flex.items-center.justify-between.pt-6.border-t.border-gray-200
            button.px-4.py-2.bg-red-600.text-white.rounded-lg.hover_bg-red-700.transition-colors(
              type="button"
              onclick=`if(confirm('Are you sure you want to delete this department? This will affect all tickets in this department.')) { deleteDepartment(${department.id}); }`
            )
              | Delete Department

            .flex.items-center.space-x-4
              a.px-6.py-2.border.border-gray-300.text-gray-700.rounded-lg.hover_bg-gray-50.transition-colors(href="/departments")
                | Cancel
              button.px-6.py-2.bg-blue-600.text-white.rounded-lg.hover_bg-blue-700.transition-colors(type="submit")
                | Update Department

block scripts
  script.
    // Auto-resize textarea
    const textarea = document.getElementById('description');
    if (textarea) {
      textarea.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
      });

      // Initial resize
      textarea.style.height = 'auto';
      textarea.style.height = (textarea.scrollHeight) + 'px';
    }

    // Delete department function
    function deleteDepartment(deptId) {
      fetch(`/departments/${deptId}`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json'
        }
      })
      .then(response => {
        if (response.ok) {
          window.location.href = '/departments';
        } else {
          alert('Failed to delete department');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while deleting the department');
      });
    }
