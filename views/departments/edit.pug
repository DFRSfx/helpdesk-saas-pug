extends ../layout/layout

block content
  //- Include reusable confirmation modal
  include ../partials/modal

  .max-w-3xl.mx-auto
    .bg-white.rounded-lg.shadow-sm.border.border-gray-200.p-6.dark_bg-neutral-800.dark_border-neutral-700
      h2.text-2xl.font-bold.text-gray-900.mb-6.dark_text-neutral-200 Edit Department

      form(action=`/departments/${department.id}/edit` method="POST")

        .space-y-6
          //- Name
          .relative
            input#name.floating-input(
              class="w-full px-4 pt-6 pb-2 border-2 border-gray-300 rounded-sm bg-white text-gray-900 transition-all duration-200 outline-none focus:border-blue-600 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-200 dark:focus:border-blue-500"
              type="text"
              name="name"
              value=department.name
              required
              placeholder=" "
            )
            label.floating-label(for="name") Department Name

          //- Description
          .relative
            textarea#description.floating-input(
              class="w-full px-4 pt-6 pb-2 border-2 border-gray-300 rounded-sm bg-white text-gray-900 transition-all duration-200 outline-none focus:border-blue-600 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-200 dark:focus:border-blue-500"
              name="description"
              rows="4"
              placeholder=" "
            )= department.description || ''
            label.floating-label(for="description") Description (Optional)

          //- Status
          div
            label.flex.items-center
              input#is_active.mr-2(type="checkbox" name="is_active" value="true" checked=department.is_active)
              span.text-sm.text-gray-700.dark_text-neutral-300 Active (Department can receive tickets)

          //- Assign agents
          div
            label.block.text-sm.font-medium.text-gray-700.mb-2.dark_text-neutral-300
              | Assign Agents
              span.text-gray-500.text-xs.font-normal (Optional)
            if agents && agents.length > 0
              //- Search bar
              .mb-3
                .relative
                  input#agentSearch.w-full.px-4.py-2.pl-10.border.border-gray-300.rounded-lg.focus_border-blue-500.focus_ring-2.focus_ring-blue-200.transition-all.outline-none(
                    type="text"
                    placeholder="Search agents by name or email..."
                  )
                  svg.absolute.left-3.w-4.h-4.text-gray-400(fill="none" stroke="currentColor" viewBox="0 0 24 24" style="top: 50%; transform: translateY(-50%);")
                    path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z")
              
              //- Agent list
              #agentList.space-y-2.max-h-60.overflow-y-auto.border.border-gray-300.rounded-lg.p-4.dark_border-neutral-600.dark_bg-neutral-900
                each agent in agents
                  - const isAssigned = assignedAgents && assignedAgents.some(a => parseInt(a.id) === parseInt(agent.id))
                  label.agent-item.flex.items-center.p-2.hover_bg-gray-50.rounded.cursor-pointer.dark_hover_bg-neutral-700(
                    data-name=agent.name.toLowerCase()
                    data-email=agent.email.toLowerCase()
                  )
                    input.mr-3(type="checkbox" name="agent_ids[]" value=agent.id checked=isAssigned)
                    .flex.items-center
                      .w-8.h-8.rounded-full.bg-blue-600.text-white.flex.items-center.justify-center.font-semibold.text-sm.mr-3
                        = agent.name.charAt(0).toUpperCase()
                      div
                        .text-sm.font-medium.text-gray-900.dark_text-neutral-200= agent.name
                        .text-xs.text-gray-500.dark_text-neutral-400= agent.email
              
              //- No results message
              #noResults.hidden.text-sm.text-gray-500.italic.text-center.py-4 No agents found
            else
              .text-sm.text-gray-500.italic.dark_text-neutral-400 No agents available

          //- Statistics
          if stats
            .border-t.border-gray-200.pt-6.dark_border-neutral-700
              h3.text-lg.font-semibold.text-gray-900.mb-4.dark_text-neutral-200 Department Statistics

              .grid.grid-cols-2.md_grid-cols-4.gap-4
                div.bg-gray-50.rounded-lg.p-4.dark_bg-neutral-900
                  .text-sm.text-gray-600.dark_text-neutral-400 Total Tickets
                  .text-2xl.font-bold.text-gray-900.dark_text-neutral-200= stats.totalTickets || 0

                div.bg-blue-50.rounded-lg.p-4.dark_bg-blue-900
                  .text-sm.text-gray-600.dark_text-blue-300 Open Tickets
                  .text-2xl.font-bold.text-blue-600.dark_text-blue-400= stats.openTickets || 0

                div.bg-yellow-50.rounded-lg.p-4.dark_bg-yellow-900
                  .text-sm.text-gray-600.dark_text-yellow-300 In Progress
                  .text-2xl.font-bold.text-yellow-600.dark_text-yellow-400= stats.inProgressTickets || 0

                div.bg-green-50.rounded-lg.p-4.dark_bg-green-900
                  .text-sm.text-gray-600.dark_text-green-300 Resolved
                  .text-2xl.font-bold.text-green-600.dark_text-green-400= stats.resolvedTickets || 0

          //- Submit buttons
          .flex.items-center.justify-between.pt-6.border-t.border-gray-200.dark_border-neutral-700
            button.px-4.py-2.bg-red-600.text-white.rounded-lg.hover_bg-red-700.transition-colors(
              type="button"
              onclick=`openModal('Delete Department', 'This department will be permanently deleted. This will affect all tickets in this department.', 'Delete', () => deleteDepartment(${department.id}))`
            )
              | Delete Department

            .flex.items-center.space-x-4
              a.px-6.py-2.border.border-gray-300.text-gray-700.rounded-lg.hover_bg-gray-50.transition-colors.dark_border-neutral-600.dark_text-neutral-300.dark_hover_bg-neutral-700(href="/departments")
                | Cancel
              button.px-6.py-2.bg-blue-600.text-white.rounded-lg.hover_bg-blue-700.transition-colors(type="submit")
                | Update Department

block scripts
  style.
    .floating-input::placeholder {
      color: transparent;
    }

    /* Default label state - centered in input */
    .floating-label {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1rem;
      line-height: 1;
      color: #737373;
      font-weight: 500;
      transition: all 0.2s ease;
      pointer-events: none;
    }

    /* Label moves to top when input is focused or has value */
    .floating-input:focus ~ .floating-label,
    .floating-input:not(:placeholder-shown) ~ .floating-label,
    textarea.floating-input:not(:placeholder-shown) ~ .floating-label {
      top: 0.375rem;
      transform: translateY(0);
      font-size: 0.75rem;
    }

    /* Blue color when focused */
    .floating-input:focus ~ .floating-label {
      color: #2563eb;
    }

    /* Gray color when has value but not focused */
    .floating-input:not(:focus):not(:placeholder-shown) ~ .floating-label {
      color: #737373;
    }

    /* For textareas, adjust label position when it has content */
    textarea.floating-input {
      resize: vertical;
    }

  script.
    // Auto-resize textarea
    const textarea = document.getElementById('description');
    if (textarea) {
      textarea.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
      });

      // Initial resize
      textarea.style.height = 'auto';
      textarea.style.height = (textarea.scrollHeight) + 'px';
    }

    // Agent search functionality
    const agentSearch = document.getElementById('agentSearch');
    const agentList = document.getElementById('agentList');
    const noResults = document.getElementById('noResults');
    
    if (agentSearch && agentList) {
      agentSearch.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase().trim();
        const agentItems = agentList.querySelectorAll('.agent-item');
        let visibleCount = 0;
        
        agentItems.forEach(item => {
          const name = item.getAttribute('data-name');
          const email = item.getAttribute('data-email');
          
          if (searchTerm === '' || name.includes(searchTerm) || email.includes(searchTerm)) {
            item.style.display = 'flex';
            visibleCount++;
          } else {
            item.style.display = 'none';
          }
        });
        
        // Show/hide no results message
        if (visibleCount === 0 && searchTerm !== '') {
          noResults.classList.remove('hidden');
        } else {
          noResults.classList.add('hidden');
        }
      });
      
      // Clear button handler (optional - using keyboard shortcut or button if added)
      agentSearch.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          this.value = '';
          this.dispatchEvent(new Event('input'));
          this.focus();
        }
      });
    }

    // Delete department function
    function deleteDepartment(deptId) {
      fetch(`/departments/${deptId}/delete`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        }
      })
      .then(response => {
        if (response.ok) {
          window.location.href = '/departments';
        } else {
          alert('Failed to delete department');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while deleting the department');
      });
    }
