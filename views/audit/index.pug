extends ../layout/layout

block content
  .max-w-7xl.mx-auto
    //- Header
    .bg-white.rounded-lg.shadow-sm.border.border-gray-200.p-6.mb-6
      .flex.items-center.justify-between.mb-4
        div
          h2.text-xl.font-bold.text-gray-900 Audit Logs
          p.text-sm.text-gray-600 Track all system activities and user actions

        button#filterToggle.flex.items-center.space-x-2.px-4.py-2.bg-gray-100.text-gray-700.rounded-lg.hover_bg-gray-200.transition-colors(type="button")
          svg.w-5.h-5(fill="none" stroke="currentColor" viewBox="0 0 24 24")
            path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z")
          span Filters

      //- Filters (hidden by default)
      #filterSection(style="max-height: 0; opacity: 0; overflow: hidden; transition: max-height 0.4s ease-in-out, opacity 0.4s ease-in-out;")
        .mt-4.pt-4.border-t.border-gray-200.bg-gray-50.rounded-lg.p-4
          form(method="GET" action="/audit")
            .grid.grid-cols-1.md_grid-cols-2.lg_grid-cols-4.gap-4.mb-3
              //- Search
              .lg_col-span-2
                label.block.text-sm.font-semibold.text-gray-700.mb-2 Search
                .relative
                  .absolute.left-3.pointer-events-none(style="top: 0.9rem;")
                    svg.w-4.h-4.text-gray-500(fill="none" stroke="currentColor" viewBox="0 0 24 24")
                      path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z")
                  input.w-full.pl-10.pr-4.py-3.text-sm.bg-white.border.border-gray-300.rounded-md.shadow-sm.focus_outline-none.focus_ring-2.focus_ring-blue-500.focus_border-blue-500(
                    type="text"
                    name="search"
                    placeholder="Search actions, users..."
                    value=search || ""
                  )

              //- Date from
              div
                label.block.text-sm.font-semibold.text-gray-700.mb-2 From Date
                input.w-full.px-3.py-3.text-sm.bg-white.border.border-gray-300.rounded-md.shadow-sm.focus_outline-none.focus_ring-2.focus_ring-blue-500.focus_border-blue-500(
                  type="date"
                  name="date_from"
                  value=date_from || ""
                )

              //- Date to
              div
                label.block.text-sm.font-semibold.text-gray-700.mb-2 To Date
                input.w-full.px-3.py-3.text-sm.bg-white.border.border-gray-300.rounded-md.shadow-sm.focus_outline-none.focus_ring-2.focus_ring-blue-500.focus_border-blue-500(
                  type="date"
                  name="date_to"
                  value=date_to || ""
                )

            //- Buttons row
            .flex.items-center.justify-between.mt-1
              .text-sm.text-gray-600
                | Filter your audit logs by search, user, or date range
              .flex.items-center.space-x-3
                a.inline-flex.items-center.px-4.py-2.text-sm.font-medium.border-2.border-gray-300.text-gray-700.bg-white.rounded-lg.shadow-sm.hover_bg-gray-50.hover_border-gray-400.focus_outline-none.focus_ring-2.focus_ring-offset-2.focus_ring-gray-400.transition-all.duration-200(href="/audit")
                  svg.w-4.h-4.mr-2(fill="none" stroke="currentColor" viewBox="0 0 24 24")
                    path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12")
                  | Clear
                button.inline-flex.items-center.px-4.py-2.text-sm.font-medium.bg-gradient-to-r.from-blue-600.to-blue-700.text-white.rounded-lg.shadow-md.hover_from-blue-700.hover_to-blue-800.hover_shadow-lg.focus_outline-none.focus_ring-2.focus_ring-offset-2.focus_ring-blue-500.transition-all.duration-200.transform.hover_scale-105(type="submit")
                  svg.w-4.h-4.mr-2(fill="none" stroke="currentColor" viewBox="0 0 24 24")
                    path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z")
                  | Apply Filters

    //- Stats
    div(style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;")
      .bg-white.rounded-lg.shadow-sm.border.border-gray-200.p-6
        .flex.items-center.justify-between
          div
            p.text-sm.text-gray-600 Total Logs
            p.text-2xl.font-bold.text-gray-900= stats.total || 0
          .w-10.h-10.bg-gray-100.rounded-lg.flex.items-center.justify-center
            svg.w-6.h-6.text-gray-600(fill="none" stroke="currentColor" viewBox="0 0 24 24")
              path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z")

      .bg-white.rounded-lg.shadow-sm.border.border-gray-200.p-6
        .flex.items-center.justify-between
          div
            p.text-sm.text-gray-600 Today
            p.text-2xl.font-bold.text-blue-600= stats.today || 0
          .w-10.h-10.bg-blue-100.rounded-lg.flex.items-center.justify-center
            svg.w-6.h-6.text-blue-600(fill="none" stroke="currentColor" viewBox="0 0 24 24")
              path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z")

      .bg-white.rounded-lg.shadow-sm.border.border-gray-200.p-6
        .flex.items-center.justify-between
          div
            p.text-sm.text-gray-600 This Week
            p.text-2xl.font-bold.text-green-600= stats.thisWeek || 0
          .w-10.h-10.bg-green-100.rounded-lg.flex.items-center.justify-center
            svg.w-6.h-6.text-green-600(fill="none" stroke="currentColor" viewBox="0 0 24 24")
              path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z")

      .bg-white.rounded-lg.shadow-sm.border.border-gray-200.p-6
        .flex.items-center.justify-between
          div
            p.text-sm.text-gray-600 Active Users
            p.text-2xl.font-bold.text-purple-600= stats.activeUsers || 0
          .w-10.h-10.bg-purple-100.rounded-lg.flex.items-center.justify-center
            svg.w-6.h-6.text-purple-600(fill="none" stroke="currentColor" viewBox="0 0 24 24")
              path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z")

    //- Audit logs table
    .bg-white.rounded-lg.shadow-sm.border.border-gray-200.overflow-hidden
      if logs && logs.length > 0
        .overflow-x-auto
          table.min-w-full.divide-y.divide-gray-200
            thead.bg-gray-50
              tr
                th.px-6.py-3.text-left.text-xs.font-medium.text-gray-500.uppercase.tracking-wider Action
                th.px-6.py-3.text-left.text-xs.font-medium.text-gray-500.uppercase.tracking-wider User
                th.px-6.py-3.text-left.text-xs.font-medium.text-gray-500.uppercase.tracking-wider Ticket
                th.px-6.py-3.text-left.text-xs.font-medium.text-gray-500.uppercase.tracking-wider Time

            tbody.bg-white.divide-y.divide-gray-200
              each log in logs
                - const iconConfig = { ticket_created: { bg: 'bg-green-100', color: 'text-green-600', path: 'M12 4v16m8-8H4' }, status_changed: { bg: 'bg-blue-100', color: 'text-blue-600', path: 'M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15' }, priority_changed: { bg: 'bg-orange-100', color: 'text-orange-600', path: 'M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z' }, agent_assigned: { bg: 'bg-purple-100', color: 'text-purple-600', path: 'M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z' }, agent_unassigned: { bg: 'bg-gray-100', color: 'text-gray-600', path: 'M13 7a4 4 0 11-8 0 4 4 0 018 0zM9 14a7 7 0 00-7 7h14a7 7 0 00-7-7z' }, message_added: { bg: 'bg-indigo-100', color: 'text-indigo-600', path: 'M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z' }, attachment_added: { bg: 'bg-yellow-100', color: 'text-yellow-600', path: 'M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13' }, department_changed: { bg: 'bg-teal-100', color: 'text-teal-600', path: 'M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4' }, ticket_updated: { bg: 'bg-blue-100', color: 'text-blue-600', path: 'M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z' } }
                - const config = iconConfig[log.action] || { bg: 'bg-gray-100', color: 'text-gray-600', path: 'M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z' }
                tr.hover_bg-gray-50.transition-colors
                  td.px-6.py-4
                    .flex.items-center.space-x-3
                      .w-10.h-10.rounded-lg.flex.items-center.justify-center.flex-shrink-0(class=config.bg)
                        svg.w-5.h-5(class=config.color fill="none" stroke="currentColor" viewBox="0 0 24 24")
                          path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d=config.path)
                      div.max-w-md
                        .text-sm.font-medium.text-gray-900= formatAuditAction(log)

                  td.px-6.py-4.whitespace-nowrap
                    .flex.items-center.space-x-2
                      .w-8.h-8.rounded-full.bg-gradient-to-br.from-blue-500.to-blue-600.text-white.flex.items-center.justify-center.font-semibold.text-xs
                        = log.user_name ? log.user_name.charAt(0).toUpperCase() : 'S'
                      div
                        .text-sm.font-medium.text-gray-900= log.user_name || 'System'
                        if log.user_role
                          .text-xs.text-gray-500.capitalize= log.user_role

                  td.px-6.py-4.whitespace-nowrap
                    if log.ticket_id
                      a.text-sm.text-blue-600.hover_text-blue-800.font-medium(href=`/tickets/${log.ticket_id}`)
                        = '#' + log.ticket_id
                        if log.ticket_title
                          .text-xs.text-gray-500.truncate.max-w-xs(title=log.ticket_title)= log.ticket_title
                    else
                      .text-sm.text-gray-400 -

                  td.px-6.py-4.whitespace-nowrap
                    .text-sm.text-gray-900= formatDate(log.created_at)
                    .text-xs.text-gray-500= timeAgo(log.created_at)
      else
        .p-8.text-center
          svg.mx-auto.h-12.w-12.text-gray-400(fill="none" stroke="currentColor" viewBox="0 0 24 24")
            path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z")
          p.mt-2.text-sm.text-gray-500 No audit logs found

    //- Pagination
    if pagination && pagination.totalPages > 1
      .mt-6.flex.items-center.justify-between.bg-white.px-6.py-3.rounded-lg.shadow-sm.border.border-gray-200
        .flex.items-center
          p.text-sm.text-gray-700
            | Showing
            span.font-medium= ' ' + pagination.startItem + ' '
            | to
            span.font-medium= ' ' + pagination.endItem + ' '
            | of
            span.font-medium= ' ' + pagination.totalItems + ' '
            | results

        .flex.items-center.space-x-2
          if pagination.currentPage > 1
            a.px-3.py-2.text-sm.font-medium.text-gray-700.bg-white.border.border-gray-300.rounded-lg.hover_bg-gray-50(
              href=`?page=${pagination.currentPage - 1}${search ? '&search=' + search : ''}${entity_type ? '&entity_type=' + entity_type : ''}${user_id ? '&user_id=' + user_id : ''}${date_from ? '&date_from=' + date_from : ''}${date_to ? '&date_to=' + date_to : ''}`
            ) Previous
          else
            span.px-3.py-2.text-sm.font-medium.text-gray-400.bg-gray-100.border.border-gray-300.rounded-lg.cursor-not-allowed Previous

          .flex.items-center.space-x-1
            - let startPage = Math.max(1, pagination.currentPage - 2)
            - let endPage = Math.min(pagination.totalPages, pagination.currentPage + 2)

            if startPage > 1
              a.px-3.py-2.text-sm.font-medium.text-gray-700.bg-white.border.border-gray-300.rounded-lg.hover_bg-gray-50(
                href=`?page=1${search ? '&search=' + search : ''}${entity_type ? '&entity_type=' + entity_type : ''}${user_id ? '&user_id=' + user_id : ''}${date_from ? '&date_from=' + date_from : ''}${date_to ? '&date_to=' + date_to : ''}`
              ) 1
              if startPage > 2
                span.px-3.py-2.text-sm.text-gray-700 ...

            - for (let i = startPage; i <= endPage; i++)
              if i === pagination.currentPage
                span.px-3.py-2.text-sm.font-medium.text-white.bg-blue-600.border.border-blue-600.rounded-lg= i
              else
                a.px-3.py-2.text-sm.font-medium.text-gray-700.bg-white.border.border-gray-300.rounded-lg.hover_bg-gray-50(
                  href=`?page=${i}${search ? '&search=' + search : ''}${entity_type ? '&entity_type=' + entity_type : ''}${user_id ? '&user_id=' + user_id : ''}${date_from ? '&date_from=' + date_from : ''}${date_to ? '&date_to=' + date_to : ''}`
                )= i

            if endPage < pagination.totalPages
              if endPage < pagination.totalPages - 1
                span.px-3.py-2.text-sm.text-gray-700 ...
              a.px-3.py-2.text-sm.font-medium.text-gray-700.bg-white.border.border-gray-300.rounded-lg.hover_bg-gray-50(
                href=`?page=${pagination.totalPages}${search ? '&search=' + search : ''}${entity_type ? '&entity_type=' + entity_type : ''}${user_id ? '&user_id=' + user_id : ''}${date_from ? '&date_from=' + date_from : ''}${date_to ? '&date_to=' + date_to : ''}`
              )= pagination.totalPages

          if pagination.currentPage < pagination.totalPages
            a.px-3.py-2.text-sm.font-medium.text-gray-700.bg-white.border.border-gray-300.rounded-lg.hover_bg-gray-50(
              href=`?page=${pagination.currentPage + 1}${search ? '&search=' + search : ''}${entity_type ? '&entity_type=' + entity_type : ''}${user_id ? '&user_id=' + user_id : ''}${date_from ? '&date_from=' + date_from : ''}${date_to ? '&date_to=' + date_to : ''}`
            ) Next
          else
            span.px-3.py-2.text-sm.font-medium.text-gray-400.bg-gray-100.border.border-gray-300.rounded-lg.cursor-not-allowed Next

block scripts
  script.
    // Filter toggle with smooth slide animation
    document.addEventListener('DOMContentLoaded', function() {
      const filterToggle = document.getElementById('filterToggle');
      const filterSection = document.getElementById('filterSection');

      if (filterToggle && filterSection) {
        // Check if there are active filters
        const urlParams = new URLSearchParams(window.location.search);
        const hasFilters = urlParams.has('search') || urlParams.has('user_id') || urlParams.has('date_from') || urlParams.has('date_to');

        // Helper function to update max-height
        function updateMaxHeight(isOpen) {
          if (isOpen) {
            const content = filterSection.querySelector('.mt-4');
            const height = content ? content.scrollHeight : 400;
            filterSection.style.maxHeight = (height + 32) + 'px';
            filterSection.style.opacity = '1';
          } else {
            filterSection.style.maxHeight = '0';
            filterSection.style.opacity = '0';
          }
        }

        // Show filters if there are active filters
        if (hasFilters) {
          updateMaxHeight(true);
        }

        filterToggle.addEventListener('click', function() {
          const isOpen = filterSection.style.maxHeight !== '0px' && filterSection.style.maxHeight !== '';
          updateMaxHeight(!isOpen);
        });

        // Handle window resize to adjust height
        window.addEventListener('resize', function() {
          const isOpen = filterSection.style.maxHeight !== '0px' && filterSection.style.maxHeight !== '';
          if (isOpen) {
            const content = filterSection.querySelector('.mt-4');
            const height = content ? content.scrollHeight : 400;
            filterSection.style.maxHeight = (height + 32) + 'px';
          }
        });
      }
    });
